<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Manager Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'walmart-blue': '#0071CE',
                        'walmart-dark-blue': '#004C91',
                        'walmart-light-blue': '#78B9E7',
                        'walmart-yellow': '#FFC220',
                        'walmart-green': '#00A342',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    padding: {
                        'safe': 'env(safe-area-inset-bottom)',
                    }
                },
            },
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .hidden-view { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 h-full">
    <!-- Top Header Bar -->
    <header class="fixed top-0 w-full bg-walmart-blue z-50 shadow-md">
        <div class="flex items-center justify-between px-4 h-14">
            <button id="menu-btn" class="text-white p-2">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 class="text-white text-lg font-semibold">Market Manager Tool</h1>
            <div class="flex items-center space-x-2">
                <button onclick="openFeedbackModal()" class="text-white p-2" title="Submit Feedback"><i class="fas fa-comment text-lg"></i></button>
                <button onclick="openMarketModal()" class="text-white p-2" title="Select Market">
                    <i class="fas fa-user text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Side Drawer -->
    <div id="drawer-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50" onclick="closeDrawer()"></div>
    <div id="drawer" class="fixed top-0 left-0 h-full w-64 bg-white z-50 transform -translate-x-full transition-transform duration-300">
        <div class="bg-walmart-blue px-4 py-6">
            <h2 class="text-white text-xl font-bold">Market Manager Tool</h2>
        </div>
        <nav class="p-4">
            <button onclick="switchTab('home'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-home w-6 text-walmart-blue"></i><span class="ml-3">Dashboard</span>
            </button>
            <button onclick="switchTab('log-visit'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-camera w-6 text-walmart-blue"></i><span class="ml-3">Log Visit</span>
            </button>
            <button onclick="switchTab('visits'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-clipboard-list w-6 text-walmart-blue"></i><span class="ml-3">Visit Tracker</span>
            </button>
            <button onclick="switchTab('prior-tours'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-history w-6 text-walmart-blue"></i><span class="ml-3">Prior Visits</span>
            </button>
            <button onclick="switchTab('gold-stars'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-star w-6 text-yellow-500"></i><span class="ml-3">Gold Star Notes</span>
            </button>
            <button onclick="switchTab('champions'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-trophy w-6 text-walmart-blue"></i><span class="ml-3">Champions</span>
            </button>
            <button onclick="switchTab('issues'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-clipboard-check w-6 text-walmart-blue"></i><span class="ml-3">Issues</span>
            </button>
            <hr class="my-4">
            <button onclick="switchTab('status'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-server w-6 text-walmart-blue"></i><span class="ml-3">Status</span>
            </button>
            <button class="w-full text-left px-4 py-3 text-gray-500 hover:bg-gray-100 rounded-lg flex items-center justify-between">
                <span>Settings</span><i class="fas fa-chevron-right text-sm"></i>
            </button>
        </nav>
    </div>

    <!-- Views Container -->
    <div id="main-content" class="h-full overflow-y-auto pt-14 pb-20">

        <!-- VIEW: HOME (Dashboard) -->
        <div id="view-home" class="p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Dashboard Summary</h2>
            </div>

            <!-- Metric Cards - 2x2 Grid -->
            <div class="grid grid-cols-2 gap-4" id="dashboard-cards">
                <!-- Red Stores Card -->
                <div class="bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterByRating('Red')">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-sm font-bold text-gray-900">Red Stores</h3>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </div>
                    <p id="red-stores-count" class="text-3xl font-bold text-red-600 mb-1">-</p>
                    <p class="text-xs text-gray-500">Immediate attention</p>
                </div>

                <!-- Yellow Stores Card -->
                <div class="bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterByRating('Yellow')">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-sm font-bold text-gray-900">Yellow Stores</h3>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </div>
                    <p id="yellow-stores-count" class="text-3xl font-bold text-yellow-500 mb-1">-</p>
                    <p class="text-xs text-gray-500">Needs review</p>
                </div>

                <!-- Green Stores Card -->
                <div class="bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterByRating('Green')">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-sm font-bold text-gray-900">Green Stores</h3>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </div>
                    <p id="green-stores-count" class="text-3xl font-bold text-green-600 mb-1">-</p>
                    <p class="text-xs text-gray-500">On track</p>
                </div>

                <!-- Outstanding Market Notes Card -->
                <div class="bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="switchTab('market-notes')">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-sm font-bold text-gray-900">Market Notes</h3>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </div>
                    <p id="market-notes-count" class="text-3xl font-bold text-walmart-blue mb-1">-</p>
                    <p class="text-xs text-gray-500">Outstanding items</p>
                </div>
            </div>
        </div>

        <!-- VIEW: LOG VISIT (Upload Form) -->
        <div id="view-log-visit" class="hidden-view flex flex-col items-center py-6 px-4">
            <div class="max-w-2xl w-full space-y-6 p-6 bg-white rounded-xl shadow-lg">
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-900">Log Store Visit</h2>
                    <p class="mt-2 text-sm text-gray-600">Upload a photo of your handwritten notes to automatically categorize them.</p>
                </div>

                <!-- File Upload Area -->
                <div class="space-y-4">
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-xl bg-gray-50">
                        <div class="space-y-3 text-center">
                            <button type="button" onclick="document.getElementById('camera-input').click()" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-walmart-blue hover:bg-walmart-dark-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-walmart-blue w-full justify-center">
                                <i class="fas fa-camera mr-2"></i> Take Photo
                            </button>
                            <input id="camera-input" type="file" accept="image/*" capture="environment" class="sr-only">

                            <div class="relative">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-gray-50 text-gray-500">Or</span>
                                </div>
                            </div>

                            <label for="image-upload" class="cursor-pointer text-walmart-blue hover:text-walmart-dark-blue font-medium">
                                <span>Upload from Gallery</span>
                                <input id="image-upload" type="file" class="sr-only" accept="image/*">
                            </label>
                            <p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
                        </div>
                    </div>

                    <!-- Preview Image -->
                    <div id="image-preview-container" class="hidden">
                        <p class="block text-sm font-medium text-gray-700">Preview:</p>
                        <img id="image-preview" src="" alt="Preview" class="mt-2 rounded-lg shadow-md max-h-48 w-auto mx-auto"/>
                    </div>

                    <button id="analyze-button" class="w-full py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-walmart-blue hover:bg-walmart-dark-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-walmart-blue disabled:bg-gray-400">
                        Analyze Notes
                    </button>
                </div>

                <!-- Loading Spinner -->
                <div id="loading-spinner" class="hidden text-center py-6">
                    <svg class="animate-spin h-10 w-10 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-3 text-sm text-gray-600">Analyzing with Gemini...</p>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="hidden p-4 bg-red-100 text-red-700 rounded-lg">
                    <p><strong>Error:</strong> <span id="error-text"></span></p>
                </div>

                <!-- Duplicate Warning Modal -->
                <div id="duplicate-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-96 shadow-lg rounded-xl bg-white">
                        <div class="mt-3">
                            <div class="flex items-center justify-center w-12 h-12 mx-auto bg-yellow-100 rounded-full">
                                <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 text-center mt-4">Potential Duplicate</h3>
                            <div class="mt-4 px-4 py-3 bg-yellow-50 rounded-lg">
                                <p class="text-sm text-gray-700 mb-2">An entry for this store and date already exists:</p>
                                <div id="duplicate-details" class="text-sm font-mono text-gray-800"></div>
                            </div>
                            <p class="text-sm text-gray-600 text-center mt-4">Submit this entry anyway?</p>
                            <div class="flex gap-4 mt-4">
                                <button id="duplicate-cancel-btn" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300">Cancel</button>
                                <button id="duplicate-submit-btn" class="flex-1 px-4 py-2 bg-walmart-blue text-white font-medium rounded-lg hover:bg-walmart-dark-blue">Submit Anyway</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-container" class="hidden space-y-4">
                    <h3 class="text-xl font-bold text-gray-900">Analysis Results</h3>

                    <!-- Store Rating -->
                    <div class="bg-white border-2 p-4 rounded-xl text-center">
                        <h4 class="text-sm font-semibold text-gray-600 mb-2">Store Rating</h4>
                        <div id="result-rating" class="inline-flex items-center justify-center px-6 py-2 text-xl font-bold rounded-full"></div>
                    </div>

                    <!-- Date and Store Number -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-walmart-blue">Tour Date</h4>
                            <p id="result-calendar-date" class="mt-1 text-lg font-bold text-gray-900"></p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-walmart-blue">Store Number</h4>
                            <p id="result-store-nbr" class="mt-1 text-lg font-bold text-gray-900"></p>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <h4 class="text-sm font-semibold text-gray-700">Store Notes</h4>
                        <p id="result-store-notes" class="mt-2 text-sm text-gray-700 whitespace-pre-wrap"></p>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-xl">
                        <h4 class="text-sm font-semibold text-purple-700">Market Notes</h4>
                        <p id="result-mkt-notes" class="mt-2 text-sm text-purple-700 whitespace-pre-wrap"></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-green-700">What's Good</h4>
                            <p id="result-good" class="mt-2 text-sm text-gray-700 whitespace-pre-wrap"></p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-yellow-700">Top 3 Opportunities</h4>
                            <p id="result-top-3" class="mt-2 text-sm text-gray-700 whitespace-pre-wrap"></p>
                        </div>
                    </div>

                    <!-- Metrics Section -->
                    <div id="result-metrics" class="space-y-3">
                        <!-- Sales Metrics -->
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-walmart-blue mb-3">ðŸ“Š Sales</h4>
                            <div class="grid grid-cols-3 gap-3 text-center">
                                <div>
                                    <p class="text-xs text-gray-500">Comp Y</p>
                                    <p id="metric-sales-comp-yest" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Comp WTD</p>
                                    <p id="metric-sales-comp-wtd" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Comp MTD</p>
                                    <p id="metric-sales-comp-mtd" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Index Y</p>
                                    <p id="metric-sales-index-yest" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Index WTD</p>
                                    <p id="metric-sales-index-wtd" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Index MTD</p>
                                    <p id="metric-sales-index-mtd" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                            </div>
                        </div>

                        <!-- Inventory Health Metrics -->
                        <div class="bg-green-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-green-700 mb-3">ðŸ“¦ Inventory Health</h4>
                            <div class="grid grid-cols-3 gap-3 text-center">
                                <div>
                                    <p class="text-xs text-gray-500">FTPR</p>
                                    <p id="metric-ftpr" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Presub</p>
                                    <p id="metric-presub" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">VizPick</p>
                                    <p id="metric-vizpick" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">VP Health</p>
                                    <p id="metric-vizpick-health" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Overstock</p>
                                    <p id="metric-overstock" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Picks</p>
                                    <p id="metric-picks" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Fashion</p>
                                    <p id="metric-fashion" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Topstock</p>
                                    <p id="metric-topstock-grocery" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Cases</p>
                                    <p id="metric-cases" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                            </div>
                        </div>

                        <!-- Basic Work Metrics -->
                        <div class="bg-orange-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-orange-700 mb-3">ðŸ”§ Basic Work</h4>
                            <div class="grid grid-cols-3 gap-3 text-center">
                                <div>
                                    <p class="text-xs text-gray-500">Modflex</p>
                                    <p id="metric-modflex" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Tag Errors</p>
                                    <p id="metric-tag-errors" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Mods</p>
                                    <p id="metric-mods" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">PCS</p>
                                    <p id="metric-pcs" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Pinpoint</p>
                                    <p id="metric-pinpoint" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Locations</p>
                                    <p id="metric-locations" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button id="reanalyze-button" onclick="reanalyzeNotes()" class="flex-1 py-3 px-4 border-2 border-walmart-blue text-walmart-blue text-sm font-medium rounded-lg hover:bg-walmart-blue hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-walmart-blue transition-colors">
                            <i class="fas fa-redo mr-2"></i>Re-Analyze
                        </button>
                        <button id="save-visit-button" onclick="manualSaveVisit()" class="flex-1 py-3 px-4 bg-walmart-blue text-white text-sm font-medium rounded-lg hover:bg-walmart-dark-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-walmart-blue transition-colors">
                            <i class="fas fa-save mr-2"></i>Save Visit
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: VISITS (Visit Tracker) -->
        <div id="view-visits" class="hidden-view p-4 bg-gray-100 min-h-full">
            <!-- Active Rating Filter Badge -->
            <div id="rating-filter-badge" class="hidden mb-3">
                <div class="inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium">
                    <span>Showing:</span>
                    <span id="rating-filter-label" class="px-2 py-1 rounded-full text-xs font-bold"></span>
                    <button onclick="clearRatingFilter()" class="ml-1 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>

            <!-- Store Summary - Last Visit per Store -->
            <div class="mb-4">
                <h3 class="text-sm font-semibold text-gray-600 uppercase mb-2">Store Status</h3>
                <div id="store-summary-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                    <div class="text-center text-gray-400 text-sm py-4 col-span-full">Loading...</div>
                </div>
            </div>

            <!-- Store Filter Dropdown -->
            <div class="mb-4">
                <button id="store-filter-btn" class="w-full bg-white px-4 py-3 rounded-lg shadow flex items-center justify-between">
                    <span id="store-filter-text" class="text-gray-900 font-medium">All Stores</span>
                    <i class="fas fa-chevron-down text-walmart-blue"></i>
                </button>
                <div id="store-filter-dropdown" class="hidden absolute left-4 right-4 mt-1 bg-white rounded-lg shadow-lg z-40 max-h-64 overflow-y-auto">
                    <!-- Options will be inserted by JS -->
                </div>
            </div>

            <!-- Table Header -->
            <div class="bg-white rounded-t-lg shadow-sm">
                <div class="grid grid-cols-12 gap-2 px-4 py-3 text-xs font-bold text-gray-600 uppercase border-b">
                    <div class="col-span-2 cursor-pointer flex items-center" onclick="sortVisits('store')">
                        Store# <i id="sort-store-icon" class="fas fa-sort ml-1 text-gray-400"></i>
                    </div>
                    <div class="col-span-2 cursor-pointer flex items-center" onclick="sortVisits('date')">
                        Date <i id="sort-date-icon" class="fas fa-sort ml-1 text-gray-400"></i>
                    </div>
                    <div class="col-span-2 cursor-pointer flex items-center" onclick="sortVisits('rating')">
                        Rating <i id="sort-rating-icon" class="fas fa-sort ml-1 text-gray-400"></i>
                    </div>
                    <div class="col-span-2 text-center">
                        Notes Received
                    </div>
                    <div class="col-span-4">Top 3 Notes</div>
                </div>
            </div>

            <!-- Table Body -->
            <div id="visits-table-body" class="bg-white rounded-b-lg shadow-sm divide-y divide-gray-100">
                <div class="p-8 text-center text-gray-500">Loading visits...</div>
            </div>
        </div>

        <!-- VIEW: PRIOR TOURS (Prior Visits) -->
        <div id="view-prior-tours" class="hidden-view p-4 bg-gray-100 min-h-full">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Prior Visits</h2>

            <!-- Search Section -->
            <div class="bg-white p-4 rounded-xl shadow-md mb-4">
                <label for="prior-store-nbr" class="block text-sm font-medium text-gray-700 mb-2">Enter Store Number</label>
                <div class="flex gap-2">
                    <input type="text" id="prior-store-nbr" placeholder="e.g. 1234" class="flex-1 rounded-lg border border-gray-300 px-4 py-2 text-gray-900 focus:border-walmart-blue focus:ring-walmart-blue">
                    <button id="btn-search-prior" class="bg-walmart-blue text-white px-6 py-2 rounded-lg hover:bg-walmart-dark-blue font-medium">
                        Get Prior Visit Summary
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="prior-results" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>
                    <p>Enter a store number to see the prior visit summary.</p>
                </div>
            </div>
        </div>

        <!-- VIEW: MARKET NOTES (To-Do List) -->
        <div id="view-market-notes" class="hidden-view p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Market Notes</h2>
                <span id="market-notes-progress" class="text-sm text-gray-500"></span>
            </div>

            <!-- Filter by Store -->
            <div class="mb-4">
                <button id="market-store-filter-btn" class="w-full bg-white px-4 py-3 rounded-lg shadow flex items-center justify-between">
                    <span id="market-store-filter-text" class="text-gray-900 font-medium">All Stores</span>
                    <i class="fas fa-chevron-down text-walmart-blue"></i>
                </button>
                <div id="market-store-filter-dropdown" class="hidden absolute left-4 right-4 mt-1 bg-white rounded-lg shadow-lg z-40 max-h-64 overflow-y-auto">
                    <!-- Options will be inserted by JS -->
                </div>
            </div>

            <!-- Market Notes List (Outstanding) -->
            <div id="market-notes-list" class="space-y-3">
                <div class="text-center py-8">
                    <svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-3 text-gray-500">Loading market notes...</p>
                </div>
            </div>

            <!-- Completed Section (Collapsible) -->
            <div id="completed-section" class="hidden mt-6">
                <button onclick="toggleCompletedSection()" class="w-full bg-gray-200 hover:bg-gray-300 rounded-lg px-4 py-3 flex items-center justify-between transition-colors">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span class="font-medium text-gray-700">Completed</span>
                        <span id="completed-count-badge" class="bg-green-100 text-green-700 text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <i id="completed-chevron" class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                </button>
                <div id="completed-notes-container" class="hidden mt-3 space-y-3">
                    <!-- Completed notes will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Market Note Detail Modal -->
        <div id="market-note-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center sm:justify-center">
            <div class="bg-white w-full sm:max-w-lg sm:rounded-xl rounded-t-2xl max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 flex justify-between items-center p-4 border-b border-gray-200 bg-white">
                    <h2 class="text-lg font-bold text-gray-900">Market Note Details</h2>
                    <button onclick="closeMarketNoteModal()" class="text-gray-400 hover:text-gray-600 p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="p-4 space-y-4">
                    <!-- Store & Date -->
                    <div class="flex justify-between items-center">
                        <span id="mkt-note-store" class="text-lg font-bold text-walmart-blue"></span>
                        <span id="mkt-note-date" class="text-sm text-gray-500"></span>
                    </div>

                    <!-- Note Text -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p id="mkt-note-text" class="text-gray-800"></p>
                    </div>

                    <!-- Status -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                        <div class="grid grid-cols-4 gap-2">
                            <button onclick="setMarketNoteStatus('new')" class="mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors" data-status="new">
                                New
                            </button>
                            <button onclick="setMarketNoteStatus('in_progress')" class="mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors" data-status="in_progress">
                                In Progress
                            </button>
                            <button onclick="setMarketNoteStatus('on_hold')" class="mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors" data-status="on_hold">
                                On Hold
                            </button>
                            <button onclick="setMarketNoteStatus('completed')" class="mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors" data-status="completed">
                                Done
                            </button>
                        </div>
                    </div>

                    <!-- Assigned To -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Assigned To</label>
                        <input type="text" id="mkt-note-assigned" placeholder="Enter name..."
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-walmart-blue focus:border-transparent"
                               onchange="saveMarketNoteAssignment()">
                    </div>

                    <!-- Updates Section -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Updates</label>
                        <div id="mkt-note-updates" class="space-y-2 mb-3 max-h-48 overflow-y-auto">
                            <!-- Updates will be inserted here -->
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="mkt-note-new-update" placeholder="Add an update..."
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-walmart-blue focus:border-transparent text-sm">
                            <button onclick="addMarketNoteUpdate()" class="bg-walmart-blue text-white px-4 py-2 rounded-lg hover:bg-walmart-dark-blue transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: GOLD STAR NOTES -->
        <div id="view-gold-stars" class="hidden-view p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Gold Star Notes</h2>
                <div class="flex items-center gap-2">
                    <button onclick="changeGoldStarWeek(-1)" id="gold-star-prev-week" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-600">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div id="gold-star-week" class="text-center text-sm min-w-[100px]"></div>
                    <button onclick="changeGoldStarWeek(1)" id="gold-star-next-week" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-600">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Define This Week's Notes -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-star text-yellow-500 mr-2"></i>This Week's Gold Stars
                    </h3>
                    <button onclick="toggleGoldStarEdit()" id="gold-star-edit-btn" class="text-sm text-walmart-blue hover:text-walmart-dark-blue">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>

                <!-- Display Mode -->
                <div id="gold-star-display" class="space-y-2">
                    <div class="flex items-start gap-2">
                        <span class="bg-yellow-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold flex-shrink-0">1</span>
                        <p id="display-note-1" class="text-gray-700">-</p>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="bg-yellow-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold flex-shrink-0">2</span>
                        <p id="display-note-2" class="text-gray-700">-</p>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="bg-yellow-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold flex-shrink-0">3</span>
                        <p id="display-note-3" class="text-gray-700">-</p>
                    </div>
                </div>

                <!-- Edit Mode -->
                <div id="gold-star-edit" class="hidden space-y-3">
                    <div>
                        <label class="text-sm text-gray-600">Gold Star #1</label>
                        <input type="text" id="edit-note-1" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Enter first gold star note">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Gold Star #2</label>
                        <input type="text" id="edit-note-2" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Enter second gold star note">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Gold Star #3</label>
                        <input type="text" id="edit-note-3" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Enter third gold star note">
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="cancelGoldStarEdit()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button onclick="saveGoldStarNotes()" class="flex-1 px-4 py-2 bg-walmart-blue text-white rounded-lg hover:bg-walmart-dark-blue">Save Notes</button>
                    </div>
                </div>

                <!-- No notes defined message -->
                <div id="gold-star-empty" class="hidden text-center py-4">
                    <i class="fas fa-star text-gray-300 text-3xl mb-2"></i>
                    <p class="text-gray-500">No gold star notes defined for this week.</p>
                    <button onclick="toggleGoldStarEdit()" class="mt-2 text-walmart-blue hover:text-walmart-dark-blue font-medium">
                        <i class="fas fa-plus"></i> Add Notes
                    </button>
                </div>
            </div>

            <!-- Progress Summary -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-semibold text-gray-800 mb-3">Completion Progress</h3>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p id="gold-progress-1" class="text-2xl font-bold text-walmart-blue">0/0</p>
                        <p class="text-xs text-gray-500">Star #1</p>
                    </div>
                    <div>
                        <p id="gold-progress-2" class="text-2xl font-bold text-walmart-blue">0/0</p>
                        <p class="text-xs text-gray-500">Star #2</p>
                    </div>
                    <div>
                        <p id="gold-progress-3" class="text-2xl font-bold text-walmart-blue">0/0</p>
                        <p class="text-xs text-gray-500">Star #3</p>
                    </div>
                </div>
            </div>

            <!-- Store Checklist -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="bg-walmart-blue px-4 py-3">
                    <h3 class="text-white font-semibold">Store Checklist</h3>
                </div>
                <!-- Table Header -->
                <div class="grid grid-cols-12 gap-2 px-4 py-2 text-xs font-bold text-gray-600 uppercase border-b bg-gray-50">
                    <div class="col-span-3">Store</div>
                    <div class="col-span-3 text-center">Star 1</div>
                    <div class="col-span-3 text-center">Star 2</div>
                    <div class="col-span-3 text-center">Star 3</div>
                </div>
                <!-- Store Rows -->
                <div id="gold-star-stores" class="divide-y divide-gray-100">
                    <div class="p-8 text-center text-gray-500">Loading stores...</div>
                </div>
            </div>
        </div>

        <!-- VIEW: CHAMPIONS -->
        <div id="view-champions" class="hidden-view p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Champions</h2>
                <button onclick="showAddChampionForm()" class="bg-walmart-blue text-white px-4 py-2 rounded-lg hover:bg-walmart-dark-blue text-sm font-medium">
                    <i class="fas fa-plus mr-1"></i> Add
                </button>
            </div>

            <!-- Add/Edit Champion Form -->
            <div id="champion-form" class="hidden bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 id="champion-form-title" class="font-semibold text-gray-800 mb-3">Add Champion</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm text-gray-600">Name</label>
                        <input type="text" id="champion-name" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="e.g., Tim">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Champion Of</label>
                        <input type="text" id="champion-responsibility" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="e.g., My Local Social">
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="hideChampionForm()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button onclick="saveChampion()" class="flex-1 px-4 py-2 bg-walmart-blue text-white rounded-lg hover:bg-walmart-dark-blue">Save</button>
                    </div>
                </div>
                <input type="hidden" id="champion-edit-id" value="">
            </div>

            <!-- Champions List -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="bg-walmart-blue px-4 py-3 grid grid-cols-12 gap-2 text-white font-semibold text-sm">
                    <div class="col-span-4">Name</div>
                    <div class="col-span-6">Champion Of</div>
                    <div class="col-span-2 text-center">Actions</div>
                </div>
                <div id="champions-list" class="divide-y divide-gray-100">
                    <div class="p-8 text-center text-gray-500">Loading...</div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="champions-empty" class="hidden text-center py-12 bg-white rounded-xl mt-4">
                <i class="fas fa-trophy text-5xl text-gray-300 mb-4"></i>
                <p class="text-gray-600 font-medium">No champions yet</p>
                <p class="text-gray-400 text-sm mt-1">Add your first champion to get started</p>
            </div>
        </div>

        <!-- VIEW: STATUS -->
        <div id="view-status" class="hidden-view p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">System Status</h2>
                <button onclick="loadStatus()" class="text-walmart-blue hover:text-walmart-dark-blue">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <!-- Server Status -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-server text-walmart-blue mr-2"></i>Server
                </h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Status</span>
                        <span id="status-server-status" class="px-2 py-1 rounded-full text-xs font-bold bg-gray-100">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Environment</span>
                        <span id="status-server-env" class="text-gray-900">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Version</span>
                        <span id="status-server-version" class="text-gray-900">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Last Check</span>
                        <span id="status-server-timestamp" class="text-gray-500 text-sm">--</span>
                    </div>
                </div>
            </div>

            <!-- Database Status -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-database text-walmart-blue mr-2"></i>Database
                </h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Status</span>
                        <span id="status-db-status" class="px-2 py-1 rounded-full text-xs font-bold bg-gray-100">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Host</span>
                        <span id="status-db-host" class="text-gray-900 text-sm font-mono">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Database</span>
                        <span id="status-db-name" class="text-gray-900">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Latency</span>
                        <span id="status-db-latency" class="text-gray-900">--</span>
                    </div>
                </div>
            </div>

            <!-- Vertex AI Status -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-brain text-walmart-blue mr-2"></i>Vertex AI
                </h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Status</span>
                        <span id="status-ai-status" class="px-2 py-1 rounded-full text-xs font-bold bg-gray-100">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Project</span>
                        <span id="status-ai-project" class="text-gray-900 text-sm">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Location</span>
                        <span id="status-ai-location" class="text-gray-900">--</span>
                    </div>
                </div>
            </div>

            <!-- Network Test -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-network-wired text-walmart-blue mr-2"></i>Connection Test
                </h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">API Response Time</span>
                        <span id="status-api-latency" class="text-gray-900">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Connection</span>
                        <span id="status-connection" class="px-2 py-1 rounded-full text-xs font-bold bg-gray-100">--</span>
                    </div>
                </div>
            </div>

            <!-- Available Endpoints -->
            <div class="bg-white rounded-xl shadow-sm p-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-plug text-walmart-blue mr-2"></i>API Endpoints
                </h3>
                <div id="status-endpoints" class="space-y-2 text-sm">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
        </div>

        <!-- VIEW: ISSUES -->
        <div id="view-issues" class="hidden-view p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Issues & Feedback</h2>
                <button onclick="openFeedbackModal()" class="bg-walmart-blue text-white px-4 py-2 rounded-lg hover:bg-walmart-dark-blue text-sm font-medium">
                    <i class="fas fa-plus mr-1"></i> New
                </button>
            </div>

            <!-- Filter Tabs -->
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button onclick="filterIssues('all')" id="filter-all" class="issue-filter-btn px-4 py-2 rounded-full text-sm font-medium bg-walmart-blue text-white">
                    All
                </button>
                <button onclick="filterIssues('feature')" id="filter-feature" class="issue-filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                    <i class="fas fa-lightbulb mr-1"></i> Features
                </button>
                <button onclick="filterIssues('bug')" id="filter-bug" class="issue-filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                    <i class="fas fa-bug mr-1"></i> Bugs
                </button>
                <button onclick="filterIssues('feedback')" id="filter-feedback" class="issue-filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                    <i class="fas fa-comment mr-1"></i> Feedback
                </button>
            </div>

            <!-- Active Issues List -->
            <div id="issues-list" class="space-y-3">
                <div class="text-center py-8">
                    <svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-3 text-gray-500">Loading issues...</p>
                </div>
            </div>

            <!-- Empty State -->
            <div id="issues-empty" class="hidden text-center py-12 bg-white rounded-xl">
                <i class="fas fa-clipboard-check text-5xl text-gray-300 mb-4"></i>
                <p class="text-gray-600 font-medium">No issues yet</p>
                <p class="text-gray-400 text-sm mt-1">Use the feedback button to submit your first item</p>
            </div>

            <!-- Completed Section (Collapsible) -->
            <div id="issues-completed-section" class="hidden mt-6">
                <button onclick="toggleCompletedIssues()" class="w-full bg-gray-200 hover:bg-gray-300 rounded-lg px-4 py-3 flex items-center justify-between transition-colors">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span class="font-medium text-gray-700">Completed</span>
                        <span id="issues-completed-count" class="bg-green-100 text-green-700 text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <i id="issues-completed-chevron" class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                </button>
                <div id="issues-completed-container" class="hidden mt-3 space-y-3">
                    <!-- Completed issues will be inserted here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center sm:justify-center">
        <div class="bg-white w-full sm:max-w-md sm:rounded-xl rounded-t-2xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 flex justify-between items-center p-4 border-b border-gray-200 bg-white">
                <h2 class="text-xl font-bold text-gray-900">Submit Feedback</h2>
                <button onclick="closeFeedbackModal()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-4 space-y-4">
                <!-- Type Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="selectFeedbackType('feature')" id="type-feature" class="feedback-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-lightbulb text-2xl text-yellow-500 mb-1"></i>
                            <span class="text-xs font-medium">Feature</span>
                        </button>
                        <button type="button" onclick="selectFeedbackType('bug')" id="type-bug" class="feedback-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-bug text-2xl text-red-500 mb-1"></i>
                            <span class="text-xs font-medium">Bug</span>
                        </button>
                        <button type="button" onclick="selectFeedbackType('feedback')" id="type-feedback" class="feedback-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-comment text-2xl text-walmart-blue mb-1"></i>
                            <span class="text-xs font-medium">Feedback</span>
                        </button>
                    </div>
                </div>

                <!-- Title -->
                <div>
                    <label for="feedback-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="feedback-title" placeholder="Brief summary..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-walmart-blue focus:ring-walmart-blue">
                </div>

                <!-- Description -->
                <div>
                    <label for="feedback-description" class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
                    <textarea id="feedback-description" rows="4" placeholder="Provide more details..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-walmart-blue focus:ring-walmart-blue"></textarea>
                </div>

                <!-- Submit Button -->
                <button onclick="submitFeedback()" class="w-full bg-walmart-blue text-white py-3 rounded-lg font-medium hover:bg-walmart-dark-blue transition-colors">
                    Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Issue Modal -->
    <div id="edit-issue-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center sm:justify-center">
        <div class="bg-white w-full sm:max-w-md sm:rounded-xl rounded-t-2xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 flex justify-between items-center p-4 border-b border-gray-200 bg-white">
                <h2 class="text-xl font-bold text-gray-900">Edit Issue</h2>
                <button onclick="closeEditIssueModal()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-4 space-y-4">
                <input type="hidden" id="edit-issue-id">

                <!-- Type Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="selectEditIssueType('feature')" id="edit-type-feature" class="edit-issue-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-lightbulb text-2xl text-yellow-500 mb-1"></i>
                            <span class="text-xs font-medium">Feature</span>
                        </button>
                        <button type="button" onclick="selectEditIssueType('bug')" id="edit-type-bug" class="edit-issue-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-bug text-2xl text-red-500 mb-1"></i>
                            <span class="text-xs font-medium">Bug</span>
                        </button>
                        <button type="button" onclick="selectEditIssueType('feedback')" id="edit-type-feedback" class="edit-issue-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-comment text-2xl text-walmart-blue mb-1"></i>
                            <span class="text-xs font-medium">Feedback</span>
                        </button>
                    </div>
                </div>

                <!-- Title -->
                <div>
                    <label for="edit-issue-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="edit-issue-title" placeholder="Brief summary..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-walmart-blue focus:ring-walmart-blue">
                </div>

                <!-- Description -->
                <div>
                    <label for="edit-issue-description" class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
                    <textarea id="edit-issue-description" rows="4" placeholder="Provide more details..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-walmart-blue focus:ring-walmart-blue"></textarea>
                </div>

                <!-- Save Button -->
                <button onclick="saveEditIssue()" class="w-full bg-walmart-blue text-white py-3 rounded-lg font-medium hover:bg-walmart-dark-blue transition-colors">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Market Selector Modal -->
    <div id="market-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center sm:justify-center">
        <div class="bg-white w-full sm:max-w-sm sm:rounded-xl rounded-t-2xl">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Select Market</h2>
                <button onclick="closeMarketModal()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-4 space-y-3">
                <button onclick="selectMarket('399')" id="market-btn-399" class="market-btn w-full p-4 rounded-xl border-2 border-gray-200 hover:border-walmart-blue transition-colors text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-lg text-gray-900">Market 399</p>
                            <p class="text-sm text-gray-500">10 stores</p>
                        </div>
                        <i class="fas fa-check-circle text-2xl text-gray-300" id="market-check-399"></i>
                    </div>
                </button>
                <button onclick="selectMarket('451')" id="market-btn-451" class="market-btn w-full p-4 rounded-xl border-2 border-gray-200 hover:border-walmart-blue transition-colors text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-lg text-gray-900">Market 451</p>
                            <p class="text-sm text-gray-500">9 stores</p>
                        </div>
                        <i class="fas fa-check-circle text-2xl text-gray-300" id="market-check-451"></i>
                    </div>
                </button>
                <button onclick="selectMarket('all')" id="market-btn-all" class="market-btn w-full p-4 rounded-xl border-2 border-gray-200 hover:border-walmart-blue transition-colors text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-lg text-gray-900">All Markets</p>
                            <p class="text-sm text-gray-500">19 stores</p>
                        </div>
                        <i class="fas fa-check-circle text-2xl text-gray-300" id="market-check-all"></i>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Visit Detail Modal -->
    <div id="visit-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center sm:justify-center">
        <div class="bg-white w-full sm:max-w-2xl sm:rounded-xl rounded-t-2xl max-h-screen sm:max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 flex justify-between items-center p-4 border-b border-gray-200 bg-white">
                <h2 class="text-xl font-bold text-gray-900">Visit Details</h2>
                <div class="flex items-center gap-2">
                    <button onclick="deleteVisit()" class="text-red-400 hover:text-red-600 p-2" title="Delete Visit">
                        <i class="fas fa-trash-alt text-lg"></i>
                    </button>
                    <button onclick="closeVisitDetailModal()" class="text-gray-400 hover:text-gray-600 p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-4 space-y-4">
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Store</p>
                        <p id="modal-store-nbr" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Date</p>
                        <p id="modal-date" class="text-lg font-semibold text-gray-900">-</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Rating</p>
                        <div id="modal-rating" class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-gray-100">-</div>
                    </div>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2 flex items-center">
                        <i class="fas fa-sticky-note text-walmart-blue mr-2"></i>Store Notes
                    </h3>
                    <div id="modal-store-notes" class="bg-gray-50 rounded-lg p-4 text-sm text-gray-700">-</div>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2 flex items-center">
                        <i class="fas fa-globe text-walmart-blue mr-2"></i>Market Notes
                    </h3>
                    <div id="modal-mkt-notes" class="bg-gray-50 rounded-lg p-4 text-sm text-gray-700">-</div>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2 flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>What's Working Well
                    </h3>
                    <div id="modal-good" class="bg-green-50 rounded-lg p-4 text-sm text-gray-700">-</div>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2 flex items-center">
                        <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>Top 3 Opportunities
                    </h3>
                    <div id="modal-top3" class="bg-yellow-50 rounded-lg p-4 text-sm text-gray-700">-</div>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2 flex items-center">
                        <i class="fas fa-chart-bar text-walmart-blue mr-2"></i>Metrics
                    </h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3" id="modal-metrics"></div>
                </div>

                <div class="pt-4 border-t border-gray-200 text-xs text-gray-500">
                    <p>Recorded: <span id="modal-created-at">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 pb-safe z-40">
        <div class="grid grid-cols-4 h-16">
            <button onclick="switchTab('home')" class="nav-btn w-full h-full flex flex-col items-center justify-center space-y-1 text-walmart-blue focus:outline-none" data-target="view-home">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs font-medium">Home</span>
            </button>
            <button onclick="switchTab('log-visit')" class="nav-btn w-full h-full flex flex-col items-center justify-center space-y-1 text-gray-500 hover:text-walmart-blue focus:outline-none" data-target="view-log-visit">
                <i class="fas fa-camera text-xl"></i>
                <span class="text-xs font-medium">Log Visit</span>
            </button>
            <button onclick="switchTab('visits')" class="nav-btn w-full h-full flex flex-col items-center justify-center space-y-1 text-gray-500 hover:text-walmart-blue focus:outline-none" data-target="view-visits">
                <i class="fas fa-clipboard-list text-xl"></i>
                <span class="text-xs font-medium">Tracker</span>
            </button>
            <button onclick="switchTab('market-notes')" class="nav-btn w-full h-full flex flex-col items-center justify-center space-y-1 text-gray-500 hover:text-walmart-blue focus:outline-none" data-target="view-market-notes">
                <i class="fas fa-tasks text-xl"></i>
                <span class="text-xs font-medium">Tasks</span>
            </button>
        </div>
    </nav>

    <script>
        // --- State ---
        let allVisits = [];
        let currentFilter = null;
        let currentRatingFilter = null;
        let currentSort = { column: null, ascending: true };
        let base64ImageData = null;
        let fileMimeType = null;
        let currentParsedData = null;

        // --- Market Configuration ---
        const MARKET_STORES = {
            '399': ['1951', '2508', '2617', '2780', '2781', '2861', '2862', '3093', '3739', '5841'],
            '451': ['2002', '2117', '2280', '2458', '4488', '5435', '5751', '5766', '5884']
        };
        let currentMarket = localStorage.getItem('selectedMarket') || 'all';

        function getMarketStores() {
            if (currentMarket === 'all') {
                return [...MARKET_STORES['399'], ...MARKET_STORES['451']];
            }
            return MARKET_STORES[currentMarket] || [];
        }

        function isStoreInCurrentMarket(storeNbr) {
            if (currentMarket === 'all') return true;
            const stores = MARKET_STORES[currentMarket] || [];
            return stores.includes(String(storeNbr));
        }

        function openMarketModal() {
            updateMarketModalUI();
            document.getElementById('market-modal').classList.remove('hidden');
        }

        function closeMarketModal() {
            document.getElementById('market-modal').classList.add('hidden');
        }

        function updateMarketModalUI() {
            // Reset all buttons
            ['399', '451', 'all'].forEach(m => {
                const btn = document.getElementById(`market-btn-${m}`);
                const check = document.getElementById(`market-check-${m}`);
                if (currentMarket === m) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add('border-walmart-blue', 'bg-blue-50');
                    check.classList.remove('text-gray-300');
                    check.classList.add('text-walmart-blue');
                } else {
                    btn.classList.remove('border-walmart-blue', 'bg-blue-50');
                    btn.classList.add('border-gray-200');
                    check.classList.remove('text-walmart-blue');
                    check.classList.add('text-gray-300');
                }
            });
        }

        function selectMarket(market) {
            currentMarket = market;
            localStorage.setItem('selectedMarket', market);
            updateHeaderMarketBadge();
            closeMarketModal();
            // Reload current view data
            loadDashboard();
            if (!document.getElementById('view-visits').classList.contains('hidden-view')) loadVisits();
            if (!document.getElementById('view-market-notes').classList.contains('hidden-view')) loadMarketNotes();
            if (!document.getElementById('view-gold-stars').classList.contains('hidden-view')) loadGoldStars();
        }

        function updateHeaderMarketBadge() {
            // No badge to update - market shown in modal only
        }

        // Close market modal on outside click
        document.getElementById('market-modal').addEventListener('click', function(e) {
            if (e.target === this) closeMarketModal();
        });

        // --- Drawer ---
        function openDrawer() {
            document.getElementById('drawer').classList.remove('-translate-x-full');
            document.getElementById('drawer-overlay').classList.remove('hidden');
        }
        function closeDrawer() {
            document.getElementById('drawer').classList.add('-translate-x-full');
            document.getElementById('drawer-overlay').classList.add('hidden');
        }
        document.getElementById('menu-btn').addEventListener('click', openDrawer);

        // --- Navigation ---
        function switchTab(tabName) {
            ['view-home', 'view-log-visit', 'view-visits', 'view-prior-tours', 'view-market-notes', 'view-gold-stars', 'view-champions', 'view-status', 'view-issues'].forEach(id => {
                document.getElementById(id).classList.add('hidden-view');
            });

            const targetId = 'view-' + tabName;
            document.getElementById(targetId).classList.remove('hidden-view');

            if (tabName === 'home') loadDashboard();
            if (tabName === 'visits') loadVisits();
            if (tabName === 'market-notes') loadMarketNotes();
            if (tabName === 'gold-stars') loadGoldStars();
            if (tabName === 'champions') loadChampions();
            if (tabName === 'status') loadStatus();
            if (tabName === 'issues') loadIssues();

            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isTarget = btn.getAttribute('data-target') === targetId;
                btn.classList.toggle('text-walmart-blue', isTarget);
                btn.classList.toggle('text-gray-500', !isTarget);
            });
        }

        // --- Dashboard ---
        async function loadDashboard() {
            try {
                // Load visits for store ratings
                const visitsResponse = await fetch('/api/visits');
                if (!visitsResponse.ok) throw new Error('Failed to load visits');
                const allVisitsData = await visitsResponse.json();

                // Filter by current market
                const visits = allVisitsData.filter(v => isStoreInCurrentMarket(v.storeNbr));

                let red = 0, yellow = 0, green = 0;
                const stores = new Set();

                visits.forEach(v => {
                    if (!stores.has(v.storeNbr)) {
                        stores.add(v.storeNbr);
                        if (v.rating === 'Red') red++;
                        else if (v.rating === 'Yellow') yellow++;
                        else if (v.rating === 'Green') green++;
                    }
                });

                document.getElementById('red-stores-count').textContent = red;
                document.getElementById('yellow-stores-count').textContent = yellow;
                document.getElementById('green-stores-count').textContent = green;

                // Load market notes for outstanding count
                const notesResponse = await fetch('/api/market-notes');
                if (notesResponse.ok) {
                    const marketNotes = await notesResponse.json();
                    // Filter by current market
                    const filteredNotes = marketNotes.filter(n => isStoreInCurrentMarket(n.store_nbr));
                    const incompleteCount = filteredNotes.filter(n => !n.completed).length;
                    document.getElementById('market-notes-count').textContent = incompleteCount;
                }
            } catch (e) {
                console.error(e);
            }
        }

        // --- Visits ---
        async function loadVisits() {
            const tbody = document.getElementById('visits-table-body');
            const summaryGrid = document.getElementById('store-summary-grid');
            tbody.innerHTML = '<div class="p-8 text-center"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch('/api/visits');
                if (!response.ok) throw new Error('Failed');
                const allVisitsData = await response.json();

                // Filter by current market
                allVisits = allVisitsData.filter(v => isStoreInCurrentMarket(v.storeNbr));

                // Populate filter dropdown with only stores in current market
                const stores = [...new Set(allVisits.map(v => v.storeNbr))].sort();
                const dropdown = document.getElementById('store-filter-dropdown');
                dropdown.innerHTML = `<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="filterVisits(null)">All Stores</div>` +
                    stores.map(s => `<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="filterVisits('${s}')">Store ${s}</div>`).join('');

                // Build store summary (last visit per store)
                renderStoreSummary();
                renderVisits();
            } catch (e) {
                tbody.innerHTML = '<div class="p-8 text-center text-red-500">Error loading visits</div>';
                summaryGrid.innerHTML = '<div class="text-center text-red-500 text-sm py-4 col-span-full">Error loading</div>';
            }
        }

        function renderStoreSummary() {
            const summaryGrid = document.getElementById('store-summary-grid');

            if (allVisits.length === 0) {
                summaryGrid.innerHTML = '<div class="text-center text-gray-400 text-sm py-4 col-span-full">No visits recorded yet</div>';
                return;
            }

            // Get last visit per store (visits should be sorted by date desc from API)
            const lastVisitByStore = {};
            allVisits.forEach(v => {
                if (!lastVisitByStore[v.storeNbr]) {
                    lastVisitByStore[v.storeNbr] = v;
                } else {
                    // Compare dates to ensure we have the latest
                    if (v.calendar_date > lastVisitByStore[v.storeNbr].calendar_date) {
                        lastVisitByStore[v.storeNbr] = v;
                    }
                }
            });

            // Sort stores by number
            const sortedStores = Object.keys(lastVisitByStore).sort();

            summaryGrid.innerHTML = sortedStores.map(storeNbr => {
                const v = lastVisitByStore[storeNbr];
                let ratingClass = 'bg-gray-100 border-gray-300';
                let ratingTextClass = 'text-gray-600';
                if (v.rating === 'Green') {
                    ratingClass = 'bg-green-50 border-green-400';
                    ratingTextClass = 'text-green-700';
                } else if (v.rating === 'Yellow') {
                    ratingClass = 'bg-yellow-50 border-yellow-400';
                    ratingTextClass = 'text-yellow-700';
                } else if (v.rating === 'Red') {
                    ratingClass = 'bg-red-50 border-red-400';
                    ratingTextClass = 'text-red-700';
                }

                const date = v.calendar_date ? new Date(v.calendar_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'N/A';

                return `
                    <div class="bg-white rounded-lg border-l-4 ${ratingClass} p-3 cursor-pointer hover:shadow-md transition-shadow" onclick="filterVisits('${storeNbr}')">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-gray-900">#${storeNbr}</span>
                            <span class="text-xs font-semibold ${ratingTextClass}">${v.rating || 'N/A'}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${date}</p>
                    </div>
                `;
            }).join('');
        }

        function filterVisits(storeNbr) {
            currentFilter = storeNbr;
            document.getElementById('store-filter-text').textContent = storeNbr ? `Store ${storeNbr}` : 'All Stores';
            document.getElementById('store-filter-dropdown').classList.add('hidden');
            renderVisits();
        }

        function sortVisits(column) {
            if (currentSort.column === column) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = column;
                currentSort.ascending = true;
            }
            renderVisits();
        }

        function filterByRating(rating) {
            currentRatingFilter = rating;
            currentFilter = null; // Clear store filter when filtering by rating
            document.getElementById('store-filter-text').textContent = 'All Stores';
            switchTab('visits');
        }

        function clearRatingFilter() {
            currentRatingFilter = null;
            renderVisits();
        }

        function renderVisits() {
            let visits = [...allVisits];

            // Apply store filter
            if (currentFilter) {
                visits = visits.filter(v => v.storeNbr === currentFilter);
            }

            // Apply rating filter
            if (currentRatingFilter) {
                visits = visits.filter(v => v.rating === currentRatingFilter);
            }

            // Update rating filter badge visibility and styling
            const badge = document.getElementById('rating-filter-badge');
            const label = document.getElementById('rating-filter-label');
            if (currentRatingFilter) {
                badge.classList.remove('hidden');
                label.textContent = currentRatingFilter + ' Stores';
                // Set color based on rating
                label.className = 'px-2 py-1 rounded-full text-xs font-bold';
                if (currentRatingFilter === 'Red') {
                    label.classList.add('bg-red-100', 'text-red-800');
                } else if (currentRatingFilter === 'Yellow') {
                    label.classList.add('bg-yellow-100', 'text-yellow-800');
                } else if (currentRatingFilter === 'Green') {
                    label.classList.add('bg-green-100', 'text-green-800');
                }
            } else {
                badge.classList.add('hidden');
            }

            if (currentSort.column) {
                visits.sort((a, b) => {
                    let valA, valB;
                    if (currentSort.column === 'store') { valA = a.storeNbr || ''; valB = b.storeNbr || ''; }
                    else if (currentSort.column === 'date') { valA = a.calendar_date || ''; valB = b.calendar_date || ''; }
                    else if (currentSort.column === 'rating') { valA = a.rating || ''; valB = b.rating || ''; }
                    const cmp = valA.localeCompare(valB);
                    return currentSort.ascending ? cmp : -cmp;
                });
            }

            const tbody = document.getElementById('visits-table-body');
            if (visits.length === 0) {
                tbody.innerHTML = '<div class="p-8 text-center text-gray-500">No visits found.</div>';
                return;
            }

            tbody.innerHTML = visits.map(v => {
                let ratingClass = 'bg-gray-100 text-gray-800';
                if (v.rating === 'Green') ratingClass = 'bg-green-100 text-green-800';
                else if (v.rating === 'Yellow') ratingClass = 'bg-yellow-100 text-yellow-800';
                else if (v.rating === 'Red') ratingClass = 'bg-red-100 text-red-800';
                else if (v.rating === 'Unknown') ratingClass = 'bg-gray-100 text-gray-800';

                const date = v.calendar_date ? new Date(v.calendar_date).toLocaleDateString() : 'N/A';
                const notesReceived = v.notes_received || false;

                let notes = [];
                if (v.top_3) {
                    if (Array.isArray(v.top_3)) {
                        notes = v.top_3.map(n => typeof n === 'object' ? n.text : n);
                    } else {
                        notes = v.top_3.split('\n').filter(n => n.trim());
                    }
                }

                return `
                    <div class="grid grid-cols-12 gap-2 px-4 py-3 hover:bg-gray-50 items-start">
                        <div class="col-span-2 font-medium text-gray-900 cursor-pointer" onclick="openVisitDetail(${v.id})">${v.storeNbr || '?'}</div>
                        <div class="col-span-2 text-gray-600 text-sm cursor-pointer" onclick="openVisitDetail(${v.id})">${date}</div>
                        <div class="col-span-2 cursor-pointer" onclick="openVisitDetail(${v.id})"><span class="px-2 py-1 text-xs font-bold rounded-full ${ratingClass}">${v.rating || 'Unknown'}</span></div>
                        <div class="col-span-2 text-center">
                            <button onclick="toggleNotesReceived(${v.id}, ${!notesReceived})"
                                class="w-6 h-6 rounded border-2 flex items-center justify-center mx-auto transition-colors ${notesReceived ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-green-400'}"
                                title="${notesReceived ? 'Notes received' : 'Mark as notes received'}">
                                ${notesReceived ? '<i class="fas fa-check text-xs"></i>' : ''}
                            </button>
                        </div>
                        <div class="col-span-4 text-sm text-gray-600 cursor-pointer" onclick="openVisitDetail(${v.id})">
                            ${notes.length > 0
                                ? notes.slice(0, 3).map((n, i) => `<div class="truncate"><span class="text-gray-400">${i+1}.</span> ${n}</div>`).join('')
                                : '<span class="text-gray-400 italic">No notes</span>'}
                        </div>
                    </div>`;
            }).join('');
        }

        // Store filter toggle
        document.getElementById('store-filter-btn').addEventListener('click', () => {
            document.getElementById('store-filter-dropdown').classList.toggle('hidden');
        });

        // Toggle notes received status
        async function toggleNotesReceived(visitId, newStatus) {
            try {
                const response = await fetch(`/api/visits/${visitId}/notes-received`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes_received: newStatus })
                });

                if (!response.ok) throw new Error('Failed to update');

                // Update local state
                const visit = allVisits.find(v => v.id === visitId);
                if (visit) {
                    visit.notes_received = newStatus;
                    renderVisits();
                }
            } catch (e) {
                console.error('Error toggling notes received:', e);
                alert('Failed to update notes status');
            }
        }

        // --- Market Notes ---
        let allMarketNotes = [];
        let marketNotesStoreFilter = null;
        let completedSectionExpanded = false;
        let currentMarketNote = null;

        const STATUS_CONFIG = {
            'new': { label: 'New', color: 'bg-blue-100 text-blue-700', borderColor: 'border-blue-500 bg-blue-50' },
            'in_progress': { label: 'In Progress', color: 'bg-yellow-100 text-yellow-700', borderColor: 'border-yellow-500 bg-yellow-50' },
            'on_hold': { label: 'On Hold', color: 'bg-orange-100 text-orange-700', borderColor: 'border-orange-500 bg-orange-50' },
            'completed': { label: 'Completed', color: 'bg-green-100 text-green-700', borderColor: 'border-green-500 bg-green-50' }
        };

        async function loadMarketNotes() {
            const listEl = document.getElementById('market-notes-list');
            listEl.innerHTML = '<div class="text-center py-8"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch('/api/market-notes');
                if (!response.ok) throw new Error('Failed to load market notes');
                const allNotesData = await response.json();

                // Filter by current market
                allMarketNotes = allNotesData.filter(n => isStoreInCurrentMarket(n.store_nbr));

                // Populate store filter dropdown with only stores in current market
                const stores = [...new Set(allMarketNotes.map(n => n.store_nbr))].sort();
                const dropdown = document.getElementById('market-store-filter-dropdown');
                dropdown.innerHTML = `<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="filterMarketNotesByStore(null)">All Stores</div>` +
                    stores.map(s => `<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="filterMarketNotesByStore('${s}')">Store ${s}</div>`).join('');

                renderMarketNotes();
            } catch (e) {
                listEl.innerHTML = '<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-circle text-2xl mb-2"></i><p>Error loading market notes</p></div>';
            }
        }

        function filterMarketNotesByStore(storeNbr) {
            marketNotesStoreFilter = storeNbr;
            document.getElementById('market-store-filter-text').textContent = storeNbr ? `Store ${storeNbr}` : 'All Stores';
            document.getElementById('market-store-filter-dropdown').classList.add('hidden');
            renderMarketNotes();
        }

        function toggleCompletedSection() {
            completedSectionExpanded = !completedSectionExpanded;
            const container = document.getElementById('completed-notes-container');
            const chevron = document.getElementById('completed-chevron');

            if (completedSectionExpanded) {
                container.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                container.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function renderMarketNotes() {
            let filteredNotes = [...allMarketNotes];

            // Apply store filter
            if (marketNotesStoreFilter) {
                filteredNotes = filteredNotes.filter(n => n.store_nbr === marketNotesStoreFilter);
            }

            // Separate by status
            const incompleteNotes = filteredNotes.filter(n => n.status !== 'completed');
            const completedNotes = filteredNotes.filter(n => n.status === 'completed');

            // Update progress
            document.getElementById('market-notes-progress').textContent = `${completedNotes.length}/${filteredNotes.length} completed`;

            const listEl = document.getElementById('market-notes-list');

            // Render incomplete notes
            if (incompleteNotes.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-xl">
                        <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                        <p class="text-gray-600 font-medium">All caught up!</p>
                        <p class="text-gray-400 text-sm mt-1">No outstanding market notes</p>
                    </div>`;
            } else {
                // Group by store
                const groupedByStore = {};
                incompleteNotes.forEach(n => {
                    if (!groupedByStore[n.store_nbr]) groupedByStore[n.store_nbr] = [];
                    groupedByStore[n.store_nbr].push(n);
                });

                listEl.innerHTML = Object.keys(groupedByStore).sort().map(storeNbr => `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="bg-walmart-blue px-4 py-2 flex justify-between items-center">
                            <span class="text-white font-semibold">Store #${storeNbr}</span>
                            <span class="text-white text-sm opacity-80">${groupedByStore[storeNbr].length} remaining</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 text-left">
                                    <tr>
                                        <th class="px-4 py-2 font-medium text-gray-600">Note</th>
                                        <th class="px-4 py-2 font-medium text-gray-600 w-28">Assigned To</th>
                                        <th class="px-4 py-2 font-medium text-gray-600 w-24">Status</th>
                                        <th class="px-4 py-2 font-medium text-gray-600 w-20 text-center">Updates</th>
                                        <th class="w-8"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    ${groupedByStore[storeNbr].map(note => {
                                        const statusCfg = STATUS_CONFIG[note.status] || STATUS_CONFIG['new'];
                                        const updateCount = note.updates ? note.updates.length : 0;
                                        return `
                                        <tr class="market-note-item cursor-pointer hover:bg-gray-50"
                                            data-note-index="${allMarketNotes.indexOf(note)}">
                                            <td class="px-4 py-3">
                                                <p class="text-gray-800">${escapeHtml(note.note_text)}</p>
                                                <p class="text-xs text-gray-400 mt-1">${note.calendar_date || 'No date'}</p>
                                            </td>
                                            <td class="px-4 py-3 text-gray-600">${note.assigned_to ? escapeHtml(note.assigned_to) : '<span class="text-gray-300">â€”</span>'}</td>
                                            <td class="px-4 py-3">
                                                <span class="text-xs font-medium px-2 py-1 rounded-full ${statusCfg.color}">${statusCfg.label}</span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                ${updateCount > 0 ? `<span class="inline-flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">${updateCount}</span>` : '<span class="text-gray-300">â€”</span>'}
                                            </td>
                                            <td class="px-2 py-3">
                                                <i class="fas fa-chevron-right text-gray-300"></i>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('');
            }

            // Render completed section
            const completedSection = document.getElementById('completed-section');
            const completedContainer = document.getElementById('completed-notes-container');
            const completedBadge = document.getElementById('completed-count-badge');

            if (completedNotes.length === 0) {
                completedSection.classList.add('hidden');
            } else {
                completedSection.classList.remove('hidden');
                completedBadge.textContent = completedNotes.length;

                // Group completed by store
                const completedByStore = {};
                completedNotes.forEach(n => {
                    if (!completedByStore[n.store_nbr]) completedByStore[n.store_nbr] = [];
                    completedByStore[n.store_nbr].push(n);
                });

                completedContainer.innerHTML = Object.keys(completedByStore).sort().map(storeNbr => `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden opacity-75">
                        <div class="bg-gray-500 px-4 py-2 flex justify-between items-center">
                            <span class="text-white font-semibold">Store #${storeNbr}</span>
                            <span class="text-white text-sm opacity-80">${completedByStore[storeNbr].length} completed</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100 text-left">
                                    <tr>
                                        <th class="px-4 py-2 font-medium text-gray-500">Note</th>
                                        <th class="px-4 py-2 font-medium text-gray-500 w-28">Assigned To</th>
                                        <th class="px-4 py-2 font-medium text-gray-500 w-24">Status</th>
                                        <th class="px-4 py-2 font-medium text-gray-500 w-20 text-center">Updates</th>
                                        <th class="w-8"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100 bg-gray-50">
                                    ${completedByStore[storeNbr].map(note => {
                                        const updateCount = note.updates ? note.updates.length : 0;
                                        return `
                                        <tr class="market-note-item cursor-pointer hover:bg-gray-100"
                                            data-note-index="${allMarketNotes.indexOf(note)}">
                                            <td class="px-4 py-3">
                                                <p class="text-gray-400 line-through">${escapeHtml(note.note_text)}</p>
                                                <p class="text-xs text-gray-400 mt-1">${note.calendar_date || 'No date'}</p>
                                            </td>
                                            <td class="px-4 py-3 text-gray-400">${note.assigned_to ? escapeHtml(note.assigned_to) : '<span class="text-gray-300">â€”</span>'}</td>
                                            <td class="px-4 py-3">
                                                <span class="text-xs font-medium px-2 py-1 rounded-full bg-green-100 text-green-700">Completed</span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                ${updateCount > 0 ? `<span class="inline-flex items-center justify-center w-6 h-6 bg-gray-200 text-gray-500 text-xs font-medium rounded-full">${updateCount}</span>` : '<span class="text-gray-300">â€”</span>'}
                                            </td>
                                            <td class="px-2 py-3">
                                                <i class="fas fa-chevron-right text-gray-300"></i>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Open market note detail modal
        function openMarketNoteModal(noteIndex) {
            const note = allMarketNotes[noteIndex];
            if (!note) return;

            currentMarketNote = note;
            currentMarketNote._index = noteIndex;

            // Populate modal
            document.getElementById('mkt-note-store').textContent = `Store #${note.store_nbr}`;
            document.getElementById('mkt-note-date').textContent = note.calendar_date || 'No date';
            document.getElementById('mkt-note-text').textContent = note.note_text;
            document.getElementById('mkt-note-assigned').value = note.assigned_to || '';

            // Update status buttons
            document.querySelectorAll('.mkt-status-btn').forEach(btn => {
                const btnStatus = btn.dataset.status;
                const cfg = STATUS_CONFIG[btnStatus];
                if (btnStatus === note.status) {
                    btn.className = `mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors ${cfg.borderColor}`;
                } else {
                    btn.className = 'mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors border-gray-200 hover:border-gray-400';
                }
            });

            // Render updates
            renderMarketNoteUpdates();

            document.getElementById('market-note-modal').classList.remove('hidden');
        }

        function closeMarketNoteModal() {
            document.getElementById('market-note-modal').classList.add('hidden');
            currentMarketNote = null;
        }

        function renderMarketNoteUpdates() {
            const container = document.getElementById('mkt-note-updates');
            const updates = currentMarketNote.updates || [];

            if (updates.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm italic">No updates yet</p>';
            } else {
                container.innerHTML = updates.map((u, idx) => `
                    <div class="bg-gray-50 rounded-lg p-3 group relative">
                        <button onclick="deleteMarketNoteUpdate(${u.id}, ${idx})"
                                class="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                title="Delete update">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                        <p class="text-sm text-gray-800 pr-6">${escapeHtml(u.text)}</p>
                        <p class="text-xs text-gray-400 mt-1">
                            ${u.created_by ? u.created_by + ' - ' : ''}${u.created_at ? new Date(u.created_at).toLocaleString() : ''}
                        </p>
                    </div>
                `).join('');
            }
        }

        async function deleteMarketNoteUpdate(updateId, index) {
            if (!confirm('Delete this update?')) return;

            try {
                const response = await fetch(`/api/market-notes/delete-update/${updateId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to delete update');
                }

                // Remove from local state
                currentMarketNote.updates.splice(index, 1);
                renderMarketNoteUpdates();
                renderMarketNotes();

            } catch (e) {
                console.error('Error deleting update:', e);
                alert('Failed to delete update: ' + e.message);
            }
        }

        async function setMarketNoteStatus(status) {
            if (!currentMarketNote) return;

            try {
                const response = await fetch('/api/market-notes/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        visit_id: currentMarketNote.visit_id,
                        note_text: currentMarketNote.note_text,
                        status: status
                    })
                });

                if (!response.ok) throw new Error('Failed to update');

                // Update local state
                currentMarketNote.status = status;
                currentMarketNote.completed = (status === 'completed');

                // Update status buttons
                document.querySelectorAll('.mkt-status-btn').forEach(btn => {
                    const btnStatus = btn.dataset.status;
                    const cfg = STATUS_CONFIG[btnStatus];
                    if (btnStatus === status) {
                        btn.className = `mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors ${cfg.borderColor}`;
                    } else {
                        btn.className = 'mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors border-gray-200 hover:border-gray-400';
                    }
                });

                renderMarketNotes();
                updateDashboardMarketCount();

            } catch (e) {
                console.error('Error updating status:', e);
                alert('Failed to update status');
            }
        }

        async function saveMarketNoteAssignment() {
            if (!currentMarketNote) return;

            const assignedTo = document.getElementById('mkt-note-assigned').value.trim();

            try {
                const response = await fetch('/api/market-notes/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        visit_id: currentMarketNote.visit_id,
                        note_text: currentMarketNote.note_text,
                        assigned_to: assignedTo
                    })
                });

                if (!response.ok) throw new Error('Failed to update');

                currentMarketNote.assigned_to = assignedTo;
                renderMarketNotes();

            } catch (e) {
                console.error('Error updating assignment:', e);
                alert('Failed to update assignment');
            }
        }

        async function addMarketNoteUpdate() {
            if (!currentMarketNote) return;

            const updateText = document.getElementById('mkt-note-new-update').value.trim();
            if (!updateText) return;

            try {
                const response = await fetch('/api/market-notes/add-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        visit_id: currentMarketNote.visit_id,
                        note_text: currentMarketNote.note_text,
                        update_text: updateText
                    })
                });

                if (!response.ok) throw new Error('Failed to add update');

                const result = await response.json();

                // Add to local state
                if (!currentMarketNote.updates) currentMarketNote.updates = [];
                currentMarketNote.updates.unshift(result.update);

                document.getElementById('mkt-note-new-update').value = '';
                renderMarketNoteUpdates();
                renderMarketNotes();

            } catch (e) {
                console.error('Error adding update:', e);
                alert('Failed to add update');
            }
        }

        function updateDashboardMarketCount() {
            const incompleteCount = allMarketNotes.filter(n => n.status !== 'completed').length;
            const countEl = document.getElementById('market-notes-count');
            if (countEl) countEl.textContent = incompleteCount;
        }

        // Event delegation for market note clicks (both outstanding and completed)
        document.getElementById('market-notes-list').addEventListener('click', (e) => {
            const noteItem = e.target.closest('.market-note-item');
            if (noteItem) {
                const noteIndex = parseInt(noteItem.dataset.noteIndex);
                openMarketNoteModal(noteIndex);
            }
        });

        document.getElementById('completed-notes-container').addEventListener('click', (e) => {
            const noteItem = e.target.closest('.market-note-item');
            if (noteItem) {
                const noteIndex = parseInt(noteItem.dataset.noteIndex);
                openMarketNoteModal(noteIndex);
            }
        });

        // Close modal on backdrop click
        document.getElementById('market-note-modal').addEventListener('click', function(e) {
            if (e.target === this) closeMarketNoteModal();
        });

        // Market notes store filter toggle
        document.getElementById('market-store-filter-btn').addEventListener('click', () => {
            document.getElementById('market-store-filter-dropdown').classList.toggle('hidden');
        });

        // --- Gold Star Notes ---
        let goldStarData = null;
        let goldStarEditMode = false;
        let goldStarWeekOffset = 0;

        function changeGoldStarWeek(delta) {
            goldStarWeekOffset += delta;
            loadGoldStars();
        }

        async function loadGoldStars() {
            const storesContainer = document.getElementById('gold-star-stores');
            storesContainer.innerHTML = '<div class="p-8 text-center"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch(`/api/gold-stars/current?week_offset=${goldStarWeekOffset}&market=${currentMarket}`);
                if (!response.ok) throw new Error('Failed to load gold stars');
                goldStarData = await response.json();

                // Display week info (Saturday to Friday)
                const weekStart = new Date(goldStarData.week_start_date + 'T00:00:00');
                const weekEnd = new Date(goldStarData.week_end_date + 'T00:00:00');
                const weekNumber = goldStarData.week_number || 1;
                const isCurrentWeek = goldStarData.is_current_week;

                // Week label with indicator for current week
                const weekLabel = isCurrentWeek ? 'Week ' + weekNumber : 'Week ' + weekNumber;
                const currentIndicator = isCurrentWeek ? '<span class="text-xs text-green-600 block">(Current)</span>' : '';

                document.getElementById('gold-star-week').innerHTML =
                    `<div class="font-bold text-walmart-blue">${weekLabel}</div>
                     <div class="text-xs">${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                     ${currentIndicator}`;

                renderGoldStars();
            } catch (e) {
                console.error('Error loading gold stars:', e);
                storesContainer.innerHTML = '<div class="p-8 text-center text-red-500">Error loading gold star notes</div>';
            }
        }

        function renderGoldStars() {
            const displayEl = document.getElementById('gold-star-display');
            const emptyEl = document.getElementById('gold-star-empty');
            const editBtn = document.getElementById('gold-star-edit-btn');
            const storesContainer = document.getElementById('gold-star-stores');
            const isCurrentWeek = goldStarData.is_current_week;

            if (!goldStarData.notes || (!goldStarData.notes.note_1 && !goldStarData.notes.note_2 && !goldStarData.notes.note_3)) {
                // No notes defined for this week
                displayEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                editBtn.classList.add('hidden');
                storesContainer.innerHTML = '<div class="p-8 text-center text-gray-500">No gold star notes defined for this week</div>';
                document.getElementById('gold-progress-1').textContent = '0/0';
                document.getElementById('gold-progress-2').textContent = '0/0';
                document.getElementById('gold-progress-3').textContent = '0/0';
                return;
            }

            // Show notes
            displayEl.classList.remove('hidden');
            emptyEl.classList.add('hidden');
            // Only show edit button for current week
            if (isCurrentWeek) {
                editBtn.classList.remove('hidden');
            } else {
                editBtn.classList.add('hidden');
            }

            document.getElementById('display-note-1').textContent = goldStarData.notes.note_1;
            document.getElementById('display-note-2').textContent = goldStarData.notes.note_2;
            document.getElementById('display-note-3').textContent = goldStarData.notes.note_3;

            // Calculate progress - filter by current market
            const allStores = goldStarData.stores || [];
            const stores = allStores.filter(s => isStoreInCurrentMarket(s.store_nbr));
            const total = stores.length;
            const completed1 = stores.filter(s => s.note_1).length;
            const completed2 = stores.filter(s => s.note_2).length;
            const completed3 = stores.filter(s => s.note_3).length;

            document.getElementById('gold-progress-1').textContent = `${completed1}/${total}`;
            document.getElementById('gold-progress-2').textContent = `${completed2}/${total}`;
            document.getElementById('gold-progress-3').textContent = `${completed3}/${total}`;

            // Render store rows
            if (stores.length === 0) {
                storesContainer.innerHTML = '<div class="p-8 text-center text-gray-500">No stores found in selected market.</div>';
                return;
            }

            storesContainer.innerHTML = stores.map(store => {
                const allComplete = store.note_1 && store.note_2 && store.note_3;
                const disabledClass = isCurrentWeek ? '' : 'opacity-50 cursor-not-allowed';
                const clickHandler = isCurrentWeek ? `onclick="toggleGoldStar('${store.store_nbr}', ` : 'onclick="return false;" disabled ';
                return `
                    <div class="grid grid-cols-12 gap-2 px-4 py-3 items-center ${allComplete ? 'bg-green-50' : ''}">
                        <div class="col-span-3 font-medium text-gray-900">#${store.store_nbr}</div>
                        <div class="col-span-3 text-center">
                            <button ${isCurrentWeek ? `onclick="toggleGoldStar('${store.store_nbr}', 1, ${!store.note_1})"` : 'disabled'}
                                class="w-8 h-8 rounded-full border-2 flex items-center justify-center mx-auto transition-colors ${disabledClass} ${store.note_1 ? 'bg-yellow-400 border-yellow-400' : 'border-gray-300' + (isCurrentWeek ? ' hover:border-yellow-400' : '')}">
                                ${store.note_1 ? '<i class="fas fa-star text-white text-sm"></i>' : ''}
                            </button>
                        </div>
                        <div class="col-span-3 text-center">
                            <button ${isCurrentWeek ? `onclick="toggleGoldStar('${store.store_nbr}', 2, ${!store.note_2})"` : 'disabled'}
                                class="w-8 h-8 rounded-full border-2 flex items-center justify-center mx-auto transition-colors ${disabledClass} ${store.note_2 ? 'bg-yellow-400 border-yellow-400' : 'border-gray-300' + (isCurrentWeek ? ' hover:border-yellow-400' : '')}">
                                ${store.note_2 ? '<i class="fas fa-star text-white text-sm"></i>' : ''}
                            </button>
                        </div>
                        <div class="col-span-3 text-center">
                            <button ${isCurrentWeek ? `onclick="toggleGoldStar('${store.store_nbr}', 3, ${!store.note_3})"` : 'disabled'}
                                class="w-8 h-8 rounded-full border-2 flex items-center justify-center mx-auto transition-colors ${disabledClass} ${store.note_3 ? 'bg-yellow-400 border-yellow-400' : 'border-gray-300' + (isCurrentWeek ? ' hover:border-yellow-400' : '')}">
                                ${store.note_3 ? '<i class="fas fa-star text-white text-sm"></i>' : ''}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleGoldStarEdit() {
            goldStarEditMode = !goldStarEditMode;
            const displayEl = document.getElementById('gold-star-display');
            const editEl = document.getElementById('gold-star-edit');
            const emptyEl = document.getElementById('gold-star-empty');
            const editBtn = document.getElementById('gold-star-edit-btn');

            if (goldStarEditMode) {
                displayEl.classList.add('hidden');
                emptyEl.classList.add('hidden');
                editEl.classList.remove('hidden');
                editBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';

                // Pre-fill with existing values
                if (goldStarData && goldStarData.notes) {
                    document.getElementById('edit-note-1').value = goldStarData.notes.note_1 || '';
                    document.getElementById('edit-note-2').value = goldStarData.notes.note_2 || '';
                    document.getElementById('edit-note-3').value = goldStarData.notes.note_3 || '';
                }
            } else {
                cancelGoldStarEdit();
            }
        }

        function cancelGoldStarEdit() {
            goldStarEditMode = false;
            const displayEl = document.getElementById('gold-star-display');
            const editEl = document.getElementById('gold-star-edit');
            const emptyEl = document.getElementById('gold-star-empty');
            const editBtn = document.getElementById('gold-star-edit-btn');

            editEl.classList.add('hidden');
            editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';

            if (goldStarData && goldStarData.notes) {
                displayEl.classList.remove('hidden');
            } else {
                emptyEl.classList.remove('hidden');
            }
        }

        async function saveGoldStarNotes() {
            const note1 = document.getElementById('edit-note-1').value.trim();
            const note2 = document.getElementById('edit-note-2').value.trim();
            const note3 = document.getElementById('edit-note-3').value.trim();

            if (!note1 || !note2 || !note3) {
                alert('Please fill in all three gold star notes');
                return;
            }

            try {
                const response = await fetch('/api/gold-stars/week', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ note_1: note1, note_2: note2, note_3: note3 })
                });

                if (!response.ok) throw new Error('Failed to save');

                goldStarEditMode = false;
                await loadGoldStars();
            } catch (e) {
                console.error('Error saving gold stars:', e);
                alert('Failed to save gold star notes');
            }
        }

        async function toggleGoldStar(storeNbr, noteNumber, completed) {
            try {
                const response = await fetch('/api/gold-stars/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ store_nbr: storeNbr, note_number: noteNumber, completed: completed })
                });

                if (!response.ok) throw new Error('Failed to update');

                // Update local state
                const store = goldStarData.stores.find(s => s.store_nbr === storeNbr);
                if (store) {
                    store[`note_${noteNumber}`] = completed;
                    renderGoldStars();
                }
            } catch (e) {
                console.error('Error toggling gold star:', e);
                alert('Failed to update completion status');
            }
        }

        // --- Prior Tours ---
        document.getElementById('btn-search-prior').addEventListener('click', async () => {
            const storeNbr = document.getElementById('prior-store-nbr').value.trim();
            if (!storeNbr) { alert('Please enter a store number'); return; }

            const div = document.getElementById('prior-results');
            div.innerHTML = '<div class="text-center py-8"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch(`/api/visits?storeNbr=${encodeURIComponent(storeNbr)}`);
                if (!response.ok) throw new Error('Failed');
                const data = await response.json();

                if (data.length === 0) {
                    div.innerHTML = '<div class="text-center py-8 bg-white rounded-xl"><p class="text-gray-500">No prior visits found for store #' + storeNbr + '</p></div>';
                    return;
                }

                div.innerHTML = data.map(v => {
                    let ratingClass = 'bg-gray-100 text-gray-800';
                    if (v.rating === 'Green') ratingClass = 'bg-green-100 text-green-800';
                    else if (v.rating === 'Yellow') ratingClass = 'bg-yellow-100 text-yellow-800';
                    else if (v.rating === 'Red') ratingClass = 'bg-red-100 text-red-800';
                    else if (v.rating === 'Unknown') ratingClass = 'bg-gray-100 text-gray-800';

                    let notes = [];
                    if (v.top_3) {
                        if (Array.isArray(v.top_3)) notes = v.top_3.map(n => typeof n === 'object' ? n.text : n);
                        else notes = v.top_3.split('\n').filter(n => n.trim());
                    }

                    return `
                        <div class="bg-white p-4 rounded-xl shadow cursor-pointer hover:shadow-lg transition-shadow" onclick="openVisitDetail(${v.id})">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <span class="text-sm text-gray-500">Date</span>
                                    <p class="font-bold text-gray-900">${v.calendar_date || 'N/A'}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${ratingClass}">${v.rating || 'Unknown'}</span>
                            </div>
                            <div>
                                <h4 class="text-xs font-semibold text-gray-500 uppercase mb-2">Top 3 Notes</h4>
                                ${notes.length > 0
                                    ? `<ul class="space-y-1">${notes.map(n => `<li class="text-sm text-gray-700 flex"><i class="fas fa-exclamation-circle text-yellow-500 mt-1 mr-2 text-xs"></i>${n}</li>`).join('')}</ul>`
                                    : '<p class="text-sm text-gray-400 italic">No notes</p>'}
                            </div>
                        </div>`;
                }).join('');
            } catch (e) {
                div.innerHTML = '<div class="p-4 bg-red-50 text-red-700 rounded-lg">Error loading visits</div>';
            }
        });

        // --- Image Upload ---
        const handleImageSelect = (e) => {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;

            fileMimeType = file.type;
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('image-preview').src = ev.target.result;
                document.getElementById('image-preview-container').classList.remove('hidden');
                base64ImageData = ev.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('image-upload').addEventListener('change', handleImageSelect);
        document.getElementById('camera-input').addEventListener('change', handleImageSelect);

        document.getElementById('analyze-button').addEventListener('click', async () => {
            if (!base64ImageData) { showError('Please upload an image first.'); return; }

            setLoading(true);
            try {
                const response = await fetch('/api/analyze-visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mime_type: fileMimeType, image_data: base64ImageData })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Analysis failed');
                }

                currentParsedData = await response.json();
                displayResults(currentParsedData);
                await checkAndSave(currentParsedData);
            } catch (e) {
                showError(e.message);
            } finally {
                setLoading(false);
            }
        });

        async function reanalyzeNotes() {
            if (!base64ImageData) {
                showError('No image to analyze. Please upload an image first.');
                return;
            }

            setLoading(true);
            document.getElementById('results-container').classList.add('hidden');

            try {
                const response = await fetch('/api/analyze-visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mime_type: fileMimeType, image_data: base64ImageData })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Re-analysis failed');
                }

                currentParsedData = await response.json();
                displayResults(currentParsedData);
                // Don't auto-save on re-analyze - let user review first
            } catch (e) {
                showError(e.message);
            } finally {
                setLoading(false);
            }
        }

        async function manualSaveVisit() {
            if (!currentParsedData) {
                showError('No data to save. Please analyze an image first.');
                return;
            }
            await checkAndSave(currentParsedData);
        }

        async function checkAndSave(data) {
            try {
                const checkUrl = `/api/check-duplicate?storeNbr=${encodeURIComponent(data.storeNbr)}&calendar_date=${encodeURIComponent(data.calendar_date)}`;
                const checkResponse = await fetch(checkUrl);
                if (!checkResponse.ok) { await saveToBackend(data); return; }

                const result = await checkResponse.json();
                if (result.is_duplicate && result.existing_records.length > 0) {
                    showDuplicateModal(result.existing_records);
                } else {
                    await saveToBackend(data);
                }
            } catch (e) {
                if (confirm('Could not check for duplicates. Save anyway?')) await saveToBackend(data);
            }
        }

        async function saveToBackend(data) {
            try {
                const response = await fetch('/api/save-visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error || `Save failed (${response.status})`);
                }
                console.log('Saved successfully');
                alert('Visit saved successfully!');
                // Reset form for next entry
                resetLogVisitForm();
            } catch (e) {
                console.error('Save error:', e);
                showError('Failed to save: ' + e.message);
            }
        }

        function resetLogVisitForm() {
            // Clear image data
            base64ImageData = null;
            fileMimeType = null;
            currentParsedData = null;
            // Hide preview and results
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('image-preview').src = '';
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('error-message').classList.add('hidden');
            // Reset file inputs
            document.getElementById('image-upload').value = '';
            document.getElementById('camera-input').value = '';
            // Reset metrics to default values
            const metricIds = [
                'metric-sales-comp-yest', 'metric-sales-comp-wtd', 'metric-sales-comp-mtd',
                'metric-sales-index-yest', 'metric-sales-index-wtd', 'metric-sales-index-mtd',
                'metric-ftpr', 'metric-presub', 'metric-vizpick', 'metric-vizpick-health',
                'metric-overstock', 'metric-picks', 'metric-fashion', 'metric-topstock-grocery', 'metric-cases',
                'metric-modflex', 'metric-tag-errors', 'metric-mods', 'metric-pcs', 'metric-pinpoint', 'metric-locations'
            ];
            metricIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '--';
            });
        }

        function showDuplicateModal(records) {
            const r = records[0];
            document.getElementById('duplicate-details').innerHTML = `<p><strong>Store:</strong> ${r.storeNbr}</p><p><strong>Date:</strong> ${r.calendar_date}</p>`;
            document.getElementById('duplicate-modal').classList.remove('hidden');
        }

        document.getElementById('duplicate-cancel-btn').addEventListener('click', () => {
            document.getElementById('duplicate-modal').classList.add('hidden');
        });
        document.getElementById('duplicate-submit-btn').addEventListener('click', async () => {
            document.getElementById('duplicate-modal').classList.add('hidden');
            await saveToBackend(currentParsedData);
        });

        function setLoading(loading) {
            document.getElementById('loading-spinner').classList.toggle('hidden', !loading);
            document.getElementById('analyze-button').disabled = loading;
            if (loading) document.getElementById('results-container').classList.add('hidden');
        }

        function displayResults(data) {
            const formatArray = (arr) => {
                if (!arr || arr.length === 0) return 'N/A';
                if (arr[0] && typeof arr[0] === 'object' && arr[0].text) return arr.map(i => `â€¢ ${i.text}`).join('\n');
                return arr.map(i => `â€¢ ${i}`).join('\n');
            };

            const rating = data.rating || 'Unknown';
            let ratingClass = 'bg-gray-100 text-gray-800 border-gray-300';
            if (rating === 'Red') ratingClass = 'bg-red-100 text-red-800 border-red-300';
            else if (rating === 'Yellow') ratingClass = 'bg-yellow-100 text-yellow-800 border-yellow-300';
            else if (rating === 'Green') ratingClass = 'bg-green-100 text-green-800 border-green-300';
            else if (rating === 'Unknown') ratingClass = 'bg-gray-100 text-gray-800 border-gray-300';

            document.getElementById('result-rating').className = `inline-flex items-center justify-center px-6 py-2 text-xl font-bold rounded-full border-2 ${ratingClass}`;
            document.getElementById('result-rating').textContent = rating;
            document.getElementById('result-calendar-date').textContent = data.calendar_date || 'N/A';
            document.getElementById('result-store-nbr').textContent = data.storeNbr || 'N/A';
            document.getElementById('result-store-notes').textContent = Array.isArray(data.store_notes) ? formatArray(data.store_notes) : (data.store_notes || 'N/A');
            document.getElementById('result-mkt-notes').textContent = Array.isArray(data.mkt_notes) ? formatArray(data.mkt_notes) : (data.mkt_notes || 'N/A');
            document.getElementById('result-good').textContent = formatArray(data.good);
            document.getElementById('result-top-3').textContent = formatArray(data.top_3);

            // Populate metrics
            const metrics = data.metrics || {};
            const formatMetric = (value) => {
                if (value === null || value === undefined || value === '') return '--';
                return value;
            };

            // Sales metrics
            document.getElementById('metric-sales-comp-yest').textContent = formatMetric(metrics.sales_comp_yest);
            document.getElementById('metric-sales-comp-wtd').textContent = formatMetric(metrics.sales_comp_wtd);
            document.getElementById('metric-sales-comp-mtd').textContent = formatMetric(metrics.sales_comp_mtd);
            document.getElementById('metric-sales-index-yest').textContent = formatMetric(metrics.sales_index_yest);
            document.getElementById('metric-sales-index-wtd').textContent = formatMetric(metrics.sales_index_wtd);
            document.getElementById('metric-sales-index-mtd').textContent = formatMetric(metrics.sales_index_mtd);

            // Inventory Health metrics
            document.getElementById('metric-ftpr').textContent = formatMetric(metrics.ftpr);
            document.getElementById('metric-presub').textContent = formatMetric(metrics.presub);
            document.getElementById('metric-vizpick').textContent = formatMetric(metrics.vizpick);
            document.getElementById('metric-overstock').textContent = formatMetric(metrics.overstock);
            document.getElementById('metric-picks').textContent = formatMetric(metrics.picks);
            document.getElementById('metric-fashion').textContent = formatMetric(metrics.vizfashion);

            // Basic Work metrics
            document.getElementById('metric-modflex').textContent = formatMetric(metrics.modflex);
            document.getElementById('metric-tag-errors').textContent = formatMetric(metrics.tag_errors);
            document.getElementById('metric-mods').textContent = formatMetric(metrics.mods);
            document.getElementById('metric-pcs').textContent = formatMetric(metrics.pcs);
            document.getElementById('metric-pinpoint').textContent = formatMetric(metrics.pinpoint);
            document.getElementById('metric-locations').textContent = formatMetric(metrics.locations);

            // Additional Inventory Health metrics
            document.getElementById('metric-vizpick-health').textContent = formatMetric(metrics.vizpick_health);
            document.getElementById('metric-topstock-grocery').textContent = formatMetric(metrics.topstock_grocery);
            document.getElementById('metric-cases').textContent = formatMetric(metrics.cases);

            document.getElementById('results-container').classList.remove('hidden');
        }

        function showError(msg) {
            document.getElementById('error-text').textContent = msg;
            document.getElementById('error-message').classList.remove('hidden');
        }

        // --- Visit Detail Modal ---
        async function openVisitDetail(id) {
            const modal = document.getElementById('visit-detail-modal');
            modal.classList.remove('hidden');
            document.getElementById('modal-store-notes').innerHTML = '<div class="text-center"><svg class="animate-spin h-6 w-6 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch(`/api/visit/${id}`);
                if (!response.ok) throw new Error('Failed');
                const v = await response.json();
                displayVisitDetail(v);
            } catch (e) {
                document.getElementById('modal-store-notes').innerHTML = `<div class="text-red-600">Error: ${e.message}</div>`;
            }
        }

        // Store current visit for note deletion
        let currentVisitDetail = null;

        function displayVisitDetail(v) {
            currentVisitDetail = v;

            // Format notes with edit and delete buttons
            const formatNotes = (notes, noteType) => {
                if (!notes) return '(None)';
                let items = [];
                if (Array.isArray(notes)) {
                    if (notes.length === 0) return '(None)';
                    items = notes.map(n => {
                        if (typeof n === 'object' && n.id) {
                            return { id: n.id, text: n.text };
                        } else {
                            return { id: null, text: typeof n === 'object' ? n.text : n };
                        }
                    });
                } else if (typeof notes === 'string') {
                    items = notes.split('\n').filter(n => n.trim()).map(n => ({ id: null, text: n }));
                }
                if (items.length === 0) return '(None)';
                return items.map(n => {
                    const editBtn = n.id ? `<button onclick="startEditNote('${noteType}', ${n.id}, this)" class="ml-2 text-walmart-blue hover:text-walmart-dark-blue opacity-0 group-hover:opacity-100 transition-opacity" title="Edit note"><i class="fas fa-edit text-xs"></i></button>` : '';
                    const deleteBtn = n.id ? `<button onclick="deleteNote('${noteType}', ${n.id})" class="ml-1 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Delete note"><i class="fas fa-trash-alt text-xs"></i></button>` : '';
                    return `<li class="flex items-start group note-item" data-note-id="${n.id}" data-note-type="${noteType}">
                        <i class="fas fa-check-circle text-walmart-blue mt-1 mr-2 text-sm flex-shrink-0"></i>
                        <span class="flex-1 note-text">${escapeHtml(n.text)}</span>
                        <div class="flex items-center flex-shrink-0">${editBtn}${deleteBtn}</div>
                    </li>`;
                }).join('');
            };

            let ratingClass = 'bg-gray-100 text-gray-800';
            if (v.rating === 'Green') ratingClass = 'bg-green-100 text-green-800';
            else if (v.rating === 'Yellow') ratingClass = 'bg-yellow-100 text-yellow-800';
            else if (v.rating === 'Red') ratingClass = 'bg-red-100 text-red-800';
            else if (v.rating === 'Unknown') ratingClass = 'bg-gray-100 text-gray-800';

            document.getElementById('modal-store-nbr').textContent = `#${v.storeNbr || '?'}`;
            document.getElementById('modal-date').textContent = v.calendar_date ? new Date(v.calendar_date).toLocaleDateString() : 'N/A';
            const ratingEl = document.getElementById('modal-rating');
            ratingEl.className = `inline-block px-3 py-1 rounded-full text-xs font-bold ${ratingClass}`;
            ratingEl.textContent = v.rating || 'Unknown';

            const storeNotes = formatNotes(v.store_notes, 'store');
            document.getElementById('modal-store-notes').innerHTML = storeNotes === '(None)' ? '<p class="text-gray-400 italic">(None)</p>' : `<ul class="space-y-2">${storeNotes}</ul>`;

            const mktNotes = formatNotes(v.mkt_notes, 'market');
            document.getElementById('modal-mkt-notes').innerHTML = mktNotes === '(None)' ? '<p class="text-gray-400 italic">(None)</p>' : `<ul class="space-y-2">${mktNotes}</ul>`;

            const good = formatNotes(v.good, 'good');
            document.getElementById('modal-good').innerHTML = good === '(None)' ? '<p class="text-gray-400 italic">(None)</p>' : `<ul class="space-y-2">${good}</ul>`;

            const top3 = formatNotes(v.top_3, 'improvement');
            document.getElementById('modal-top3').innerHTML = top3 === '(None)' ? '<p class="text-gray-400 italic">(None)</p>' : `<ul class="space-y-2">${top3}</ul>`;

            const metrics = [
                { label: 'Sales Comp (Yest)', value: v.sales_comp_yest, fmt: '%' },
                { label: 'Sales Index (Yest)', value: v.sales_index_yest },
                { label: 'Sales Comp (WTD)', value: v.sales_comp_wtd, fmt: '%' },
                { label: 'Sales Index (WTD)', value: v.sales_index_wtd },
                { label: 'Vizpick', value: v.vizpick, fmt: '%' },
                { label: 'Overstock', value: v.overstock },
                { label: 'Picks', value: v.picks },
                { label: 'FTPR', value: v.ftpr, fmt: '%' },
            ];
            const metricsContainer = document.getElementById('modal-metrics');
            const validMetrics = metrics.filter(m => m.value !== null && m.value !== undefined);
            metricsContainer.innerHTML = validMetrics.length > 0
                ? validMetrics.map(m => `<div class="bg-blue-50 rounded-lg p-3"><p class="text-xs font-semibold text-gray-600">${m.label}</p><p class="text-lg font-bold text-walmart-blue">${m.value}${m.fmt || ''}</p></div>`).join('')
                : '<p class="col-span-full text-gray-400 italic text-sm">No metrics recorded</p>';

            if (v.created_at) document.getElementById('modal-created-at').textContent = new Date(v.created_at).toLocaleString();
        }

        function closeVisitDetailModal() {
            document.getElementById('visit-detail-modal').classList.add('hidden');
        }

        async function deleteNote(noteType, noteId) {
            if (!confirm('Are you sure you want to delete this note?')) return;

            try {
                const response = await fetch(`/api/notes/${noteType}/${noteId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to delete note');
                }

                // Refresh the visit detail to show updated notes
                if (currentVisitDetail && currentVisitDetail.id) {
                    const visitResponse = await fetch(`/api/visit/${currentVisitDetail.id}`);
                    if (visitResponse.ok) {
                        const updatedVisit = await visitResponse.json();
                        displayVisitDetail(updatedVisit);
                    }
                }

                // Also refresh the visits list
                loadVisits();

            } catch (e) {
                console.error('Error deleting note:', e);
                alert('Error deleting note: ' + e.message);
            }
        }

        function startEditNote(noteType, noteId, btnElement) {
            // Find the note item container
            const noteItem = btnElement.closest('.note-item');
            if (!noteItem) return;

            const noteTextSpan = noteItem.querySelector('.note-text');
            if (!noteTextSpan) return;

            const currentText = noteTextSpan.textContent;
            const btnContainer = btnElement.closest('div');

            // Replace text with input
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'flex-1 border border-walmart-blue rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-walmart-blue';
            input.dataset.originalText = currentText;

            noteTextSpan.replaceWith(input);
            input.focus();
            input.select();

            // Replace buttons with save/cancel
            btnContainer.innerHTML = `
                <button onclick="saveEditNote('${noteType}', ${noteId}, this)" class="ml-2 text-green-600 hover:text-green-800" title="Save">
                    <i class="fas fa-check text-xs"></i>
                </button>
                <button onclick="cancelEditNote(this)" class="ml-1 text-gray-500 hover:text-gray-700" title="Cancel">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;

            // Handle enter key to save
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEditNote(noteType, noteId, btnContainer.querySelector('button'));
                } else if (e.key === 'Escape') {
                    cancelEditNote(btnContainer.querySelector('button:last-child'));
                }
            });
        }

        async function saveEditNote(noteType, noteId, btnElement) {
            const noteItem = btnElement.closest('.note-item');
            if (!noteItem) return;

            const input = noteItem.querySelector('input');
            if (!input) return;

            const newText = input.value.trim();
            if (!newText) {
                alert('Note text cannot be empty');
                return;
            }

            try {
                const response = await fetch(`/api/notes/${noteType}/${noteId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: newText })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to update note');
                }

                // Refresh the visit detail to show updated notes
                if (currentVisitDetail && currentVisitDetail.id) {
                    const visitResponse = await fetch(`/api/visit/${currentVisitDetail.id}`);
                    if (visitResponse.ok) {
                        const updatedVisit = await visitResponse.json();
                        displayVisitDetail(updatedVisit);
                    }
                }

                // Also refresh the visits list
                loadVisits();

            } catch (e) {
                console.error('Error updating note:', e);
                alert('Error updating note: ' + e.message);
            }
        }

        function cancelEditNote(btnElement) {
            const noteItem = btnElement.closest('.note-item');
            if (!noteItem) return;

            const input = noteItem.querySelector('input');
            if (!input) return;

            const originalText = input.dataset.originalText || '';
            const noteType = noteItem.dataset.noteType;
            const noteId = noteItem.dataset.noteId;

            // Restore the original text span
            const span = document.createElement('span');
            span.className = 'flex-1 note-text';
            span.textContent = originalText;
            input.replaceWith(span);

            // Restore original buttons
            const btnContainer = btnElement.closest('div');
            btnContainer.innerHTML = `
                <button onclick="startEditNote('${noteType}', ${noteId}, this)" class="ml-2 text-walmart-blue hover:text-walmart-dark-blue opacity-0 group-hover:opacity-100 transition-opacity" title="Edit note">
                    <i class="fas fa-edit text-xs"></i>
                </button>
                <button onclick="deleteNote('${noteType}', ${noteId})" class="ml-1 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Delete note">
                    <i class="fas fa-trash-alt text-xs"></i>
                </button>
            `;
        }

        async function deleteVisit() {
            if (!currentVisitDetail || !currentVisitDetail.id) {
                alert('No visit selected');
                return;
            }

            const storeNbr = currentVisitDetail.storeNbr || '?';
            const date = currentVisitDetail.calendar_date ? new Date(currentVisitDetail.calendar_date).toLocaleDateString() : 'unknown date';

            if (!confirm(`Are you sure you want to delete this entire visit?\n\nStore #${storeNbr} - ${date}\n\nThis will remove all notes and data for this visit.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/visits/${currentVisitDetail.id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to delete visit');
                }

                // Close modal and refresh lists
                closeVisitDetailModal();
                loadVisits();
                loadDashboard();

            } catch (e) {
                console.error('Error deleting visit:', e);
                alert('Error deleting visit: ' + e.message);
            }
        }

        document.getElementById('visit-detail-modal').addEventListener('click', function(e) {
            if (e.target === this) closeVisitDetailModal();
        });

        // --- Champions ---
        let allChampions = [];
        let editingChampionId = null;

        async function loadChampions() {
            const listEl = document.getElementById('champions-list');
            const emptyEl = document.getElementById('champions-empty');
            listEl.innerHTML = '<div class="p-8 text-center"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch('/api/champions');
                if (!response.ok) throw new Error('Failed to load champions');
                allChampions = await response.json();

                renderChampions();
            } catch (e) {
                console.error('Error loading champions:', e);
                listEl.innerHTML = '<div class="p-8 text-center text-red-500">Error loading champions</div>';
            }
        }

        function renderChampions() {
            const listEl = document.getElementById('champions-list');
            const emptyEl = document.getElementById('champions-empty');
            const tableContainer = listEl.parentElement;

            if (allChampions.length === 0) {
                tableContainer.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                return;
            }

            tableContainer.classList.remove('hidden');
            emptyEl.classList.add('hidden');

            listEl.innerHTML = allChampions.map(c => `
                <div class="grid grid-cols-12 gap-2 px-4 py-3 hover:bg-gray-50 items-center">
                    <div class="col-span-4 font-medium text-gray-900">${escapeHtml(c.name)}</div>
                    <div class="col-span-6 text-gray-600">${escapeHtml(c.responsibility)}</div>
                    <div class="col-span-2 flex justify-center gap-2">
                        <button onclick="editChampion(${c.id})" class="text-walmart-blue hover:text-walmart-dark-blue p-1">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteChampion(${c.id})" class="text-red-500 hover:text-red-700 p-1">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showAddChampionForm() {
            editingChampionId = null;
            document.getElementById('champion-form-title').textContent = 'Add Champion';
            document.getElementById('champion-name').value = '';
            document.getElementById('champion-responsibility').value = '';
            document.getElementById('champion-edit-id').value = '';
            document.getElementById('champion-form').classList.remove('hidden');
            document.getElementById('champion-name').focus();
        }

        function hideChampionForm() {
            document.getElementById('champion-form').classList.add('hidden');
            editingChampionId = null;
        }

        function editChampion(id) {
            const champion = allChampions.find(c => c.id === id);
            if (!champion) return;

            editingChampionId = id;
            document.getElementById('champion-form-title').textContent = 'Edit Champion';
            document.getElementById('champion-name').value = champion.name;
            document.getElementById('champion-responsibility').value = champion.responsibility;
            document.getElementById('champion-edit-id').value = id;
            document.getElementById('champion-form').classList.remove('hidden');
            document.getElementById('champion-name').focus();
        }

        async function saveChampion() {
            const name = document.getElementById('champion-name').value.trim();
            const responsibility = document.getElementById('champion-responsibility').value.trim();

            if (!name || !responsibility) {
                alert('Please fill in both Name and Champion Of fields');
                return;
            }

            try {
                let response;
                if (editingChampionId) {
                    // Update existing
                    response = await fetch(`/api/champions/${editingChampionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, responsibility })
                    });
                } else {
                    // Create new
                    response = await fetch('/api/champions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, responsibility })
                    });
                }

                if (!response.ok) throw new Error('Failed to save');

                hideChampionForm();
                await loadChampions();
            } catch (e) {
                console.error('Error saving champion:', e);
                alert('Failed to save champion');
            }
        }

        async function deleteChampion(id) {
            if (!confirm('Are you sure you want to delete this champion?')) return;

            try {
                const response = await fetch(`/api/champions/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete');

                await loadChampions();
            } catch (e) {
                console.error('Error deleting champion:', e);
                alert('Failed to delete champion');
            }
        }

        // --- Status ---
        async function loadStatus() {
            // Reset all status indicators
            const statusElements = [
                'status-server-status', 'status-db-status', 'status-ai-status', 'status-connection'
            ];
            statusElements.forEach(id => {
                const el = document.getElementById(id);
                el.textContent = 'Checking...';
                el.className = 'px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-600';
            });

            const startTime = performance.now();

            try {
                const response = await fetch('/api/status');
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);

                if (!response.ok) throw new Error('Failed to fetch status');

                const data = await response.json();

                // Server Status
                setStatusBadge('status-server-status', data.server.status, data.server.status === 'online');
                document.getElementById('status-server-env').textContent = data.server.environment || '--';
                document.getElementById('status-server-version').textContent = data.server.version || '--';
                document.getElementById('status-server-timestamp').textContent =
                    data.server.timestamp ? new Date(data.server.timestamp).toLocaleString() : '--';

                // Database Status
                setStatusBadge('status-db-status', data.database.status, data.database.status === 'connected');
                document.getElementById('status-db-host').textContent =
                    `${data.database.host}:${data.database.port}`;
                document.getElementById('status-db-name').textContent = data.database.name || '--';
                document.getElementById('status-db-latency').textContent =
                    data.database.latency_ms ? `${data.database.latency_ms} ms` : '--';

                // Vertex AI Status
                setStatusBadge('status-ai-status', data.vertex_ai.status,
                    data.vertex_ai.status === 'configured');
                document.getElementById('status-ai-project').textContent = data.vertex_ai.project || '--';
                document.getElementById('status-ai-location').textContent = data.vertex_ai.location || '--';

                // Connection Test
                document.getElementById('status-api-latency').textContent = `${latency} ms`;
                setStatusBadge('status-connection', 'connected', true);

                // Endpoints
                const endpointsEl = document.getElementById('status-endpoints');
                if (data.endpoints && data.endpoints.length > 0) {
                    endpointsEl.innerHTML = data.endpoints.map(ep => `
                        <div class="flex justify-between items-center py-1 px-2 bg-gray-50 rounded">
                            <span class="font-mono text-gray-700">${ep.path}</span>
                            <span class="text-xs text-gray-500">${ep.methods.join(', ')}</span>
                        </div>
                    `).join('');
                } else {
                    endpointsEl.innerHTML = '<div class="text-gray-500">No endpoints available</div>';
                }

            } catch (e) {
                console.error('Error loading status:', e);
                setStatusBadge('status-server-status', 'offline', false);
                setStatusBadge('status-connection', 'disconnected', false);
                document.getElementById('status-api-latency').textContent = 'Failed';
                document.getElementById('status-endpoints').innerHTML =
                    '<div class="text-red-500">Unable to connect to server</div>';
            }
        }

        function setStatusBadge(elementId, text, isGood) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            if (isGood) {
                el.className = 'px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800';
            } else {
                el.className = 'px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800';
            }
        }

        // --- Issues/Feedback ---
        let allIssues = [];
        let currentIssueFilter = 'all';
        let issuesCompletedExpanded = false;
        let selectedFeedbackType = null;

        async function loadIssues() {
            const listEl = document.getElementById('issues-list');
            listEl.innerHTML = '<div class="text-center py-8"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch('/api/issues');
                if (!response.ok) throw new Error('Failed to load issues');
                allIssues = await response.json();
                renderIssues();
            } catch (e) {
                console.error('Error loading issues:', e);
                listEl.innerHTML = '<div class="text-center py-8 text-red-500">Error loading issues</div>';
            }
        }

        function renderIssues() {
            const listEl = document.getElementById('issues-list');
            const emptyEl = document.getElementById('issues-empty');
            const completedSection = document.getElementById('issues-completed-section');
            const completedContainer = document.getElementById('issues-completed-container');
            const completedCount = document.getElementById('issues-completed-count');

            // Filter issues
            let filteredIssues = allIssues;
            if (currentIssueFilter !== 'all') {
                filteredIssues = allIssues.filter(i => i.type === currentIssueFilter);
            }

            // Separate active and completed
            const activeIssues = filteredIssues.filter(i => i.status !== 'completed');
            const completedIssues = filteredIssues.filter(i => i.status === 'completed');

            // Render active issues
            if (activeIssues.length === 0 && completedIssues.length === 0) {
                listEl.innerHTML = '';
                emptyEl.classList.remove('hidden');
            } else {
                emptyEl.classList.add('hidden');
                if (activeIssues.length === 0) {
                    listEl.innerHTML = '<div class="text-center py-8 text-gray-500">No active issues</div>';
                } else {
                    listEl.innerHTML = activeIssues.map(issue => renderIssueCard(issue)).join('');
                }
            }

            // Render completed section
            if (completedIssues.length > 0) {
                completedSection.classList.remove('hidden');
                completedCount.textContent = completedIssues.length;
                completedContainer.innerHTML = completedIssues.map(issue => renderIssueCard(issue, true)).join('');
            } else {
                completedSection.classList.add('hidden');
            }
        }

        function renderIssueCard(issue, isCompleted = false) {
            const typeIcons = {
                feature: '<i class="fas fa-lightbulb text-yellow-500"></i>',
                bug: '<i class="fas fa-bug text-red-500"></i>',
                feedback: '<i class="fas fa-comment text-walmart-blue"></i>'
            };

            const statusColors = {
                new: 'bg-blue-100 text-blue-800',
                in_progress: 'bg-yellow-100 text-yellow-800',
                completed: 'bg-green-100 text-green-800'
            };

            const statusLabels = {
                new: 'New',
                in_progress: 'In Progress',
                completed: 'Completed'
            };

            const date = issue.created_at ? new Date(issue.created_at).toLocaleDateString() : '';

            return `
                <div class="bg-white rounded-xl shadow-sm p-4 ${isCompleted ? 'opacity-60' : ''}">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-2">
                            ${typeIcons[issue.type] || ''}
                            <span class="font-medium text-gray-900 ${isCompleted ? 'line-through' : ''}">${escapeHtml(issue.title)}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <select onchange="updateIssueStatus(${issue.id}, this.value)" class="text-xs border rounded px-2 py-1 ${statusColors[issue.status]}">
                                <option value="new" ${issue.status === 'new' ? 'selected' : ''}>New</option>
                                <option value="in_progress" ${issue.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                <option value="completed" ${issue.status === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                            <button onclick="openEditIssueModal(${issue.id})" class="text-gray-400 hover:text-walmart-blue p-1" title="Edit">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button onclick="deleteIssue(${issue.id})" class="text-gray-400 hover:text-red-500 p-1" title="Delete">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                    ${issue.description ? `<p class="text-sm text-gray-600 mb-2">${escapeHtml(issue.description)}</p>` : ''}
                    <div class="text-xs text-gray-400">${date}</div>
                </div>
            `;
        }

        function filterIssues(type) {
            currentIssueFilter = type;

            // Update filter button styles
            document.querySelectorAll('.issue-filter-btn').forEach(btn => {
                btn.classList.remove('bg-walmart-blue', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            const activeBtn = document.getElementById(`filter-${type}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                activeBtn.classList.add('bg-walmart-blue', 'text-white');
            }

            renderIssues();
        }

        function toggleCompletedIssues() {
            issuesCompletedExpanded = !issuesCompletedExpanded;
            const container = document.getElementById('issues-completed-container');
            const chevron = document.getElementById('issues-completed-chevron');

            if (issuesCompletedExpanded) {
                container.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                container.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        async function updateIssueStatus(id, status) {
            try {
                const response = await fetch(`/api/issues/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                if (!response.ok) throw new Error('Failed to update');

                // Update local state
                const issue = allIssues.find(i => i.id === id);
                if (issue) {
                    issue.status = status;
                    renderIssues();
                }
            } catch (e) {
                console.error('Error updating issue:', e);
                alert('Failed to update issue status');
                loadIssues(); // Reload to reset
            }
        }

        async function deleteIssue(id) {
            if (!confirm('Delete this issue?')) return;

            try {
                const response = await fetch(`/api/issues/${id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to delete');

                allIssues = allIssues.filter(i => i.id !== id);
                renderIssues();
            } catch (e) {
                console.error('Error deleting issue:', e);
                alert('Failed to delete issue');
            }
        }

        // --- Edit Issue Modal ---
        let selectedEditIssueType = null;

        function openEditIssueModal(id) {
            const issue = allIssues.find(i => i.id === id);
            if (!issue) return;

            document.getElementById('edit-issue-id').value = id;
            document.getElementById('edit-issue-title').value = issue.title || '';
            document.getElementById('edit-issue-description').value = issue.description || '';

            // Reset and select the current type
            selectedEditIssueType = issue.type;
            document.querySelectorAll('.edit-issue-type-btn').forEach(btn => {
                btn.classList.remove('border-walmart-blue', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            const selectedBtn = document.getElementById(`edit-type-${issue.type}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-gray-200');
                selectedBtn.classList.add('border-walmart-blue', 'bg-blue-50');
            }

            document.getElementById('edit-issue-modal').classList.remove('hidden');
        }

        function closeEditIssueModal() {
            document.getElementById('edit-issue-modal').classList.add('hidden');
        }

        function selectEditIssueType(type) {
            selectedEditIssueType = type;
            document.querySelectorAll('.edit-issue-type-btn').forEach(btn => {
                btn.classList.remove('border-walmart-blue', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            const selectedBtn = document.getElementById(`edit-type-${type}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-gray-200');
                selectedBtn.classList.add('border-walmart-blue', 'bg-blue-50');
            }
        }

        async function saveEditIssue() {
            const id = parseInt(document.getElementById('edit-issue-id').value);
            const title = document.getElementById('edit-issue-title').value.trim();
            const description = document.getElementById('edit-issue-description').value.trim();

            if (!title) {
                alert('Please enter a title');
                return;
            }

            if (!selectedEditIssueType) {
                alert('Please select a type');
                return;
            }

            try {
                const response = await fetch(`/api/issues/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        description,
                        type: selectedEditIssueType
                    })
                });

                if (!response.ok) throw new Error('Failed to update issue');

                // Update local state
                const issue = allIssues.find(i => i.id === id);
                if (issue) {
                    issue.title = title;
                    issue.description = description;
                    issue.type = selectedEditIssueType;
                }

                closeEditIssueModal();
                renderIssues();
            } catch (e) {
                console.error('Error updating issue:', e);
                alert('Failed to update issue');
            }
        }

        // Close edit issue modal on backdrop click
        document.getElementById('edit-issue-modal').addEventListener('click', function(e) {
            if (e.target === this) closeEditIssueModal();
        });

        // --- Feedback Modal ---
        function openFeedbackModal() {
            selectedFeedbackType = null;
            document.getElementById('feedback-title').value = '';
            document.getElementById('feedback-description').value = '';
            document.querySelectorAll('.feedback-type-btn').forEach(btn => {
                btn.classList.remove('border-walmart-blue', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            document.getElementById('feedback-modal').classList.remove('hidden');
        }

        function closeFeedbackModal() {
            document.getElementById('feedback-modal').classList.add('hidden');
        }

        function selectFeedbackType(type) {
            selectedFeedbackType = type;
            document.querySelectorAll('.feedback-type-btn').forEach(btn => {
                btn.classList.remove('border-walmart-blue', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            const selectedBtn = document.getElementById(`type-${type}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-gray-200');
                selectedBtn.classList.add('border-walmart-blue', 'bg-blue-50');
            }
        }

        async function submitFeedback() {
            if (!selectedFeedbackType) {
                alert('Please select a type (Feature, Bug, or Feedback)');
                return;
            }

            const title = document.getElementById('feedback-title').value.trim();
            if (!title) {
                alert('Please enter a title');
                return;
            }

            const description = document.getElementById('feedback-description').value.trim();

            try {
                const response = await fetch('/api/issues', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: selectedFeedbackType,
                        title: title,
                        description: description
                    })
                });

                if (!response.ok) throw new Error('Failed to submit');

                closeFeedbackModal();

                // If on issues page, reload the list
                if (!document.getElementById('view-issues').classList.contains('hidden-view')) {
                    await loadIssues();
                }

                // Show success message
                alert('Feedback submitted successfully!');
            } catch (e) {
                console.error('Error submitting feedback:', e);
                alert('Failed to submit feedback');
            }
        }

        // Close feedback modal on outside click
        document.getElementById('feedback-modal').addEventListener('click', function(e) {
            if (e.target === this) closeFeedbackModal();
        });

        // --- Jax Chat Functions ---
        let jaxOpen = false;

        const jaxLoadingMessages = [
            "ðŸ• Jax is fetching your results...",
            "ðŸ¦´ Sniffing through the data...",
            "ðŸ¾ Jax is on the trail...",
            "ðŸ¶ Running to get your info...",
            "ðŸŽ¾ Chasing down those numbers...",
            "ðŸ•â€ðŸ¦º Digging through the database...",
            "ðŸ¦® Jax is tracking it down...",
            "ðŸ© Pawing through the records...",
            "ðŸ• Good boy is working hard...",
            "ðŸ¦´ Almost got it... stay!",
            "ðŸ¾ Jax found something interesting...",
            "ðŸ¶ Tail wagging, data loading...",
            "ðŸŽ¾ Fetching... almost there!",
            "ðŸ• Jax says 'one moment, woof!'",
            "ðŸ¦® Retrieving your answer..."
        ];

        function getRandomLoadingMessage() {
            return jaxLoadingMessages[Math.floor(Math.random() * jaxLoadingMessages.length)];
        }

        function toggleJax() {
            jaxOpen = !jaxOpen;
            const panel = document.getElementById('jax-panel');
            const btn = document.getElementById('jax-toggle-btn');

            if (jaxOpen) {
                panel.classList.remove('hidden');
                panel.classList.add('flex');
                btn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>`;
                document.getElementById('jax-input').focus();
            } else {
                panel.classList.add('hidden');
                panel.classList.remove('flex');
                btn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>`;
            }
        }

        async function sendJaxMessage() {
            const input = document.getElementById('jax-input');
            const message = input.value.trim();
            if (!message) return;

            const messagesDiv = document.getElementById('jax-messages');

            // Add user message
            messagesDiv.innerHTML += `
                <div class="flex justify-end mb-3">
                    <div class="bg-blue-600 text-white rounded-lg px-4 py-2 max-w-xs">
                        ${escapeHtml(message)}
                    </div>
                </div>
            `;

            input.value = '';
            input.disabled = true;
            document.getElementById('jax-send-btn').disabled = true;

            // Add typing indicator with fun message
            const typingId = 'typing-' + Date.now();
            const loadingMsg = getRandomLoadingMessage();
            messagesDiv.innerHTML += `
                <div id="${typingId}" class="flex justify-start mb-3">
                    <div class="bg-gray-200 rounded-lg px-4 py-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">${loadingMsg}</span>
                            <div class="flex space-x-1">
                                <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"></div>
                                <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                // Remove typing indicator
                document.getElementById(typingId)?.remove();

                if (data.error) {
                    messagesDiv.innerHTML += `
                        <div class="flex justify-start mb-3">
                            <div class="bg-red-100 text-red-700 rounded-lg px-4 py-2 max-w-xs">
                                Error: ${escapeHtml(data.error)}
                            </div>
                        </div>
                    `;
                } else {
                    // Format the response with markdown-like formatting
                    let formattedResponse = escapeHtml(data.response || 'No response')
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded">$1</code>');

                    messagesDiv.innerHTML += `
                        <div class="flex justify-start mb-3">
                            <div class="bg-gray-200 rounded-lg px-4 py-2 max-w-sm text-sm">
                                ${formattedResponse}
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                document.getElementById(typingId)?.remove();
                messagesDiv.innerHTML += `
                    <div class="flex justify-start mb-3">
                        <div class="bg-red-100 text-red-700 rounded-lg px-4 py-2 max-w-xs">
                            Connection error. Please try again.
                        </div>
                    </div>
                `;
            }

            input.disabled = false;
            document.getElementById('jax-send-btn').disabled = false;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            input.focus();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle Enter key in Jax input
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('jax-input')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendJaxMessage();
                }
            });
        });

        // --- Init ---
        updateHeaderMarketBadge();
        loadDashboard();
    </script>

    <!-- Jax Chat Button and Panel -->
    <div id="jax-toggle-btn" onclick="toggleJax()" class="fixed bottom-20 right-4 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center cursor-pointer z-50 transition-all">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
    </div>

    <div id="jax-panel" class="hidden fixed bottom-36 right-4 w-80 sm:w-96 h-[450px] bg-white rounded-lg shadow-2xl flex-col z-50 border border-gray-200">
        <!-- Jax Header -->
        <div class="bg-blue-600 text-white px-4 py-3 rounded-t-lg flex items-center justify-between">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <span class="font-semibold">Jax</span>
            </div>
            <button onclick="toggleJax()" class="text-white hover:text-gray-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Jax Messages -->
        <div id="jax-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50">
            <div class="flex justify-start mb-3">
                <div class="bg-gray-200 rounded-lg px-4 py-2 max-w-sm text-sm">
                    Hey! I'm Jax. I can help you analyze store visits. Try asking:
                    <ul class="mt-2 ml-4 list-disc text-xs text-gray-600">
                        <li>"Give me a summary"</li>
                        <li>"Show visits for store 1234"</li>
                        <li>"What's the trend for store 5678?"</li>
                        <li>"Compare stores 1234 and 5678"</li>
                        <li>"Find stores with overstock issues"</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Jax Input -->
        <div class="p-3 border-t border-gray-200 bg-white rounded-b-lg">
            <div class="flex space-x-2">
                <input type="text" id="jax-input" placeholder="Ask Jax anything..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="jax-send-btn" onclick="sendJaxMessage()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Send
                </button>
            </div>
        </div>
    </div>
</body>
</html>
