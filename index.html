<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Manager Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'walmart-blue': '#0071CE',
                        'walmart-dark-blue': '#004C91',
                        'walmart-light-blue': '#78B9E7',
                        'walmart-yellow': '#FFC220',
                        'walmart-green': '#00A342',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    padding: {
                        'safe': 'env(safe-area-inset-bottom)',
                    }
                },
            },
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .hidden-view { display: none !important; }
        /* Notes module styles */
        .note-content { min-height: 200px; }
        .markdown-preview a { color: #0071ce; text-decoration: underline; }
        .markdown-preview h1 { font-size: 1.5rem; font-weight: bold; margin-top: 1rem; }
        .markdown-preview h2 { font-size: 1.25rem; font-weight: bold; margin-top: 0.75rem; }
        .markdown-preview h3 { font-size: 1.1rem; font-weight: bold; margin-top: 0.5rem; }
        .markdown-preview ul, .markdown-preview ol { margin-left: 1.5rem; margin-top: 0.5rem; }
        .markdown-preview ul { list-style-type: disc; }
        .markdown-preview ol { list-style-type: decimal; }
        .markdown-preview code { background: #f3f4f6; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-family: monospace; }
        .markdown-preview pre { background: #f3f4f6; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; }
        .markdown-preview blockquote { border-left: 4px solid #0071ce; padding-left: 1rem; margin: 0.5rem 0; color: #6b7280; }
        .wikilink { color: #0071ce; cursor: pointer; text-decoration: underline; }
        .wikilink.unresolved { color: #9ca3af; }
        .tag { color: #0071ce; cursor: pointer; }
        .task-checkbox { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 h-full">
    <!-- Top Header Bar -->
    <header class="fixed top-0 w-full bg-walmart-blue z-50 shadow-md">
        <div class="flex items-center justify-between px-4 h-14">
            <button id="menu-btn" class="text-white p-2">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 class="text-white text-lg font-semibold">Market Manager Tool</h1>
            <div class="flex items-center space-x-1">
                <span id="market-status-badge" class="text-white text-xs font-medium">All</span>
                <button onclick="openFeedbackModal()" class="text-white p-2" title="Submit Feedback"><i class="fas fa-comment text-lg"></i></button>
                <button onclick="openMarketModal()" class="text-white p-2" title="Select Market">
                    <i class="fas fa-user text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Side Drawer -->
    <div id="drawer-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50" onclick="closeDrawer()"></div>
    <div id="drawer" class="fixed top-0 left-0 h-full w-64 bg-white z-50 transform -translate-x-full transition-transform duration-300">
        <div class="bg-walmart-blue px-4 py-6">
            <h2 class="text-white text-xl font-bold">Market Manager Tool</h2>
        </div>
        <nav class="p-4">
            <button onclick="switchTab('home'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-home w-6 text-walmart-blue"></i><span class="ml-3">Dashboard</span>
            </button>
            <button onclick="switchTab('log-visit'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-camera w-6 text-walmart-blue"></i><span class="ml-3">Log Visit</span>
            </button>
            <button onclick="switchTab('visits'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-clipboard-list w-6 text-walmart-blue"></i><span class="ml-3">Visit Tracker</span>
            </button>
            <button onclick="switchTab('prior-tours'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-history w-6 text-walmart-blue"></i><span class="ml-3">Prior Visits</span>
            </button>
            <button onclick="switchTab('gold-stars'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-star w-6 text-yellow-500"></i><span class="ml-3">Gold Star Notes</span>
            </button>
            <button onclick="switchTab('champions'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-trophy w-6 text-walmart-blue"></i><span class="ml-3">Champions</span>
            </button>
            <button onclick="switchTab('mentees'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-user-friends w-6 text-walmart-blue"></i><span class="ml-3">Mentee Circle</span>
            </button>
            <button onclick="switchTab('enablers'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-lightbulb w-6 text-yellow-500"></i><span class="ml-3">Enablers</span>
            </button>
            <button onclick="switchTab('issues'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-clipboard-check w-6 text-walmart-blue"></i><span class="ml-3">Issues</span>
            </button>
            <hr class="my-4">
            <button onclick="switchTab('status'); closeDrawer();" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg flex items-center">
                <i class="fas fa-server w-6 text-walmart-blue"></i><span class="ml-3">Status</span>
            </button>
            <button class="w-full text-left px-4 py-3 text-gray-500 hover:bg-gray-100 rounded-lg flex items-center justify-between">
                <span>Settings</span><i class="fas fa-chevron-right text-sm"></i>
            </button>
        </nav>
    </div>

    <!-- Views Container -->
    <div id="main-content" class="h-full overflow-y-auto pt-14 pb-20">

        <!-- VIEW: HOME (Dashboard) -->
        <div id="view-home" class="p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Dashboard Summary</h2>
            </div>

            <!-- Metric Cards - 2x2 Grid -->
            <div class="grid grid-cols-2 gap-4" id="dashboard-cards">
                <!-- Red Stores Card -->
                <div class="bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterByRating('Red')">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-sm font-bold text-gray-900">Red Stores</h3>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </div>
                    <p id="red-stores-count" class="text-3xl font-bold text-red-600 mb-1">-</p>
                    <p class="text-xs text-gray-500">Immediate attention</p>
                </div>

                <!-- Yellow Stores Card -->
                <div class="bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterByRating('Yellow')">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-sm font-bold text-gray-900">Yellow Stores</h3>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </div>
                    <p id="yellow-stores-count" class="text-3xl font-bold text-yellow-500 mb-1">-</p>
                    <p class="text-xs text-gray-500">Needs review</p>
                </div>

                <!-- Green Stores Card -->
                <div class="bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="filterByRating('Green')">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-sm font-bold text-gray-900">Green Stores</h3>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </div>
                    <p id="green-stores-count" class="text-3xl font-bold text-green-600 mb-1">-</p>
                    <p class="text-xs text-gray-500">On track</p>
                </div>

                <!-- Outstanding Market Notes Card -->
                <div class="bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="switchTab('market-notes')">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-sm font-bold text-gray-900">Market Notes</h3>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </div>
                    <p id="market-notes-count" class="text-3xl font-bold text-walmart-blue mb-1">-</p>
                    <p class="text-xs text-gray-500">Outstanding items</p>
                </div>
            </div>
        </div>

        <!-- VIEW: LOG VISIT (Upload Form) -->
        <div id="view-log-visit" class="hidden-view flex flex-col items-center py-6 px-4">
            <div class="max-w-2xl w-full space-y-6 p-6 bg-white rounded-xl shadow-lg">
                <div class="text-center relative">
                    <button onclick="showManualVisitModal()" class="absolute right-0 top-0 w-10 h-10 bg-walmart-blue text-white rounded-full hover:bg-walmart-dark-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-walmart-blue" title="Add Manual Visit">
                        <i class="fas fa-plus"></i>
                    </button>
                    <h2 class="text-2xl font-bold text-gray-900">Log Store Visit</h2>
                    <p class="mt-2 text-sm text-gray-600">Upload a photo of your handwritten notes to automatically categorize them.</p>
                </div>

                <!-- File Upload Area -->
                <div class="space-y-4">
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-xl bg-gray-50">
                        <div class="space-y-3 text-center">
                            <button type="button" onclick="document.getElementById('camera-input').click()" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-walmart-blue hover:bg-walmart-dark-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-walmart-blue w-full justify-center">
                                <i class="fas fa-camera mr-2"></i> Take Photo
                            </button>
                            <input id="camera-input" type="file" accept="image/*" capture="environment" class="sr-only">

                            <div class="relative">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-gray-50 text-gray-500">Or</span>
                                </div>
                            </div>

                            <label for="image-upload" class="cursor-pointer text-walmart-blue hover:text-walmart-dark-blue font-medium">
                                <span>Upload from Gallery</span>
                                <input id="image-upload" type="file" class="sr-only" accept="image/*" multiple>
                            </label>
                            <p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
                        </div>
                    </div>

                    <!-- Preview Image -->
                    <div id="image-preview-container" class="hidden">
                        <p class="block text-sm font-medium text-gray-700">Preview:</p>
                        <div id="image-previews-grid" class="grid grid-cols-3 gap-2 mt-2"></div>
                    </div>

                    <button id="analyze-button" class="w-full py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-walmart-blue hover:bg-walmart-dark-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-walmart-blue disabled:bg-gray-400">
                        Analyze Notes
                    </button>
                </div>

                <!-- Loading Spinner -->
                <div id="loading-spinner" class="hidden text-center py-6">
                    <svg class="animate-spin h-10 w-10 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-3 text-sm text-gray-600">Analyzing with Gemini...</p>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="hidden p-4 bg-red-100 text-red-700 rounded-lg">
                    <p><strong>Error:</strong> <span id="error-text"></span></p>
                </div>

                <!-- Duplicate Warning Modal -->
                <div id="duplicate-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-96 shadow-lg rounded-xl bg-white">
                        <div class="mt-3">
                            <div class="flex items-center justify-center w-12 h-12 mx-auto bg-yellow-100 rounded-full">
                                <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 text-center mt-4">Potential Duplicate</h3>
                            <div class="mt-4 px-4 py-3 bg-yellow-50 rounded-lg">
                                <p class="text-sm text-gray-700 mb-2">An entry for this store and date already exists:</p>
                                <div id="duplicate-details" class="text-sm font-mono text-gray-800"></div>
                            </div>
                            <p class="text-sm text-gray-600 text-center mt-4">Submit this entry anyway?</p>
                            <div class="flex gap-4 mt-4">
                                <button id="duplicate-cancel-btn" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300">Cancel</button>
                                <button id="duplicate-submit-btn" class="flex-1 px-4 py-2 bg-walmart-blue text-white font-medium rounded-lg hover:bg-walmart-dark-blue">Submit Anyway</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Visit Modal -->
                <div id="manual-visit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-96 shadow-lg rounded-xl bg-white max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-900">Manual Visit Entry</h3>
                            <button onclick="hideManualVisitModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <!-- Date -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Visit Date</label>
                                <input type="date" id="manual-visit-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-walmart-blue focus:border-walmart-blue">
                            </div>

                            <!-- Store Number -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Store Number</label>
                                <select id="manual-visit-store" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-walmart-blue focus:border-walmart-blue">
                                    <option value="">Select Store...</option>
                                </select>
                            </div>

                            <!-- Rating -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Store Rating</label>
                                <select id="manual-visit-rating" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-walmart-blue focus:border-walmart-blue">
                                    <option value="">Select Rating...</option>
                                    <option value="Green">Green</option>
                                    <option value="Yellow">Yellow</option>
                                    <option value="Red">Red</option>
                                </select>
                            </div>

                            <!-- Photos -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tour Photos</label>
                                <div class="flex gap-2 mb-2">
                                    <button type="button" onclick="document.getElementById('manual-photo-camera').click()" class="flex-1 py-2 px-3 bg-walmart-blue text-white text-sm rounded-lg hover:bg-walmart-dark-blue">
                                        <i class="fas fa-camera mr-1"></i> Camera
                                    </button>
                                    <button type="button" onclick="document.getElementById('manual-photo-gallery').click()" class="flex-1 py-2 px-3 border border-walmart-blue text-walmart-blue text-sm rounded-lg hover:bg-walmart-blue hover:text-white">
                                        <i class="fas fa-folder-open mr-1"></i> Gallery
                                    </button>
                                    <input id="manual-photo-camera" type="file" accept="image/*" capture="environment" class="hidden" onchange="addManualPhoto(this)">
                                    <input id="manual-photo-gallery" type="file" accept="image/*" multiple class="hidden" onchange="addManualPhotos(this)">
                                </div>
                                <div id="manual-photos-grid" class="grid grid-cols-3 gap-2">
                                    <p class="col-span-3 text-center text-gray-400 text-sm py-2">No photos added</p>
                                </div>
                            </div>

                            <!-- Optional Notes -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                                <textarea id="manual-visit-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-walmart-blue focus:border-walmart-blue" placeholder="Any additional notes..."></textarea>
                            </div>

                            <!-- Save Button -->
                            <button id="manual-visit-save-btn" onclick="saveManualVisit()" class="w-full py-3 px-4 bg-walmart-blue text-white font-medium rounded-lg hover:bg-walmart-dark-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-walmart-blue">
                                <i class="fas fa-save mr-2"></i>Save Visit
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-container" class="hidden space-y-4">
                    <h3 class="text-xl font-bold text-gray-900">Analysis Results</h3>

                    <!-- Store Rating -->
                    <div class="bg-white border-2 p-4 rounded-xl text-center">
                        <h4 class="text-sm font-semibold text-gray-600 mb-2">Store Rating</h4>
                        <div id="result-rating" class="inline-flex items-center justify-center px-6 py-2 text-xl font-bold rounded-full"></div>
                    </div>

                    <!-- Date and Store Number -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-walmart-blue">Tour Date</h4>
                            <p id="result-calendar-date" class="mt-1 text-lg font-bold text-gray-900"></p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-walmart-blue">Store Number</h4>
                            <p id="result-store-nbr" class="mt-1 text-lg font-bold text-gray-900"></p>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <h4 class="text-sm font-semibold text-gray-700">Store Notes</h4>
                        <p id="result-store-notes" class="mt-2 text-sm text-gray-700 whitespace-pre-wrap"></p>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-xl">
                        <h4 class="text-sm font-semibold text-purple-700">Market Notes</h4>
                        <p id="result-mkt-notes" class="mt-2 text-sm text-purple-700 whitespace-pre-wrap"></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-green-700">What's Good</h4>
                            <p id="result-good" class="mt-2 text-sm text-gray-700 whitespace-pre-wrap"></p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-yellow-700">Top 3 Opportunities</h4>
                            <p id="result-top-3" class="mt-2 text-sm text-gray-700 whitespace-pre-wrap"></p>
                        </div>
                    </div>

                    <!-- Metrics Section -->
                    <div id="result-metrics" class="space-y-3">
                        <!-- Sales Metrics -->
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-walmart-blue mb-3">ðŸ“Š Sales</h4>
                            <div class="grid grid-cols-3 gap-3 text-center">
                                <div>
                                    <p class="text-xs text-gray-500">Comp Y</p>
                                    <p id="metric-sales-comp-yest" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Comp WTD</p>
                                    <p id="metric-sales-comp-wtd" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Comp MTD</p>
                                    <p id="metric-sales-comp-mtd" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Index Y</p>
                                    <p id="metric-sales-index-yest" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Index WTD</p>
                                    <p id="metric-sales-index-wtd" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Index MTD</p>
                                    <p id="metric-sales-index-mtd" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                            </div>
                        </div>

                        <!-- Inventory Health Metrics -->
                        <div class="bg-green-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-green-700 mb-3">ðŸ“¦ Inventory Health</h4>
                            <div class="grid grid-cols-3 gap-3 text-center">
                                <div>
                                    <p class="text-xs text-gray-500">FTPR</p>
                                    <p id="metric-ftpr" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Presub</p>
                                    <p id="metric-presub" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">VizPick</p>
                                    <p id="metric-vizpick" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">VP Health</p>
                                    <p id="metric-vizpick-health" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Overstock</p>
                                    <p id="metric-overstock" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Picks</p>
                                    <p id="metric-picks" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Fashion</p>
                                    <p id="metric-fashion" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Topstock</p>
                                    <p id="metric-topstock-grocery" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Cases</p>
                                    <p id="metric-cases" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                            </div>
                        </div>

                        <!-- Basic Work Metrics -->
                        <div class="bg-orange-50 p-4 rounded-xl">
                            <h4 class="text-sm font-semibold text-orange-700 mb-3">ðŸ”§ Basic Work</h4>
                            <div class="grid grid-cols-3 gap-3 text-center">
                                <div>
                                    <p class="text-xs text-gray-500">Modflex</p>
                                    <p id="metric-modflex" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Tag Errors</p>
                                    <p id="metric-tag-errors" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Mods</p>
                                    <p id="metric-mods" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">PCS</p>
                                    <p id="metric-pcs" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Pinpoint</p>
                                    <p id="metric-pinpoint" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Locations</p>
                                    <p id="metric-locations" class="text-lg font-bold text-gray-900">--</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Visit Photos Section -->
                    <div id="visit-photos-section" class="hidden bg-gray-50 p-4 rounded-xl">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3"><i class="fas fa-images mr-2"></i>Tour Photos</h4>
                        <p class="text-xs text-gray-500 mb-3">Add photos from your store tour</p>

                        <!-- Photo Upload Area -->
                        <div id="photo-upload-area">
                            <div class="flex gap-2 mb-3">
                                <button type="button" onclick="document.getElementById('visit-photo-camera').click()" class="flex-1 py-2 px-3 bg-walmart-blue text-white text-sm rounded-lg hover:bg-walmart-dark-blue">
                                    <i class="fas fa-camera mr-1"></i> Camera
                                </button>
                                <button type="button" onclick="document.getElementById('visit-photo-gallery').click()" class="flex-1 py-2 px-3 border border-walmart-blue text-walmart-blue text-sm rounded-lg hover:bg-walmart-blue hover:text-white">
                                    <i class="fas fa-folder-open mr-1"></i> Gallery
                                </button>
                                <input id="visit-photo-camera" type="file" accept="image/*" capture="environment" class="hidden" onchange="addVisitPhoto(this)">
                                <input id="visit-photo-gallery" type="file" accept="image/*" multiple class="hidden" onchange="addVisitPhotos(this)">
                            </div>
                            <div id="photo-upload-progress" class="hidden text-center py-2">
                                <i class="fas fa-spinner fa-spin text-walmart-blue"></i>
                                <span class="text-sm text-gray-600 ml-2">Uploading...</span>
                            </div>
                        </div>

                        <!-- Photo Grid -->
                        <div id="visit-photos-grid" class="grid grid-cols-3 gap-2">
                            <p class="col-span-3 text-center text-gray-400 text-sm py-4">No photos yet</p>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button id="reanalyze-button" onclick="reanalyzeNotes()" class="flex-1 py-3 px-4 border-2 border-walmart-blue text-walmart-blue text-sm font-medium rounded-lg hover:bg-walmart-blue hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-walmart-blue transition-colors">
                            <i class="fas fa-redo mr-2"></i>Re-Analyze
                        </button>
                        <button id="save-visit-button" onclick="manualSaveVisit()" class="flex-1 py-3 px-4 bg-walmart-blue text-white text-sm font-medium rounded-lg hover:bg-walmart-dark-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-walmart-blue transition-colors">
                            <i class="fas fa-save mr-2"></i>Save Visit
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: VISITS (Visit Tracker) -->
        <div id="view-visits" class="hidden-view p-4 bg-gray-100 min-h-full">
            <!-- Active Rating Filter Badge -->
            <div id="rating-filter-badge" class="hidden mb-3">
                <div class="inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium">
                    <span>Showing:</span>
                    <span id="rating-filter-label" class="px-2 py-1 rounded-full text-xs font-bold"></span>
                    <button onclick="clearRatingFilter()" class="ml-1 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>

            <!-- Store Summary - Last Visit per Store -->
            <div class="mb-4">
                <h3 class="text-sm font-semibold text-gray-600 uppercase mb-2">Store Status</h3>
                <div id="store-summary-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                    <div class="text-center text-gray-400 text-sm py-4 col-span-full">Loading...</div>
                </div>
            </div>

            <!-- Store Filter Dropdown -->
            <div class="mb-4">
                <button id="store-filter-btn" class="w-full bg-white px-4 py-3 rounded-lg shadow flex items-center justify-between">
                    <span id="store-filter-text" class="text-gray-900 font-medium">All Stores</span>
                    <i class="fas fa-chevron-down text-walmart-blue"></i>
                </button>
                <div id="store-filter-dropdown" class="hidden absolute left-4 right-4 mt-1 bg-white rounded-lg shadow-lg z-40 max-h-64 overflow-y-auto">
                    <!-- Options will be inserted by JS -->
                </div>
            </div>

            <!-- Table Header -->
            <div class="bg-white rounded-t-lg shadow-sm">
                <div class="grid grid-cols-12 gap-2 px-4 py-3 text-xs font-bold text-gray-600 uppercase border-b">
                    <div class="col-span-2 cursor-pointer flex items-center" onclick="sortVisits('store')">
                        Store# <i id="sort-store-icon" class="fas fa-sort ml-1 text-gray-400"></i>
                    </div>
                    <div class="col-span-2 cursor-pointer flex items-center" onclick="sortVisits('date')">
                        Date <i id="sort-date-icon" class="fas fa-sort ml-1 text-gray-400"></i>
                    </div>
                    <div class="col-span-2 cursor-pointer flex items-center" onclick="sortVisits('rating')">
                        Rating <i id="sort-rating-icon" class="fas fa-sort ml-1 text-gray-400"></i>
                    </div>
                    <div class="col-span-2 text-center">
                        Notes Received
                    </div>
                    <div class="col-span-4">Top 3 Notes</div>
                </div>
            </div>

            <!-- Table Body -->
            <div id="visits-table-body" class="bg-white rounded-b-lg shadow-sm divide-y divide-gray-100">
                <div class="p-8 text-center text-gray-500">Loading visits...</div>
            </div>
        </div>

        <!-- VIEW: PRIOR TOURS (Prior Visits) -->
        <div id="view-prior-tours" class="hidden-view p-4 bg-gray-100 min-h-full">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Prior Visits</h2>

            <!-- Search Section -->
            <div class="bg-white p-4 rounded-xl shadow-md mb-4">
                <label for="prior-store-nbr" class="block text-sm font-medium text-gray-700 mb-2">Enter Store Number</label>
                <div class="flex gap-2">
                    <input type="text" id="prior-store-nbr" placeholder="e.g. 1234" class="flex-1 rounded-lg border border-gray-300 px-4 py-2 text-gray-900 focus:border-walmart-blue focus:ring-walmart-blue">
                    <button id="btn-search-prior" class="bg-walmart-blue text-white px-6 py-2 rounded-lg hover:bg-walmart-dark-blue font-medium">
                        Get Prior Visit Summary
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="prior-results" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>
                    <p>Enter a store number to see the prior visit summary.</p>
                </div>
            </div>
        </div>

        <!-- VIEW: MARKET NOTES (To-Do List) -->
        <div id="view-market-notes" class="hidden-view p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Market Notes</h2>
                <span id="market-notes-progress" class="text-sm text-gray-500"></span>
            </div>

            <!-- Filter by Store -->
            <div class="mb-4">
                <button id="market-store-filter-btn" class="w-full bg-white px-4 py-3 rounded-lg shadow flex items-center justify-between">
                    <span id="market-store-filter-text" class="text-gray-900 font-medium">All Stores</span>
                    <i class="fas fa-chevron-down text-walmart-blue"></i>
                </button>
                <div id="market-store-filter-dropdown" class="hidden absolute left-4 right-4 mt-1 bg-white rounded-lg shadow-lg z-40 max-h-64 overflow-y-auto">
                    <!-- Options will be inserted by JS -->
                </div>
            </div>

            <!-- Market Notes List (Outstanding) -->
            <div id="market-notes-list" class="space-y-3">
                <div class="text-center py-8">
                    <svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-3 text-gray-500">Loading market notes...</p>
                </div>
            </div>

            <!-- Completed Section (Collapsible) -->
            <div id="completed-section" class="hidden mt-6">
                <button onclick="toggleCompletedSection()" class="w-full bg-gray-200 hover:bg-gray-300 rounded-lg px-4 py-3 flex items-center justify-between transition-colors">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span class="font-medium text-gray-700">Completed</span>
                        <span id="completed-count-badge" class="bg-green-100 text-green-700 text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <i id="completed-chevron" class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                </button>
                <div id="completed-notes-container" class="hidden mt-3 space-y-3">
                    <!-- Completed notes will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Market Note Detail Modal -->
        <div id="market-note-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center sm:justify-center">
            <div class="bg-white w-full sm:max-w-lg sm:rounded-xl rounded-t-2xl max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 flex justify-between items-center p-4 border-b border-gray-200 bg-white">
                    <h2 class="text-lg font-bold text-gray-900">Market Note Details</h2>
                    <button onclick="closeMarketNoteModal()" class="text-gray-400 hover:text-gray-600 p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="p-4 space-y-4">
                    <!-- Store & Date -->
                    <div class="flex justify-between items-center">
                        <span id="mkt-note-store" class="text-lg font-bold text-walmart-blue"></span>
                        <span id="mkt-note-date" class="text-sm text-gray-500"></span>
                    </div>

                    <!-- Note Text -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p id="mkt-note-text" class="text-gray-800"></p>
                    </div>

                    <!-- Status -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                        <div class="grid grid-cols-4 gap-2">
                            <button onclick="setMarketNoteStatus('new')" class="mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors" data-status="new">
                                New
                            </button>
                            <button onclick="setMarketNoteStatus('in_progress')" class="mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors" data-status="in_progress">
                                In Progress
                            </button>
                            <button onclick="setMarketNoteStatus('on_hold')" class="mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors" data-status="on_hold">
                                On Hold
                            </button>
                            <button onclick="setMarketNoteStatus('completed')" class="mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors" data-status="completed">
                                Done
                            </button>
                        </div>
                    </div>

                    <!-- Assigned To -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Assigned To</label>
                        <input type="text" id="mkt-note-assigned" placeholder="Enter name..."
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-walmart-blue focus:border-transparent"
                               onchange="saveMarketNoteAssignment()">
                    </div>

                    <!-- Updates Section -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Updates</label>
                        <div id="mkt-note-updates" class="space-y-2 mb-3 max-h-48 overflow-y-auto">
                            <!-- Updates will be inserted here -->
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="mkt-note-new-update" placeholder="Add an update..."
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-walmart-blue focus:border-transparent text-sm">
                            <button onclick="addMarketNoteUpdate()" class="bg-walmart-blue text-white px-4 py-2 rounded-lg hover:bg-walmart-dark-blue transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: GOLD STAR NOTES -->
        <div id="view-gold-stars" class="hidden-view p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Gold Star Notes</h2>
                <div class="flex items-center gap-2">
                    <button onclick="changeGoldStarWeek(-1)" id="gold-star-prev-week" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-600">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div id="gold-star-week" class="text-center text-sm min-w-[100px]"></div>
                    <button onclick="changeGoldStarWeek(1)" id="gold-star-next-week" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-600">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Define This Week's Notes -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-star text-yellow-500 mr-2"></i>This Week's Gold Stars
                    </h3>
                    <button onclick="toggleGoldStarEdit()" id="gold-star-edit-btn" class="text-sm text-walmart-blue hover:text-walmart-dark-blue">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>

                <!-- Display Mode -->
                <div id="gold-star-display" class="space-y-2">
                    <div class="flex items-start gap-2">
                        <span class="bg-yellow-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold flex-shrink-0">1</span>
                        <p id="display-note-1" class="text-gray-700">-</p>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="bg-yellow-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold flex-shrink-0">2</span>
                        <p id="display-note-2" class="text-gray-700">-</p>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="bg-yellow-400 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold flex-shrink-0">3</span>
                        <p id="display-note-3" class="text-gray-700">-</p>
                    </div>
                </div>

                <!-- Edit Mode -->
                <div id="gold-star-edit" class="hidden space-y-3">
                    <div>
                        <label class="text-sm text-gray-600">Gold Star #1</label>
                        <input type="text" id="edit-note-1" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Enter first gold star note">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Gold Star #2</label>
                        <input type="text" id="edit-note-2" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Enter second gold star note">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Gold Star #3</label>
                        <input type="text" id="edit-note-3" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Enter third gold star note">
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="cancelGoldStarEdit()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button onclick="saveGoldStarNotes()" class="flex-1 px-4 py-2 bg-walmart-blue text-white rounded-lg hover:bg-walmart-dark-blue">Save Notes</button>
                    </div>
                </div>

                <!-- No notes defined message -->
                <div id="gold-star-empty" class="hidden text-center py-4">
                    <i class="fas fa-star text-gray-300 text-3xl mb-2"></i>
                    <p class="text-gray-500">No gold star notes defined for this week.</p>
                    <button onclick="toggleGoldStarEdit()" class="mt-2 text-walmart-blue hover:text-walmart-dark-blue font-medium">
                        <i class="fas fa-plus"></i> Add Notes
                    </button>
                </div>
            </div>

            <!-- Progress Summary -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-semibold text-gray-800 mb-3">Completion Progress</h3>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p id="gold-progress-1" class="text-2xl font-bold text-walmart-blue">0/0</p>
                        <p class="text-xs text-gray-500">Star #1</p>
                    </div>
                    <div>
                        <p id="gold-progress-2" class="text-2xl font-bold text-walmart-blue">0/0</p>
                        <p class="text-xs text-gray-500">Star #2</p>
                    </div>
                    <div>
                        <p id="gold-progress-3" class="text-2xl font-bold text-walmart-blue">0/0</p>
                        <p class="text-xs text-gray-500">Star #3</p>
                    </div>
                </div>
            </div>

            <!-- Store Checklist -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="bg-walmart-blue px-4 py-3">
                    <h3 class="text-white font-semibold">Store Checklist</h3>
                </div>
                <!-- Table Header -->
                <div class="grid grid-cols-12 gap-2 px-4 py-2 text-xs font-bold text-gray-600 uppercase border-b bg-gray-50">
                    <div class="col-span-3">Store</div>
                    <div class="col-span-3 text-center">Star 1</div>
                    <div class="col-span-3 text-center">Star 2</div>
                    <div class="col-span-3 text-center">Star 3</div>
                </div>
                <!-- Store Rows -->
                <div id="gold-star-stores" class="divide-y divide-gray-100">
                    <div class="p-8 text-center text-gray-500">Loading stores...</div>
                </div>
            </div>
        </div>

        <!-- VIEW: CHAMPIONS -->
        <div id="view-champions" class="hidden-view p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Champions</h2>
                <button onclick="showAddChampionForm()" class="bg-walmart-blue text-white px-4 py-2 rounded-lg hover:bg-walmart-dark-blue text-sm font-medium">
                    <i class="fas fa-plus mr-1"></i> Add
                </button>
            </div>

            <!-- Add/Edit Champion Form -->
            <div id="champion-form" class="hidden bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 id="champion-form-title" class="font-semibold text-gray-800 mb-3">Add Champion</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm text-gray-600">Name</label>
                        <input type="text" id="champion-name" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="e.g., Tim">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Champion Of</label>
                        <input type="text" id="champion-responsibility" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="e.g., My Local Social">
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="hideChampionForm()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button onclick="saveChampion()" class="flex-1 px-4 py-2 bg-walmart-blue text-white rounded-lg hover:bg-walmart-dark-blue">Save</button>
                    </div>
                </div>
                <input type="hidden" id="champion-edit-id" value="">
            </div>

            <!-- Champions List -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="bg-walmart-blue px-4 py-3 grid grid-cols-12 gap-2 text-white font-semibold text-sm">
                    <div class="col-span-4">Name</div>
                    <div class="col-span-6">Champion Of</div>
                    <div class="col-span-2 text-center">Actions</div>
                </div>
                <div id="champions-list" class="divide-y divide-gray-100">
                    <div class="p-8 text-center text-gray-500">Loading...</div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="champions-empty" class="hidden text-center py-12 bg-white rounded-xl mt-4">
                <i class="fas fa-trophy text-5xl text-gray-300 mb-4"></i>
                <p class="text-gray-600 font-medium">No champions yet</p>
                <p class="text-gray-400 text-sm mt-1">Add your first champion to get started</p>
            </div>
        </div>

        <!-- VIEW: MENTEE CIRCLE -->
        <div id="view-mentees" class="hidden-view p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Mentee Circle</h2>
                <button onclick="showAddMenteeForm()" class="bg-walmart-blue text-white px-4 py-2 rounded-lg hover:bg-walmart-dark-blue text-sm font-medium">
                    <i class="fas fa-plus mr-1"></i> Add
                </button>
            </div>

            <!-- Add/Edit Mentee Form -->
            <div id="mentee-form" class="hidden bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 id="mentee-form-title" class="font-semibold text-gray-800 mb-3">Add Mentee</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm text-gray-600">Name</label>
                        <input type="text" id="mentee-name" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Associate Name">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Store Number</label>
                        <input type="text" id="mentee-store" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Store #">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Position</label>
                        <input type="text" id="mentee-position" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Position">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Cell Number</label>
                        <input type="text" id="mentee-cell" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Cell Number">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Notes</label>
                        <textarea id="mentee-notes" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Additional notes..."></textarea>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="hideMenteeForm()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button onclick="saveMentee()" class="flex-1 px-4 py-2 bg-walmart-blue text-white rounded-lg hover:bg-walmart-dark-blue">Save</button>
                    </div>
                </div>
                <input type="hidden" id="mentee-edit-id" value="">
            </div>

            <!-- Mentees List -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="bg-walmart-blue px-4 py-3 grid grid-cols-12 gap-2 text-white font-semibold text-sm">
                    <div class="col-span-4">Name</div>
                    <div class="col-span-2">Store</div>
                    <div class="col-span-4">Position</div>
                    <div class="col-span-2 text-center">Actions</div>
                </div>
                <div id="mentees-list" class="divide-y divide-gray-100">
                    <div class="p-8 text-center text-gray-500">Loading...</div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="mentees-empty" class="hidden text-center py-12 bg-white rounded-xl mt-4">
                <i class="fas fa-user-friends text-5xl text-gray-300 mb-4"></i>
                <p class="text-gray-600 font-medium">No mentees yet</p>
                <p class="text-gray-400 text-sm mt-1">Add your first mentee to the circle</p>
            </div>
        </div>

        <!-- VIEW: ENABLERS -->
        <div id="view-enablers" class="hidden-view p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Enablers</h2>
                <button onclick="showAddEnablerForm()" class="bg-walmart-blue text-white px-4 py-2 rounded-lg hover:bg-walmart-dark-blue text-sm font-medium">
                    <i class="fas fa-plus mr-1"></i> Add
                </button>
            </div>

            <!-- Filter Tabs -->
            <div class="flex flex-wrap gap-2 mb-4">
                <div class="flex gap-1 bg-white rounded-lg p-1 shadow-sm">
                    <button onclick="filterEnablersByView('all')" id="enabler-view-all" class="enabler-view-btn px-3 py-1 rounded text-sm font-medium bg-walmart-blue text-white">All</button>
                    <button onclick="filterEnablersByView('week')" id="enabler-view-week" class="enabler-view-btn px-3 py-1 rounded text-sm font-medium text-gray-600 hover:bg-gray-100">This Week</button>
                    <button onclick="filterEnablersByView('planned')" id="enabler-view-planned" class="enabler-view-btn px-3 py-1 rounded text-sm font-medium text-gray-600 hover:bg-gray-100">Planned</button>
                </div>
                <div class="flex gap-1 bg-white rounded-lg p-1 shadow-sm">
                    <button onclick="filterEnablersByStatus('all')" id="enabler-status-all" class="enabler-status-btn px-3 py-1 rounded text-sm font-medium bg-gray-200 text-gray-800">All Status</button>
                    <button onclick="filterEnablersByStatus('idea')" id="enabler-status-idea" class="enabler-status-btn px-3 py-1 rounded text-sm font-medium text-gray-600 hover:bg-gray-100">Ideas</button>
                    <button onclick="filterEnablersByStatus('slide_made')" id="enabler-status-slide_made" class="enabler-status-btn px-3 py-1 rounded text-sm font-medium text-gray-600 hover:bg-gray-100">Slides Made</button>
                    <button onclick="filterEnablersByStatus('presented')" id="enabler-status-presented" class="enabler-status-btn px-3 py-1 rounded text-sm font-medium text-gray-600 hover:bg-gray-100">Presented</button>
                </div>
            </div>

            <!-- Add/Edit Enabler Form -->
            <div id="enabler-form" class="hidden bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 id="enabler-form-title" class="font-semibold text-gray-800 mb-3">Add Enabler</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm text-gray-600">Title <span class="text-red-500">*</span></label>
                        <input type="text" id="enabler-title" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Enabler title">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Description</label>
                        <textarea id="enabler-description" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Describe the enabler..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm text-gray-600">Source</label>
                            <input type="text" id="enabler-source" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="e.g., Store 1234, Self">
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">Status</label>
                            <select id="enabler-status" class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:border-walmart-blue focus:ring-walmart-blue">
                                <option value="idea">Idea</option>
                                <option value="slide_made">Slide Made</option>
                                <option value="presented">Presented</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Walmart Week Number</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="number" id="enabler-week" min="1" max="53" class="w-24 border border-gray-300 rounded-lg px-3 py-2 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="Week #">
                            <span id="enabler-current-week-hint" class="text-sm text-gray-500"></span>
                        </div>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="hideEnablerForm()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button onclick="saveEnabler()" class="flex-1 px-4 py-2 bg-walmart-blue text-white rounded-lg hover:bg-walmart-dark-blue">Save</button>
                    </div>
                </div>
                <input type="hidden" id="enabler-edit-id" value="">
            </div>

            <!-- Enablers List -->
            <div id="enablers-container">
                <div class="p-8 text-center text-gray-500">Loading...</div>
            </div>

            <!-- Empty State -->
            <div id="enablers-empty" class="hidden text-center py-12 bg-white rounded-xl">
                <i class="fas fa-lightbulb text-5xl text-gray-300 mb-4"></i>
                <p class="text-gray-600 font-medium">No enablers yet</p>
                <p class="text-gray-400 text-sm mt-1">Add your first enabler to get started</p>
            </div>
        </div>

        <!-- VIEW: STATUS -->
        <div id="view-status" class="hidden-view p-4 bg-gray-100 min-h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">System Status</h2>
                <button onclick="loadStatus()" class="text-walmart-blue hover:text-walmart-dark-blue">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <!-- Server Status -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-server text-walmart-blue mr-2"></i>Server
                </h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Status</span>
                        <span id="status-server-status" class="px-2 py-1 rounded-full text-xs font-bold bg-gray-100">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Environment</span>
                        <span id="status-server-env" class="text-gray-900">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Version</span>
                        <span id="status-server-version" class="text-gray-900">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Last Check</span>
                        <span id="status-server-timestamp" class="text-gray-500 text-sm">--</span>
                    </div>
                </div>
            </div>

            <!-- Database Status -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-database text-walmart-blue mr-2"></i>Database
                </h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Status</span>
                        <span id="status-db-status" class="px-2 py-1 rounded-full text-xs font-bold bg-gray-100">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Host</span>
                        <span id="status-db-host" class="text-gray-900 text-sm font-mono">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Database</span>
                        <span id="status-db-name" class="text-gray-900">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Latency</span>
                        <span id="status-db-latency" class="text-gray-900">--</span>
                    </div>
                </div>
            </div>

            <!-- Vertex AI Status -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-brain text-walmart-blue mr-2"></i>Vertex AI
                </h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Status</span>
                        <span id="status-ai-status" class="px-2 py-1 rounded-full text-xs font-bold bg-gray-100">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Project</span>
                        <span id="status-ai-project" class="text-gray-900 text-sm">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Location</span>
                        <span id="status-ai-location" class="text-gray-900">--</span>
                    </div>
                </div>
            </div>

            <!-- Network Test -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-network-wired text-walmart-blue mr-2"></i>Connection Test
                </h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">API Response Time</span>
                        <span id="status-api-latency" class="text-gray-900">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Connection</span>
                        <span id="status-connection" class="px-2 py-1 rounded-full text-xs font-bold bg-gray-100">--</span>
                    </div>
                </div>
            </div>

            <!-- Available Endpoints -->
            <div class="bg-white rounded-xl shadow-sm p-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-plug text-walmart-blue mr-2"></i>API Endpoints
                </h3>
                <div id="status-endpoints" class="space-y-2 text-sm">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
        </div>

        <!-- VIEW: ISSUES -->
        <div id="view-issues" class="hidden-view p-4 bg-gray-100 min-h-full transition-transform duration-200"
             ontouchstart="handlePullToRefreshStart(event)"
             ontouchmove="handlePullToRefreshMove(event)"
             ontouchend="handlePullToRefreshEnd(event)">
            
            <!-- Pull to Refresh Indicator -->
            <div id="pull-refresh-indicator" class="fixed top-14 left-0 right-0 flex justify-center pointer-events-none transition-all duration-200 opacity-0 -translate-y-10 z-40">
                <div class="bg-white rounded-full p-2 shadow-lg border border-gray-200">
                    <i id="pull-refresh-icon" class="fas fa-arrow-down text-walmart-blue transition-transform duration-200"></i>
                </div>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Issues & Feedback</h2>
                <button onclick="openFeedbackModal()" class="bg-walmart-blue text-white px-4 py-2 rounded-lg hover:bg-walmart-dark-blue text-sm font-medium">
                    <i class="fas fa-plus mr-1"></i> New
                </button>
            </div>

            <!-- Filter Tabs -->
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button onclick="filterIssues('all')" id="filter-all" class="issue-filter-btn px-4 py-2 rounded-full text-sm font-medium bg-walmart-blue text-white">
                    All
                </button>
                <button onclick="filterIssues('feature')" id="filter-feature" class="issue-filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                    <i class="fas fa-lightbulb mr-1"></i> Features
                </button>
                <button onclick="filterIssues('bug')" id="filter-bug" class="issue-filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                    <i class="fas fa-bug mr-1"></i> Bugs
                </button>
                <button onclick="filterIssues('feedback')" id="filter-feedback" class="issue-filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                    <i class="fas fa-comment mr-1"></i> Feedback
                </button>
            </div>

            <!-- Active Issues List -->
            <div id="issues-list" class="space-y-3">
                <div class="text-center py-8">
                    <svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-3 text-gray-500">Loading issues...</p>
                </div>
            </div>

            <!-- Empty State -->
            <div id="issues-empty" class="hidden text-center py-12 bg-white rounded-xl">
                <i class="fas fa-clipboard-check text-5xl text-gray-300 mb-4"></i>
                <p class="text-gray-600 font-medium">No issues yet</p>
                <p class="text-gray-400 text-sm mt-1">Use the feedback button to submit your first item</p>
            </div>

            <!-- Completed Section (Collapsible) -->
            <div id="issues-completed-section" class="hidden mt-6">
                <button onclick="toggleCompletedIssues()" class="w-full bg-gray-200 hover:bg-gray-300 rounded-lg px-4 py-3 flex items-center justify-between transition-colors">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span class="font-medium text-gray-700">Completed</span>
                        <span id="issues-completed-count" class="bg-green-100 text-green-700 text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <i id="issues-completed-chevron" class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                </button>
                <div id="issues-completed-container" class="hidden mt-3 space-y-3">
                    <!-- Completed issues will be inserted here -->
                </div>
            </div>
        </div>

        <!-- VIEW: NOTES -->
        <div id="view-notes" class="hidden-view p-0 bg-gray-100 min-h-full">
            <!-- Notes Header with sub-navigation -->
            <header class="bg-walmart-blue text-white sticky top-0 z-30">
                <div class="flex items-center justify-between p-4">
                    <h1 class="text-lg font-semibold">Notes</h1>
                    <div class="flex space-x-2">
                        <button onclick="showNotesSearch()" class="p-2"><i class="fas fa-search"></i></button>
                        <button onclick="createNote()" class="p-2"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <!-- Sub-navigation tabs -->
                <div class="flex border-t border-blue-600">
                    <button onclick="switchNotesSubView('tasks')" class="notes-tab flex-1 py-2 text-sm font-medium text-center border-b-2 border-walmart-yellow" data-view="tasks">Tasks</button>
                    <button onclick="switchNotesSubView('market')" class="notes-tab flex-1 py-2 text-sm font-medium text-center border-b-2 border-transparent hover:border-walmart-yellow/50" data-view="market">Market</button>
                    <button onclick="switchNotesSubView('graph')" class="notes-tab flex-1 py-2 text-sm font-medium text-center border-b-2 border-transparent hover:border-walmart-yellow/50" data-view="graph">Insights</button>
                </div>
            </header>

            <!-- All Notes View -->
            <div id="notes-view-all-notes" class="p-4 hidden">
                <div id="folder-breadcrumb" class="mb-4 text-sm text-gray-600">
                    <span class="cursor-pointer hover:text-walmart-blue" onclick="navigateFolder('/')">/</span>
                </div>
                <div id="notes-list" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-sticky-note text-4xl mb-3 text-gray-300"></i>
                        <p>No notes yet</p>
                        <p class="text-sm mt-2">Tap + to create your first note</p>
                    </div>
                </div>
            </div>

            <!-- Market Notes View -->
            <div id="notes-view-market" class="p-4 hidden">
                <div class="mb-4 flex justify-between items-center">
                    <div class="flex space-x-2 overflow-x-auto">
                        <button onclick="filterNotesMarketNotes('all')" class="notes-market-filter px-3 py-1 rounded-full text-sm bg-walmart-blue text-white whitespace-nowrap" data-filter="all">All</button>
                        <button onclick="filterNotesMarketNotes('pending')" class="notes-market-filter px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 whitespace-nowrap" data-filter="pending">Pending</button>
                        <button onclick="filterNotesMarketNotes('completed')" class="notes-market-filter px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 whitespace-nowrap" data-filter="completed">Completed</button>
                    </div>
                    <button onclick="openSmartAddModal('market')" class="bg-walmart-blue text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg hover:bg-walmart-dark-blue">
                        <i class="fas fa-plus text-sm"></i>
                    </button>
                </div>
                <div id="notes-market-notes-list" class="space-y-2">
                    <p class="text-center text-gray-500 py-8">Loading market notes...</p>
                </div>
            </div>

            <!-- Tasks View -->
            <div id="notes-view-tasks" class="p-4">
                <div class="mb-4 flex justify-between items-center">
                    <div class="flex space-x-2">
                        <button onclick="filterNotesTasks('all')" class="notes-task-filter px-3 py-1 rounded-full text-sm bg-walmart-blue text-white" data-filter="all">All</button>
                        <button onclick="filterNotesTasks('today')" class="notes-task-filter px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter="today">Today</button>
                        <button onclick="filterNotesTasks('upcoming')" class="notes-task-filter px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter="upcoming">Upcoming</button>
                    </div>
                    <button onclick="openSmartAddModal('task')" class="bg-walmart-blue text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg hover:bg-walmart-dark-blue">
                        <i class="fas fa-plus text-sm"></i>
                    </button>
                </div>
                <div id="notes-tasks-list" class="space-y-2">
                    <p class="text-center text-gray-500 py-8">No tasks found</p>
                </div>
            </div>

            <!-- Daily Notes View (Removed) -->

            <!-- Graph View -->
            <div id="notes-view-graph" class="p-4 hidden overflow-y-auto" style="height: calc(100vh - 180px);">
                <!-- AI Insights Header -->
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800"><i class="fas fa-brain text-walmart-blue mr-2"></i>AI Insights</h2>
                    <button onclick="loadAIInsights()" id="refresh-insights-btn" class="px-3 py-1.5 bg-walmart-blue text-white rounded-lg text-sm hover:bg-walmart-dark-blue">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>

                <!-- Loading State -->
                <div id="insights-loading" class="hidden text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-walmart-blue mb-4"></i>
                    <p class="text-gray-600">Analyzing your notes with AI...</p>
                    <p class="text-sm text-gray-400 mt-2">This may take a few seconds</p>
                </div>

                <!-- Insights Content -->
                <div id="insights-content" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-brain text-4xl mb-3 text-gray-300"></i>
                        <p>Click Refresh to analyze your notes</p>
                        <p class="text-sm mt-2">AI will identify themes, patterns, and trends</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center sm:justify-center">
        <div class="bg-white w-full sm:max-w-md sm:rounded-xl rounded-t-2xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 flex justify-between items-center p-4 border-b border-gray-200 bg-white">
                <h2 class="text-xl font-bold text-gray-900">Submit Feedback</h2>
                <button onclick="closeFeedbackModal()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-4 space-y-4">
                <!-- Type Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="selectFeedbackType('feature')" id="type-feature" class="feedback-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-lightbulb text-2xl text-yellow-500 mb-1"></i>
                            <span class="text-xs font-medium">Feature</span>
                        </button>
                        <button type="button" onclick="selectFeedbackType('bug')" id="type-bug" class="feedback-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-bug text-2xl text-red-500 mb-1"></i>
                            <span class="text-xs font-medium">Bug</span>
                        </button>
                        <button type="button" onclick="selectFeedbackType('feedback')" id="type-feedback" class="feedback-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-comment text-2xl text-walmart-blue mb-1"></i>
                            <span class="text-xs font-medium">Feedback</span>
                        </button>
                    </div>
                </div>

                <!-- Title -->
                <div>
                    <label for="feedback-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="feedback-title" placeholder="Brief summary..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-walmart-blue focus:ring-walmart-blue">
                </div>

                <!-- Description -->
                <div>
                    <label for="feedback-description" class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
                    <textarea id="feedback-description" rows="4" placeholder="Provide more details..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-walmart-blue focus:ring-walmart-blue"></textarea>
                </div>

                <!-- Submit Button -->
                <button onclick="submitFeedback()" class="w-full bg-walmart-blue text-white py-3 rounded-lg font-medium hover:bg-walmart-dark-blue transition-colors">
                    Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Issue Modal -->
    <div id="edit-issue-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center sm:justify-center">
        <div class="bg-white w-full sm:max-w-md sm:rounded-xl rounded-t-2xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 flex justify-between items-center p-4 border-b border-gray-200 bg-white">
                <h2 class="text-xl font-bold text-gray-900">Edit Issue</h2>
                <button onclick="closeEditIssueModal()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-4 space-y-4">
                <input type="hidden" id="edit-issue-id">

                <!-- Type Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="selectEditIssueType('feature')" id="edit-type-feature" class="edit-issue-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-lightbulb text-2xl text-yellow-500 mb-1"></i>
                            <span class="text-xs font-medium">Feature</span>
                        </button>
                        <button type="button" onclick="selectEditIssueType('bug')" id="edit-type-bug" class="edit-issue-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-bug text-2xl text-red-500 mb-1"></i>
                            <span class="text-xs font-medium">Bug</span>
                        </button>
                        <button type="button" onclick="selectEditIssueType('feedback')" id="edit-type-feedback" class="edit-issue-type-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-200 hover:border-walmart-blue transition-colors">
                            <i class="fas fa-comment text-2xl text-walmart-blue mb-1"></i>
                            <span class="text-xs font-medium">Feedback</span>
                        </button>
                    </div>
                </div>

                <!-- Title -->
                <div>
                    <label for="edit-issue-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="edit-issue-title" placeholder="Brief summary..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-walmart-blue focus:ring-walmart-blue">
                </div>

                <!-- Description -->
                <div>
                    <label for="edit-issue-description" class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
                    <textarea id="edit-issue-description" rows="4" placeholder="Provide more details..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-walmart-blue focus:ring-walmart-blue"></textarea>
                </div>

                <!-- Save Button -->
                <button onclick="saveEditIssue()" class="w-full bg-walmart-blue text-white py-3 rounded-lg font-medium hover:bg-walmart-dark-blue transition-colors">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Market Selector Modal -->
    <div id="market-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center sm:justify-center">
        <div class="bg-white w-full sm:max-w-sm sm:rounded-xl rounded-t-2xl">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Select Market</h2>
                <button onclick="closeMarketModal()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-4 space-y-3">
                <button onclick="selectMarket('399')" id="market-btn-399" class="market-btn w-full p-4 rounded-xl border-2 border-gray-200 hover:border-walmart-blue transition-colors text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-lg text-gray-900">Market 399</p>
                            <p class="text-sm text-gray-500">10 stores</p>
                        </div>
                        <i class="fas fa-check-circle text-2xl text-gray-300" id="market-check-399"></i>
                    </div>
                </button>
                <button onclick="selectMarket('451')" id="market-btn-451" class="market-btn w-full p-4 rounded-xl border-2 border-gray-200 hover:border-walmart-blue transition-colors text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-lg text-gray-900">Market 451</p>
                            <p class="text-sm text-gray-500">9 stores</p>
                        </div>
                        <i class="fas fa-check-circle text-2xl text-gray-300" id="market-check-451"></i>
                    </div>
                </button>
                <button onclick="selectMarket('all')" id="market-btn-all" class="market-btn w-full p-4 rounded-xl border-2 border-gray-200 hover:border-walmart-blue transition-colors text-left">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-lg text-gray-900">All Markets</p>
                            <p class="text-sm text-gray-500">19 stores</p>
                        </div>
                        <i class="fas fa-check-circle text-2xl text-gray-300" id="market-check-all"></i>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Visit Detail Modal -->
    <div id="visit-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center sm:justify-center">
        <div class="bg-white w-full sm:max-w-2xl sm:rounded-xl rounded-t-2xl max-h-screen sm:max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 flex justify-between items-center p-4 border-b border-gray-200 bg-white">
                <h2 class="text-xl font-bold text-gray-900">Visit Details</h2>
                <div class="flex items-center gap-2">
                    <button onclick="deleteVisit()" class="text-red-400 hover:text-red-600 p-2" title="Delete Visit">
                        <i class="fas fa-trash-alt text-lg"></i>
                    </button>
                    <button onclick="closeVisitDetailModal()" class="text-gray-400 hover:text-gray-600 p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-4 space-y-4">
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Store</p>
                        <p id="modal-store-nbr" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Date</p>
                        <p id="modal-date" class="text-lg font-semibold text-gray-900">-</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Rating</p>
                        <div id="modal-rating" class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-gray-100">-</div>
                    </div>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2 flex items-center">
                        <i class="fas fa-sticky-note text-walmart-blue mr-2"></i>Store Notes
                    </h3>
                    <div id="modal-store-notes" class="bg-gray-50 rounded-lg p-4 text-sm text-gray-700">-</div>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2 flex items-center">
                        <i class="fas fa-globe text-walmart-blue mr-2"></i>Market Notes
                    </h3>
                    <div id="modal-mkt-notes" class="bg-gray-50 rounded-lg p-4 text-sm text-gray-700">-</div>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2 flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>What's Working Well
                    </h3>
                    <div id="modal-good" class="bg-green-50 rounded-lg p-4 text-sm text-gray-700">-</div>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2 flex items-center">
                        <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>Top 3 Opportunities
                    </h3>
                    <div id="modal-top3" class="bg-yellow-50 rounded-lg p-4 text-sm text-gray-700">-</div>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2 flex items-center">
                        <i class="fas fa-chart-bar text-walmart-blue mr-2"></i>Metrics
                    </h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3" id="modal-metrics"></div>
                </div>

                <div id="modal-photos-section" class="hidden">
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2 flex items-center">
                        <i class="fas fa-images text-walmart-blue mr-2"></i>Photos
                    </h3>
                    <div id="modal-photos-grid" class="grid grid-cols-3 gap-2"></div>
                </div>

                <div class="pt-4 border-t border-gray-200 text-xs text-gray-500">
                    <p>Recorded: <span id="modal-created-at">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Note Editor Modal -->
    <div id="note-editor-modal" class="fixed inset-0 bg-white z-50 hidden">
        <div class="flex flex-col h-full">
            <header class="bg-walmart-blue text-white px-4 py-3 flex items-center justify-between">
                <button onclick="closeNoteEditor()" class="p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <div class="flex space-x-2">
                    <button onclick="document.getElementById('note-photo-input').click()" class="px-3 py-1 rounded text-sm border border-white/50 hover:bg-white/10"><i class="fas fa-camera"></i></button>
                    <button onclick="toggleNotePreview()" id="preview-btn" class="px-3 py-1 rounded text-sm border border-white/50">Preview</button>
                    <button onclick="saveCurrentNote()" class="px-3 py-1 rounded text-sm bg-walmart-yellow text-walmart-dark-blue font-medium">Save</button>
                </div>
            </header>
            <input type="file" id="note-photo-input" accept="image/*" class="hidden" onchange="handleNotePhotoUpload(this)">
            <input type="text" id="note-title" placeholder="Note title" class="px-4 py-3 text-xl font-semibold border-b focus:outline-none focus:border-walmart-blue">
            <div class="px-4 py-2 border-b bg-gray-50 flex items-center space-x-3">
                <label class="text-sm text-gray-600">Store:</label>
                <select id="note-store-number" class="flex-1 border rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-walmart-blue">
                    <option value="">None (General)</option>
                </select>
            </div>
            <div class="flex-1 overflow-hidden">
                <textarea id="note-content" placeholder="Start writing...

Use [[Note Title]] for wikilinks
Use #tag for tags
Use - [ ] for tasks" class="w-full h-full p-4 resize-none focus:outline-none note-content"></textarea>
                <div id="note-preview" class="w-full h-full p-4 overflow-auto hidden markdown-preview"></div>
            </div>
            <div id="backlinks-section" class="border-t p-4 hidden">
                <h3 class="text-sm font-medium text-gray-500 mb-2">Linked mentions</h3>
                <div id="backlinks-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Notes Search Modal -->
    <div id="notes-search-modal" class="fixed inset-0 bg-white z-50 hidden">
        <header class="bg-walmart-blue text-white px-4 py-3 flex items-center space-x-3">
            <button onclick="hideNotesSearch()" class="p-2">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            <input type="text" id="notes-search-input" placeholder="Search notes..." class="flex-1 bg-walmart-dark-blue text-white placeholder-white/70 rounded-lg px-4 py-2 focus:outline-none">
        </header>
        <div id="notes-search-results" class="p-4">
            <p class="text-center text-gray-500">Type to search...</p>
        </div>
    </div>

    <!-- Notes Market Note Detail Modal -->
    <div id="notes-market-note-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <header class="bg-walmart-blue text-white px-4 py-3 flex items-center justify-between rounded-t-lg">
                <h2 class="font-semibold">Market Note Details</h2>
                <button onclick="closeNotesMarketNoteModal()" class="p-1"><i class="fas fa-times text-xl"></i></button>
            </header>
            <div class="p-4 space-y-4">
                <div class="text-sm text-gray-500">
                    <span id="nmnm-store" class="font-medium"></span>
                    <span id="nmnm-date" class="ml-2"></span>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p id="nmnm-note-text" class="text-gray-800"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setNotesMarketNoteStatus('new')" class="nmnm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="new">New</button>
                        <button onclick="setNotesMarketNoteStatus('in_progress')" class="nmnm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="in_progress">In Progress</button>
                        <button onclick="setNotesMarketNoteStatus('stalled')" class="nmnm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="stalled">Stalled</button>
                        <button onclick="setNotesMarketNoteStatus('completed')" class="nmnm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="completed">Completed</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Assigned To</label>
                    <input type="text" id="nmnm-assigned-to" placeholder="Enter name..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-walmart-blue">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                    <input type="date" id="nmnm-due-date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-walmart-blue">
                </div>
                <button onclick="saveNotesMarketNoteDetails()" class="w-full bg-walmart-blue text-white py-3 rounded-lg font-medium hover:bg-walmart-dark-blue">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Notes Task Detail Modal -->
    <div id="notes-task-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <header class="bg-walmart-blue text-white px-4 py-3 flex items-center justify-between rounded-t-lg">
                <h2 class="font-semibold">Task Details</h2>
                <button onclick="closeNotesTaskModal()" class="p-1"><i class="fas fa-times text-xl"></i></button>
            </header>
            <div class="p-4 space-y-4">
                <div class="text-sm text-gray-500">
                    <span>From: </span>
                    <span id="ntm-note-title" class="font-medium text-walmart-blue cursor-pointer hover:underline" onclick="openNoteFromTask()"></span>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p id="ntm-task-text" class="text-gray-800"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setNotesTaskStatus('new')" class="ntm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="new">New</button>
                        <button onclick="setNotesTaskStatus('in_progress')" class="ntm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="in_progress">In Progress</button>
                        <button onclick="setNotesTaskStatus('stalled')" class="ntm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="stalled">Stalled</button>
                        <button onclick="setNotesTaskStatus('completed')" class="ntm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="completed">Completed</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Assigned To</label>
                    <input type="text" id="ntm-assigned-to" placeholder="Enter name..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-walmart-blue">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                    <input type="date" id="ntm-due-date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-walmart-blue">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setNotesTaskPriority(0)" class="ntm-priority-btn px-3 py-2 rounded-lg text-sm border-2" data-priority="0">None</button>
                        <button onclick="setNotesTaskPriority(1)" class="ntm-priority-btn px-3 py-2 rounded-lg text-sm border-2" data-priority="1">Low</button>
                        <button onclick="setNotesTaskPriority(2)" class="ntm-priority-btn px-3 py-2 rounded-lg text-sm border-2" data-priority="2">Medium</button>
                        <button onclick="setNotesTaskPriority(3)" class="ntm-priority-btn px-3 py-2 rounded-lg text-sm border-2" data-priority="3">High</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Store</label>
                    <select id="ntm-store-number" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-walmart-blue">
                        <option value="">None (General)</option>
                    </select>
                </div>
                <button onclick="saveNotesTaskDetails()" class="w-full bg-walmart-blue text-white py-3 rounded-lg font-medium hover:bg-walmart-dark-blue">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Smart Add Modal -->
    <div id="smart-add-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-lg overflow-hidden">
            <div class="bg-walmart-blue px-4 py-3 flex justify-between items-center">
                <h3 class="text-white font-semibold flex items-center"><i class="fas fa-magic mr-2"></i>Smart Add</h3>
                <button onclick="closeSmartAddModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <p class="text-sm text-gray-600">Type your note naturally. AI will extract tasks, dates, priority, and assignments.</p>
                
                <textarea id="smart-add-content" rows="4" class="w-full border border-gray-300 rounded-lg p-3 focus:border-walmart-blue focus:ring-walmart-blue" placeholder="e.g. Remind Bob to check the dairy cooler by Friday, priority high"></textarea>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Store Context (Optional)</label>
                    <select id="smart-add-store" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        <option value="">None</option>
                    </select>
                </div>

                <div id="smart-add-preview" class="hidden bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Detected Tasks:</h4>
                    <div id="smart-add-tasks-list" class="space-y-2 text-sm"></div>
                </div>

                <div class="flex gap-2">
                    <button id="btn-process-ai" onclick="processSmartAdd()" class="flex-1 bg-walmart-blue text-white py-2 rounded-lg hover:bg-walmart-dark-blue font-medium">
                        <i class="fas fa-magic mr-1"></i> Process & Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 pb-safe z-40">
        <div class="grid grid-cols-4 h-16">
            <button onclick="switchTab('home')" class="nav-btn w-full h-full flex flex-col items-center justify-center space-y-1 text-walmart-blue focus:outline-none" data-target="view-home">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs font-medium">Home</span>
            </button>
            <button onclick="switchTab('log-visit')" class="nav-btn w-full h-full flex flex-col items-center justify-center space-y-1 text-gray-500 hover:text-walmart-blue focus:outline-none" data-target="view-log-visit">
                <i class="fas fa-camera text-xl"></i>
                <span class="text-xs font-medium">Log Visit</span>
            </button>
            <button onclick="switchTab('visits')" class="nav-btn w-full h-full flex flex-col items-center justify-center space-y-1 text-gray-500 hover:text-walmart-blue focus:outline-none" data-target="view-visits">
                <i class="fas fa-clipboard-list text-xl"></i>
                <span class="text-xs font-medium">Tracker</span>
            </button>
            <button onclick="switchTab('notes')" class="nav-btn w-full h-full flex flex-col items-center justify-center space-y-1 text-gray-500 hover:text-walmart-blue focus:outline-none" data-target="view-notes">
                <i class="fas fa-sticky-note text-xl"></i>
                <span class="text-xs font-medium">Notes</span>
            </button>
        </div>
    </nav>

    <script>
        // --- State ---
        let allVisits = [];
        let currentFilter = null;
        let currentRatingFilter = null;
        let currentSort = { column: null, ascending: true };
        let analysisImages = [];
        let currentParsedData = null;

        // --- Market Configuration ---
        const MARKET_STORES = {
            '399': ['1951', '2508', '2617', '2780', '2781', '2861', '2862', '3093', '3739', '5841'],
            '451': ['2002', '2117', '2280', '2458', '4488', '5435', '5751', '5766', '5884']
        };
        let currentMarket = localStorage.getItem('selectedMarket') || 'all';

        function getMarketStores() {
            if (currentMarket === 'all') {
                return [...MARKET_STORES['399'], ...MARKET_STORES['451']];
            }
            return MARKET_STORES[currentMarket] || [];
        }

        function isStoreInCurrentMarket(storeNbr) {
            if (currentMarket === 'all') return true;
            const stores = MARKET_STORES[currentMarket] || [];
            return stores.includes(String(storeNbr));
        }

        function openMarketModal() {
            updateMarketModalUI();
            document.getElementById('market-modal').classList.remove('hidden');
        }

        function closeMarketModal() {
            document.getElementById('market-modal').classList.add('hidden');
        }

        function updateMarketModalUI() {
            // Reset all buttons
            ['399', '451', 'all'].forEach(m => {
                const btn = document.getElementById(`market-btn-${m}`);
                const check = document.getElementById(`market-check-${m}`);
                if (currentMarket === m) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add('border-walmart-blue', 'bg-blue-50');
                    check.classList.remove('text-gray-300');
                    check.classList.add('text-walmart-blue');
                } else {
                    btn.classList.remove('border-walmart-blue', 'bg-blue-50');
                    btn.classList.add('border-gray-200');
                    check.classList.remove('text-walmart-blue');
                    check.classList.add('text-gray-300');
                }
            });
        }

        function selectMarket(market) {
            currentMarket = market;
            localStorage.setItem('selectedMarket', market);
            updateHeaderMarketBadge();
            closeMarketModal();
            // Reload current view data
            loadDashboard();
            if (!document.getElementById('view-visits').classList.contains('hidden-view')) loadVisits();
            if (!document.getElementById('view-market-notes').classList.contains('hidden-view')) loadMarketNotes();
            if (!document.getElementById('view-gold-stars').classList.contains('hidden-view')) loadGoldStars();
        }

        function updateHeaderMarketBadge() {
            const badge = document.getElementById('market-status-badge');
            if (currentMarket === 'all') {
                badge.textContent = 'All';
            } else {
                badge.textContent = 'Mkt ' + currentMarket;
            }
        }

        // Close market modal on outside click
        document.getElementById('market-modal').addEventListener('click', function(e) {
            if (e.target === this) closeMarketModal();
        });

        // --- Drawer ---
        function openDrawer() {
            document.getElementById('drawer').classList.remove('-translate-x-full');
            document.getElementById('drawer-overlay').classList.remove('hidden');
        }
        function closeDrawer() {
            document.getElementById('drawer').classList.add('-translate-x-full');
            document.getElementById('drawer-overlay').classList.add('hidden');
        }
        document.getElementById('menu-btn').addEventListener('click', openDrawer);

        // --- Navigation ---
        function switchTab(tabName) {
            ['view-home', 'view-log-visit', 'view-visits', 'view-prior-tours', 'view-market-notes', 'view-gold-stars', 'view-champions', 'view-mentees', 'view-enablers', 'view-status', 'view-issues', 'view-notes'].forEach(id => {
                document.getElementById(id).classList.add('hidden-view');
            });

            const targetId = 'view-' + tabName;
            document.getElementById(targetId).classList.remove('hidden-view');

            if (tabName === 'home') loadDashboard();
            if (tabName === 'visits') loadVisits();
            if (tabName === 'market-notes') loadMarketNotes();
            if (tabName === 'gold-stars') loadGoldStars();
            if (tabName === 'champions') loadChampions();
            if (tabName === 'mentees') loadMentees();
            if (tabName === 'enablers') loadEnablers();
            if (tabName === 'status') loadStatus();
            if (tabName === 'issues') loadIssues();
            if (tabName === 'notes') loadNotesView();

            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isTarget = btn.getAttribute('data-target') === targetId;
                btn.classList.toggle('text-walmart-blue', isTarget);
                btn.classList.toggle('text-gray-500', !isTarget);
            });
        }

        // --- Dashboard ---
        async function loadDashboard() {
            try {
                // Load visits for store ratings
                const visitsResponse = await fetch('/api/visits');
                if (!visitsResponse.ok) throw new Error('Failed to load visits');
                const allVisitsData = await visitsResponse.json();

                // Filter by current market
                const visits = allVisitsData.filter(v => isStoreInCurrentMarket(v.storeNbr));

                let red = 0, yellow = 0, green = 0;
                const stores = new Set();

                visits.forEach(v => {
                    if (!stores.has(v.storeNbr)) {
                        stores.add(v.storeNbr);
                        if (v.rating === 'Red') red++;
                        else if (v.rating === 'Yellow') yellow++;
                        else if (v.rating === 'Green') green++;
                    }
                });

                document.getElementById('red-stores-count').textContent = red;
                document.getElementById('yellow-stores-count').textContent = yellow;
                document.getElementById('green-stores-count').textContent = green;

                // Load market notes for outstanding count
                const notesResponse = await fetch('/api/market-notes');
                if (notesResponse.ok) {
                    const marketNotes = await notesResponse.json();
                    // Filter by current market
                    const filteredNotes = marketNotes.filter(n => isStoreInCurrentMarket(n.store_nbr));
                    const incompleteCount = filteredNotes.filter(n => !n.completed).length;
                    document.getElementById('market-notes-count').textContent = incompleteCount;
                }
            } catch (e) {
                console.error(e);
            }
        }

        // --- Visits ---
        async function loadVisits() {
            const tbody = document.getElementById('visits-table-body');
            const summaryGrid = document.getElementById('store-summary-grid');
            tbody.innerHTML = '<div class="p-8 text-center"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch('/api/visits');
                if (!response.ok) throw new Error('Failed');
                const allVisitsData = await response.json();

                // Filter by current market
                allVisits = allVisitsData.filter(v => isStoreInCurrentMarket(v.storeNbr));

                // Populate filter dropdown with only stores in current market
                const stores = [...new Set(allVisits.map(v => v.storeNbr))].sort();
                const dropdown = document.getElementById('store-filter-dropdown');
                dropdown.innerHTML = `<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="filterVisits(null)">All Stores</div>` +
                    stores.map(s => `<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="filterVisits('${s}')">Store ${s}</div>`).join('');

                // Build store summary (last visit per store)
                renderStoreSummary();
                renderVisits();
            } catch (e) {
                tbody.innerHTML = '<div class="p-8 text-center text-red-500">Error loading visits</div>';
                summaryGrid.innerHTML = '<div class="text-center text-red-500 text-sm py-4 col-span-full">Error loading</div>';
            }
        }

        function renderStoreSummary() {
            const summaryGrid = document.getElementById('store-summary-grid');

            if (allVisits.length === 0) {
                summaryGrid.innerHTML = '<div class="text-center text-gray-400 text-sm py-4 col-span-full">No visits recorded yet</div>';
                return;
            }

            // Get last visit per store (visits should be sorted by date desc from API)
            const lastVisitByStore = {};
            allVisits.forEach(v => {
                if (!lastVisitByStore[v.storeNbr]) {
                    lastVisitByStore[v.storeNbr] = v;
                } else {
                    // Compare dates to ensure we have the latest
                    if (v.calendar_date > lastVisitByStore[v.storeNbr].calendar_date) {
                        lastVisitByStore[v.storeNbr] = v;
                    }
                }
            });

            // Sort stores by number
            const sortedStores = Object.keys(lastVisitByStore).sort();

            summaryGrid.innerHTML = sortedStores.map(storeNbr => {
                const v = lastVisitByStore[storeNbr];
                let ratingClass = 'bg-gray-100 border-gray-300';
                let ratingTextClass = 'text-gray-600';
                if (v.rating === 'Green') {
                    ratingClass = 'bg-green-50 border-green-400';
                    ratingTextClass = 'text-green-700';
                } else if (v.rating === 'Yellow') {
                    ratingClass = 'bg-yellow-50 border-yellow-400';
                    ratingTextClass = 'text-yellow-700';
                } else if (v.rating === 'Red') {
                    ratingClass = 'bg-red-50 border-red-400';
                    ratingTextClass = 'text-red-700';
                }

                const date = v.calendar_date ? new Date(v.calendar_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'N/A';

                return `
                    <div class="bg-white rounded-lg border-l-4 ${ratingClass} p-3 cursor-pointer hover:shadow-md transition-shadow" onclick="filterVisits('${storeNbr}')">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-gray-900">#${storeNbr}</span>
                            <span class="text-xs font-semibold ${ratingTextClass}">${v.rating || 'N/A'}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${date}</p>
                    </div>
                `;
            }).join('');
        }

        function filterVisits(storeNbr) {
            currentFilter = storeNbr;
            document.getElementById('store-filter-text').textContent = storeNbr ? `Store ${storeNbr}` : 'All Stores';
            document.getElementById('store-filter-dropdown').classList.add('hidden');
            renderVisits();
        }

        function sortVisits(column) {
            if (currentSort.column === column) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = column;
                currentSort.ascending = true;
            }
            renderVisits();
        }

        function filterByRating(rating) {
            currentRatingFilter = rating;
            currentFilter = null; // Clear store filter when filtering by rating
            document.getElementById('store-filter-text').textContent = 'All Stores';
            switchTab('visits');
        }

        function clearRatingFilter() {
            currentRatingFilter = null;
            renderVisits();
        }

        function renderVisits() {
            let visits = [...allVisits];

            // Apply store filter
            if (currentFilter) {
                visits = visits.filter(v => v.storeNbr === currentFilter);
            }

            // Apply rating filter
            if (currentRatingFilter) {
                visits = visits.filter(v => v.rating === currentRatingFilter);
            }

            // Update rating filter badge visibility and styling
            const badge = document.getElementById('rating-filter-badge');
            const label = document.getElementById('rating-filter-label');
            if (currentRatingFilter) {
                badge.classList.remove('hidden');
                label.textContent = currentRatingFilter + ' Stores';
                // Set color based on rating
                label.className = 'px-2 py-1 rounded-full text-xs font-bold';
                if (currentRatingFilter === 'Red') {
                    label.classList.add('bg-red-100', 'text-red-800');
                } else if (currentRatingFilter === 'Yellow') {
                    label.classList.add('bg-yellow-100', 'text-yellow-800');
                } else if (currentRatingFilter === 'Green') {
                    label.classList.add('bg-green-100', 'text-green-800');
                }
            } else {
                badge.classList.add('hidden');
            }

            if (currentSort.column) {
                visits.sort((a, b) => {
                    let valA, valB;
                    if (currentSort.column === 'store') { valA = a.storeNbr || ''; valB = b.storeNbr || ''; }
                    else if (currentSort.column === 'date') { valA = a.calendar_date || ''; valB = b.calendar_date || ''; }
                    else if (currentSort.column === 'rating') { valA = a.rating || ''; valB = b.rating || ''; }
                    const cmp = valA.localeCompare(valB);
                    return currentSort.ascending ? cmp : -cmp;
                });
            }

            const tbody = document.getElementById('visits-table-body');
            if (visits.length === 0) {
                tbody.innerHTML = '<div class="p-8 text-center text-gray-500">No visits found.</div>';
                return;
            }

            tbody.innerHTML = visits.map(v => {
                let ratingClass = 'bg-gray-100 text-gray-800';
                if (v.rating === 'Green') ratingClass = 'bg-green-100 text-green-800';
                else if (v.rating === 'Yellow') ratingClass = 'bg-yellow-100 text-yellow-800';
                else if (v.rating === 'Red') ratingClass = 'bg-red-100 text-red-800';
                else if (v.rating === 'Unknown') ratingClass = 'bg-gray-100 text-gray-800';

                const date = v.calendar_date ? new Date(v.calendar_date).toLocaleDateString() : 'N/A';
                const notesReceived = v.notes_received || false;

                let notes = [];
                if (v.top_3) {
                    if (Array.isArray(v.top_3)) {
                        notes = v.top_3.map(n => typeof n === 'object' ? n.text : n);
                    } else {
                        notes = v.top_3.split('\n').filter(n => n.trim());
                    }
                }

                return `
                    <div class="grid grid-cols-12 gap-2 px-4 py-3 hover:bg-gray-50 items-start">
                        <div class="col-span-2 font-medium text-gray-900 cursor-pointer" onclick="openVisitDetail(${v.id})">${v.storeNbr || '?'}</div>
                        <div class="col-span-2 text-gray-600 text-sm cursor-pointer" onclick="openVisitDetail(${v.id})">${date}</div>
                        <div class="col-span-2 cursor-pointer" onclick="openVisitDetail(${v.id})"><span class="px-2 py-1 text-xs font-bold rounded-full ${ratingClass}">${v.rating || 'Unknown'}</span></div>
                        <div class="col-span-2 text-center">
                            <button onclick="toggleNotesReceived(${v.id}, ${!notesReceived})"
                                class="w-6 h-6 rounded border-2 flex items-center justify-center mx-auto transition-colors ${notesReceived ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-green-400'}"
                                title="${notesReceived ? 'Notes received' : 'Mark as notes received'}">
                                ${notesReceived ? '<i class="fas fa-check text-xs"></i>' : ''}
                            </button>
                        </div>
                        <div class="col-span-4 text-sm text-gray-600 cursor-pointer" onclick="openVisitDetail(${v.id})">
                            ${notes.length > 0
                                ? notes.slice(0, 3).map((n, i) => `<div class="truncate"><span class="text-gray-400">${i+1}.</span> ${n}</div>`).join('')
                                : '<span class="text-gray-400 italic">No notes</span>'}
                        </div>
                    </div>`;
            }).join('');
        }

        // Store filter toggle
        document.getElementById('store-filter-btn').addEventListener('click', () => {
            document.getElementById('store-filter-dropdown').classList.toggle('hidden');
        });

        // Toggle notes received status
        async function toggleNotesReceived(visitId, newStatus) {
            try {
                const response = await fetch(`/api/visits/${visitId}/notes-received`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes_received: newStatus })
                });

                if (!response.ok) throw new Error('Failed to update');

                // Update local state
                const visit = allVisits.find(v => v.id === visitId);
                if (visit) {
                    visit.notes_received = newStatus;
                    renderVisits();
                }
            } catch (e) {
                console.error('Error toggling notes received:', e);
                alert('Failed to update notes status');
            }
        }

        // --- Market Notes ---
        let allMarketNotes = [];
        let marketNotesStoreFilter = null;
        let completedSectionExpanded = false;
        let currentMarketNote = null;

        const STATUS_CONFIG = {
            'new': { label: 'New', color: 'bg-blue-100 text-blue-700', borderColor: 'border-blue-500 bg-blue-50' },
            'in_progress': { label: 'In Progress', color: 'bg-yellow-100 text-yellow-700', borderColor: 'border-yellow-500 bg-yellow-50' },
            'on_hold': { label: 'On Hold', color: 'bg-orange-100 text-orange-700', borderColor: 'border-orange-500 bg-orange-50' },
            'completed': { label: 'Completed', color: 'bg-green-100 text-green-700', borderColor: 'border-green-500 bg-green-50' }
        };

        async function loadMarketNotes() {
            const listEl = document.getElementById('market-notes-list');
            listEl.innerHTML = '<div class="text-center py-8"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch('/api/market-notes');
                if (!response.ok) throw new Error('Failed to load market notes');
                const allNotesData = await response.json();

                // Filter by current market
                allMarketNotes = allNotesData.filter(n => isStoreInCurrentMarket(n.store_nbr));

                // Populate store filter dropdown with only stores in current market
                const stores = [...new Set(allMarketNotes.map(n => n.store_nbr))].sort();
                const dropdown = document.getElementById('market-store-filter-dropdown');
                dropdown.innerHTML = `<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="filterMarketNotesByStore(null)">All Stores</div>` +
                    stores.map(s => `<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="filterMarketNotesByStore('${s}')">Store ${s}</div>`).join('');

                renderMarketNotes();
            } catch (e) {
                listEl.innerHTML = '<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-circle text-2xl mb-2"></i><p>Error loading market notes</p></div>';
            }
        }

        function filterMarketNotesByStore(storeNbr) {
            marketNotesStoreFilter = storeNbr;
            document.getElementById('market-store-filter-text').textContent = storeNbr ? `Store ${storeNbr}` : 'All Stores';
            document.getElementById('market-store-filter-dropdown').classList.add('hidden');
            renderMarketNotes();
        }

        function toggleCompletedSection() {
            completedSectionExpanded = !completedSectionExpanded;
            const container = document.getElementById('completed-notes-container');
            const chevron = document.getElementById('completed-chevron');

            if (completedSectionExpanded) {
                container.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                container.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function renderMarketNotes() {
            let filteredNotes = [...allMarketNotes];

            // Apply store filter
            if (marketNotesStoreFilter) {
                filteredNotes = filteredNotes.filter(n => n.store_nbr === marketNotesStoreFilter);
            }

            // Separate by status
            const incompleteNotes = filteredNotes.filter(n => n.status !== 'completed');
            const completedNotes = filteredNotes.filter(n => n.status === 'completed');

            // Update progress
            document.getElementById('market-notes-progress').textContent = `${completedNotes.length}/${filteredNotes.length} completed`;

            const listEl = document.getElementById('market-notes-list');

            // Render incomplete notes
            if (incompleteNotes.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-xl">
                        <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                        <p class="text-gray-600 font-medium">All caught up!</p>
                        <p class="text-gray-400 text-sm mt-1">No outstanding market notes</p>
                    </div>`;
            } else {
                // Group by store
                const groupedByStore = {};
                incompleteNotes.forEach(n => {
                    if (!groupedByStore[n.store_nbr]) groupedByStore[n.store_nbr] = [];
                    groupedByStore[n.store_nbr].push(n);
                });

                listEl.innerHTML = Object.keys(groupedByStore).sort().map(storeNbr => `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="bg-walmart-blue px-4 py-2 flex justify-between items-center">
                            <span class="text-white font-semibold">Store #${storeNbr}</span>
                            <span class="text-white text-sm opacity-80">${groupedByStore[storeNbr].length} remaining</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 text-left">
                                    <tr>
                                        <th class="px-4 py-2 font-medium text-gray-600">Note</th>
                                        <th class="px-4 py-2 font-medium text-gray-600 w-28">Assigned To</th>
                                        <th class="px-4 py-2 font-medium text-gray-600 w-24">Status</th>
                                        <th class="px-4 py-2 font-medium text-gray-600 w-20 text-center">Updates</th>
                                        <th class="w-8"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    ${groupedByStore[storeNbr].map(note => {
                                        const statusCfg = STATUS_CONFIG[note.status] || STATUS_CONFIG['new'];
                                        const updateCount = note.updates ? note.updates.length : 0;
                                        return `
                                        <tr class="market-note-item cursor-pointer hover:bg-gray-50"
                                            data-note-index="${allMarketNotes.indexOf(note)}">
                                            <td class="px-4 py-3">
                                                <p class="text-gray-800">${escapeHtml(note.note_text)}</p>
                                                <p class="text-xs text-gray-400 mt-1">${note.calendar_date || 'No date'}</p>
                                            </td>
                                            <td class="px-4 py-3 text-gray-600">${note.assigned_to ? escapeHtml(note.assigned_to) : '<span class="text-gray-300">â€”</span>'}</td>
                                            <td class="px-4 py-3">
                                                <span class="text-xs font-medium px-2 py-1 rounded-full ${statusCfg.color}">${statusCfg.label}</span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                ${updateCount > 0 ? `<span class="inline-flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">${updateCount}</span>` : '<span class="text-gray-300">â€”</span>'}
                                            </td>
                                            <td class="px-2 py-3">
                                                <i class="fas fa-chevron-right text-gray-300"></i>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('');
            }

            // Render completed section
            const completedSection = document.getElementById('completed-section');
            const completedContainer = document.getElementById('completed-notes-container');
            const completedBadge = document.getElementById('completed-count-badge');

            if (completedNotes.length === 0) {
                completedSection.classList.add('hidden');
            } else {
                completedSection.classList.remove('hidden');
                completedBadge.textContent = completedNotes.length;

                // Group completed by store
                const completedByStore = {};
                completedNotes.forEach(n => {
                    if (!completedByStore[n.store_nbr]) completedByStore[n.store_nbr] = [];
                    completedByStore[n.store_nbr].push(n);
                });

                completedContainer.innerHTML = Object.keys(completedByStore).sort().map(storeNbr => `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden opacity-75">
                        <div class="bg-gray-500 px-4 py-2 flex justify-between items-center">
                            <span class="text-white font-semibold">Store #${storeNbr}</span>
                            <span class="text-white text-sm opacity-80">${completedByStore[storeNbr].length} completed</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100 text-left">
                                    <tr>
                                        <th class="px-4 py-2 font-medium text-gray-500">Note</th>
                                        <th class="px-4 py-2 font-medium text-gray-500 w-28">Assigned To</th>
                                        <th class="px-4 py-2 font-medium text-gray-500 w-24">Status</th>
                                        <th class="px-4 py-2 font-medium text-gray-500 w-20 text-center">Updates</th>
                                        <th class="w-8"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100 bg-gray-50">
                                    ${completedByStore[storeNbr].map(note => {
                                        const updateCount = note.updates ? note.updates.length : 0;
                                        return `
                                        <tr class="market-note-item cursor-pointer hover:bg-gray-100"
                                            data-note-index="${allMarketNotes.indexOf(note)}">
                                            <td class="px-4 py-3">
                                                <p class="text-gray-400 line-through">${escapeHtml(note.note_text)}</p>
                                                <p class="text-xs text-gray-400 mt-1">${note.calendar_date || 'No date'}</p>
                                            </td>
                                            <td class="px-4 py-3 text-gray-400">${note.assigned_to ? escapeHtml(note.assigned_to) : '<span class="text-gray-300">â€”</span>'}</td>
                                            <td class="px-4 py-3">
                                                <span class="text-xs font-medium px-2 py-1 rounded-full bg-green-100 text-green-700">Completed</span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                ${updateCount > 0 ? `<span class="inline-flex items-center justify-center w-6 h-6 bg-gray-200 text-gray-500 text-xs font-medium rounded-full">${updateCount}</span>` : '<span class="text-gray-300">â€”</span>'}
                                            </td>
                                            <td class="px-2 py-3">
                                                <i class="fas fa-chevron-right text-gray-300"></i>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Open market note detail modal
        function openMarketNoteModal(noteIndex) {
            const note = allMarketNotes[noteIndex];
            if (!note) return;

            currentMarketNote = note;
            currentMarketNote._index = noteIndex;

            // Populate modal
            document.getElementById('mkt-note-store').textContent = `Store #${note.store_nbr}`;
            document.getElementById('mkt-note-date').textContent = note.calendar_date || 'No date';
            document.getElementById('mkt-note-text').textContent = note.note_text;
            document.getElementById('mkt-note-assigned').value = note.assigned_to || '';

            // Update status buttons
            document.querySelectorAll('.mkt-status-btn').forEach(btn => {
                const btnStatus = btn.dataset.status;
                const cfg = STATUS_CONFIG[btnStatus];
                if (btnStatus === note.status) {
                    btn.className = `mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors ${cfg.borderColor}`;
                } else {
                    btn.className = 'mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors border-gray-200 hover:border-gray-400';
                }
            });

            // Render updates
            renderMarketNoteUpdates();

            document.getElementById('market-note-modal').classList.remove('hidden');
        }

        function closeMarketNoteModal() {
            document.getElementById('market-note-modal').classList.add('hidden');
            currentMarketNote = null;
        }

        function renderMarketNoteUpdates() {
            const container = document.getElementById('mkt-note-updates');
            const updates = currentMarketNote.updates || [];

            if (updates.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm italic">No updates yet</p>';
            } else {
                container.innerHTML = updates.map((u, idx) => `
                    <div class="bg-gray-50 rounded-lg p-3 group relative">
                        <button onclick="deleteMarketNoteUpdate(${u.id}, ${idx})"
                                class="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                title="Delete update">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                        <p class="text-sm text-gray-800 pr-6">${escapeHtml(u.text)}</p>
                        <p class="text-xs text-gray-400 mt-1">
                            ${u.created_by ? u.created_by + ' - ' : ''}${u.created_at ? new Date(u.created_at).toLocaleString() : ''}
                        </p>
                    </div>
                `).join('');
            }
        }

        async function deleteMarketNoteUpdate(updateId, index) {
            if (!confirm('Delete this update?')) return;

            try {
                const response = await fetch(`/api/market-notes/delete-update/${updateId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to delete update');
                }

                // Remove from local state
                currentMarketNote.updates.splice(index, 1);
                renderMarketNoteUpdates();
                renderMarketNotes();

            } catch (e) {
                console.error('Error deleting update:', e);
                alert('Failed to delete update: ' + e.message);
            }
        }

        async function setMarketNoteStatus(status) {
            if (!currentMarketNote) return;

            try {
                const response = await fetch('/api/market-notes/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        visit_id: currentMarketNote.visit_id,
                        note_text: currentMarketNote.note_text,
                        status: status
                    })
                });

                if (!response.ok) throw new Error('Failed to update');

                // Update local state
                currentMarketNote.status = status;
                currentMarketNote.completed = (status === 'completed');

                // Update status buttons
                document.querySelectorAll('.mkt-status-btn').forEach(btn => {
                    const btnStatus = btn.dataset.status;
                    const cfg = STATUS_CONFIG[btnStatus];
                    if (btnStatus === status) {
                        btn.className = `mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors ${cfg.borderColor}`;
                    } else {
                        btn.className = 'mkt-status-btn px-3 py-2 rounded-lg text-sm font-medium border-2 transition-colors border-gray-200 hover:border-gray-400';
                    }
                });

                renderMarketNotes();
                updateDashboardMarketCount();

            } catch (e) {
                console.error('Error updating status:', e);
                alert('Failed to update status');
            }
        }

        async function saveMarketNoteAssignment() {
            if (!currentMarketNote) return;

            const assignedTo = document.getElementById('mkt-note-assigned').value.trim();

            try {
                const response = await fetch('/api/market-notes/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        visit_id: currentMarketNote.visit_id,
                        note_text: currentMarketNote.note_text,
                        assigned_to: assignedTo
                    })
                });

                if (!response.ok) throw new Error('Failed to update');

                currentMarketNote.assigned_to = assignedTo;
                renderMarketNotes();

            } catch (e) {
                console.error('Error updating assignment:', e);
                alert('Failed to update assignment');
            }
        }

        async function addMarketNoteUpdate() {
            if (!currentMarketNote) return;

            const updateText = document.getElementById('mkt-note-new-update').value.trim();
            if (!updateText) return;

            try {
                const response = await fetch('/api/market-notes/add-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        visit_id: currentMarketNote.visit_id,
                        note_text: currentMarketNote.note_text,
                        update_text: updateText
                    })
                });

                if (!response.ok) throw new Error('Failed to add update');

                const result = await response.json();

                // Add to local state
                if (!currentMarketNote.updates) currentMarketNote.updates = [];
                currentMarketNote.updates.unshift(result.update);

                document.getElementById('mkt-note-new-update').value = '';
                renderMarketNoteUpdates();
                renderMarketNotes();

            } catch (e) {
                console.error('Error adding update:', e);
                alert('Failed to add update');
            }
        }

        function updateDashboardMarketCount() {
            const incompleteCount = allMarketNotes.filter(n => n.status !== 'completed').length;
            const countEl = document.getElementById('market-notes-count');
            if (countEl) countEl.textContent = incompleteCount;
        }

        // Event delegation for market note clicks (both outstanding and completed)
        document.getElementById('market-notes-list').addEventListener('click', (e) => {
            const noteItem = e.target.closest('.market-note-item');
            if (noteItem) {
                const noteIndex = parseInt(noteItem.dataset.noteIndex);
                openMarketNoteModal(noteIndex);
            }
        });

        document.getElementById('completed-notes-container').addEventListener('click', (e) => {
            const noteItem = e.target.closest('.market-note-item');
            if (noteItem) {
                const noteIndex = parseInt(noteItem.dataset.noteIndex);
                openMarketNoteModal(noteIndex);
            }
        });

        // Close modal on backdrop click
        document.getElementById('market-note-modal').addEventListener('click', function(e) {
            if (e.target === this) closeMarketNoteModal();
        });

        // Market notes store filter toggle
        document.getElementById('market-store-filter-btn').addEventListener('click', () => {
            document.getElementById('market-store-filter-dropdown').classList.toggle('hidden');
        });

        // --- Gold Star Notes ---
        let goldStarData = null;
        let goldStarEditMode = false;
        let goldStarWeekOffset = 0;

        function changeGoldStarWeek(delta) {
            goldStarWeekOffset += delta;
            loadGoldStars();
        }

        async function loadGoldStars() {
            const storesContainer = document.getElementById('gold-star-stores');
            storesContainer.innerHTML = '<div class="p-8 text-center"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch(`/api/gold-stars/current?week_offset=${goldStarWeekOffset}&market=${currentMarket}`);
                if (!response.ok) throw new Error('Failed to load gold stars');
                goldStarData = await response.json();

                // Display week info (Saturday to Friday)
                const weekStart = new Date(goldStarData.week_start_date + 'T00:00:00');
                const weekEnd = new Date(goldStarData.week_end_date + 'T00:00:00');
                const weekNumber = goldStarData.week_number || 1;
                const isCurrentWeek = goldStarData.is_current_week;

                // Week label with indicator for current week
                const weekLabel = isCurrentWeek ? 'Week ' + weekNumber : 'Week ' + weekNumber;
                const currentIndicator = isCurrentWeek ? '<span class="text-xs text-green-600 block">(Current)</span>' : '';

                document.getElementById('gold-star-week').innerHTML =
                    `<div class="font-bold text-walmart-blue">${weekLabel}</div>
                     <div class="text-xs">${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                     ${currentIndicator}`;

                renderGoldStars();
            } catch (e) {
                console.error('Error loading gold stars:', e);
                storesContainer.innerHTML = '<div class="p-8 text-center text-red-500">Error loading gold star notes</div>';
            }
        }

        function renderGoldStars() {
            const displayEl = document.getElementById('gold-star-display');
            const emptyEl = document.getElementById('gold-star-empty');
            const editBtn = document.getElementById('gold-star-edit-btn');
            const storesContainer = document.getElementById('gold-star-stores');
            const isCurrentWeek = goldStarData.is_current_week;

            if (!goldStarData.notes || (!goldStarData.notes.note_1 && !goldStarData.notes.note_2 && !goldStarData.notes.note_3)) {
                // No notes defined for this week
                displayEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                editBtn.classList.add('hidden');
                storesContainer.innerHTML = '<div class="p-8 text-center text-gray-500">No gold star notes defined for this week</div>';
                document.getElementById('gold-progress-1').textContent = '0/0';
                document.getElementById('gold-progress-2').textContent = '0/0';
                document.getElementById('gold-progress-3').textContent = '0/0';
                return;
            }

            // Show notes
            displayEl.classList.remove('hidden');
            emptyEl.classList.add('hidden');
            // Only show edit button for current week
            if (isCurrentWeek) {
                editBtn.classList.remove('hidden');
            } else {
                editBtn.classList.add('hidden');
            }

            document.getElementById('display-note-1').textContent = goldStarData.notes.note_1;
            document.getElementById('display-note-2').textContent = goldStarData.notes.note_2;
            document.getElementById('display-note-3').textContent = goldStarData.notes.note_3;

            // Calculate progress - filter by current market
            const allStores = goldStarData.stores || [];
            const stores = allStores.filter(s => isStoreInCurrentMarket(s.store_nbr));
            const total = stores.length;
            const completed1 = stores.filter(s => s.note_1).length;
            const completed2 = stores.filter(s => s.note_2).length;
            const completed3 = stores.filter(s => s.note_3).length;

            document.getElementById('gold-progress-1').textContent = `${completed1}/${total}`;
            document.getElementById('gold-progress-2').textContent = `${completed2}/${total}`;
            document.getElementById('gold-progress-3').textContent = `${completed3}/${total}`;

            // Render store rows
            if (stores.length === 0) {
                storesContainer.innerHTML = '<div class="p-8 text-center text-gray-500">No stores found in selected market.</div>';
                return;
            }

            storesContainer.innerHTML = stores.map(store => {
                const allComplete = store.note_1 && store.note_2 && store.note_3;
                // No longer restrict marking past weeks - allow all weeks to be marked
                return `
                    <div class="grid grid-cols-12 gap-2 px-4 py-3 items-center ${allComplete ? 'bg-green-50' : ''}">
                        <div class="col-span-3 font-medium text-gray-900">#${store.store_nbr}</div>
                        <div class="col-span-3 text-center">
                            <button onclick="toggleGoldStar('${store.store_nbr}', 1, ${!store.note_1})"
                                class="w-8 h-8 rounded-full border-2 flex items-center justify-center mx-auto transition-colors hover:border-yellow-400 ${store.note_1 ? 'bg-yellow-400 border-yellow-400' : 'border-gray-300'}">
                                ${store.note_1 ? '<i class="fas fa-star text-white text-sm"></i>' : ''}
                            </button>
                        </div>
                        <div class="col-span-3 text-center">
                            <button onclick="toggleGoldStar('${store.store_nbr}', 2, ${!store.note_2})"
                                class="w-8 h-8 rounded-full border-2 flex items-center justify-center mx-auto transition-colors hover:border-yellow-400 ${store.note_2 ? 'bg-yellow-400 border-yellow-400' : 'border-gray-300'}">
                                ${store.note_2 ? '<i class="fas fa-star text-white text-sm"></i>' : ''}
                            </button>
                        </div>
                        <div class="col-span-3 text-center">
                            <button onclick="toggleGoldStar('${store.store_nbr}', 3, ${!store.note_3})"
                                class="w-8 h-8 rounded-full border-2 flex items-center justify-center mx-auto transition-colors hover:border-yellow-400 ${store.note_3 ? 'bg-yellow-400 border-yellow-400' : 'border-gray-300'}">
                                ${store.note_3 ? '<i class="fas fa-star text-white text-sm"></i>' : ''}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleGoldStarEdit() {
            goldStarEditMode = !goldStarEditMode;
            const displayEl = document.getElementById('gold-star-display');
            const editEl = document.getElementById('gold-star-edit');
            const emptyEl = document.getElementById('gold-star-empty');
            const editBtn = document.getElementById('gold-star-edit-btn');

            if (goldStarEditMode) {
                displayEl.classList.add('hidden');
                emptyEl.classList.add('hidden');
                editEl.classList.remove('hidden');
                editBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';

                // Pre-fill with existing values
                if (goldStarData && goldStarData.notes) {
                    document.getElementById('edit-note-1').value = goldStarData.notes.note_1 || '';
                    document.getElementById('edit-note-2').value = goldStarData.notes.note_2 || '';
                    document.getElementById('edit-note-3').value = goldStarData.notes.note_3 || '';
                }
            } else {
                cancelGoldStarEdit();
            }
        }

        function cancelGoldStarEdit() {
            goldStarEditMode = false;
            const displayEl = document.getElementById('gold-star-display');
            const editEl = document.getElementById('gold-star-edit');
            const emptyEl = document.getElementById('gold-star-empty');
            const editBtn = document.getElementById('gold-star-edit-btn');

            editEl.classList.add('hidden');
            editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';

            if (goldStarData && goldStarData.notes) {
                displayEl.classList.remove('hidden');
            } else {
                emptyEl.classList.remove('hidden');
            }
        }

        async function saveGoldStarNotes() {
            const note1 = document.getElementById('edit-note-1').value.trim();
            const note2 = document.getElementById('edit-note-2').value.trim();
            const note3 = document.getElementById('edit-note-3').value.trim();

            if (!note1 || !note2 || !note3) {
                alert('Please fill in all three gold star notes');
                return;
            }

            try {
                const response = await fetch('/api/gold-stars/week', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ note_1: note1, note_2: note2, note_3: note3 })
                });

                if (!response.ok) throw new Error('Failed to save');

                goldStarEditMode = false;
                await loadGoldStars();
            } catch (e) {
                console.error('Error saving gold stars:', e);
                alert('Failed to save gold star notes');
            }
        }

        async function toggleGoldStar(storeNbr, noteNumber, completed) {
            try {
                // Capture week_id from current goldStarData to prevent race conditions
                const weekId = goldStarData?.week_id;
                if (!weekId) {
                    console.error('No week_id available in goldStarData:', goldStarData);
                    alert('Error: Week data not loaded. Please refresh and try again.');
                    return;
                }

                const response = await fetch('/api/gold-stars/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        store_nbr: storeNbr,
                        note_number: noteNumber,
                        completed: completed,
                        week_id: weekId  // Pass week_id to allow marking any week
                    })
                });

                if (!response.ok) throw new Error('Failed to update');

                // Update local state
                const store = goldStarData.stores.find(s => s.store_nbr === storeNbr);
                if (store) {
                    store[`note_${noteNumber}`] = completed;
                    renderGoldStars();
                }
            } catch (e) {
                console.error('Error toggling gold star:', e);
                alert('Failed to update completion status');
            }
        }

        // --- Prior Tours ---
        document.getElementById('btn-search-prior').addEventListener('click', async () => {
            const storeNbr = document.getElementById('prior-store-nbr').value.trim();
            if (!storeNbr) { alert('Please enter a store number'); return; }

            const div = document.getElementById('prior-results');
            div.innerHTML = '<div class="text-center py-8"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch(`/api/visits?storeNbr=${encodeURIComponent(storeNbr)}`);
                if (!response.ok) throw new Error('Failed');
                const data = await response.json();

                if (data.length === 0) {
                    div.innerHTML = '<div class="text-center py-8 bg-white rounded-xl"><p class="text-gray-500">No prior visits found for store #' + storeNbr + '</p></div>';
                    return;
                }

                div.innerHTML = data.map(v => {
                    let ratingClass = 'bg-gray-100 text-gray-800';
                    if (v.rating === 'Green') ratingClass = 'bg-green-100 text-green-800';
                    else if (v.rating === 'Yellow') ratingClass = 'bg-yellow-100 text-yellow-800';
                    else if (v.rating === 'Red') ratingClass = 'bg-red-100 text-red-800';
                    else if (v.rating === 'Unknown') ratingClass = 'bg-gray-100 text-gray-800';

                    let notes = [];
                    if (v.top_3) {
                        if (Array.isArray(v.top_3)) notes = v.top_3.map(n => typeof n === 'object' ? n.text : n);
                        else notes = v.top_3.split('\n').filter(n => n.trim());
                    }

                    return `
                        <div class="bg-white p-4 rounded-xl shadow cursor-pointer hover:shadow-lg transition-shadow" onclick="openVisitDetail(${v.id})">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <span class="text-sm text-gray-500">Date</span>
                                    <p class="font-bold text-gray-900">${v.calendar_date || 'N/A'}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${ratingClass}">${v.rating || 'Unknown'}</span>
                            </div>
                            <div>
                                <h4 class="text-xs font-semibold text-gray-500 uppercase mb-2">Top 3 Notes</h4>
                                ${notes.length > 0
                                    ? `<ul class="space-y-1">${notes.map(n => `<li class="text-sm text-gray-700 flex"><i class="fas fa-exclamation-circle text-yellow-500 mt-1 mr-2 text-xs"></i>${n}</li>`).join('')}</ul>`
                                    : '<p class="text-sm text-gray-400 italic">No notes</p>'}
                            </div>
                        </div>`;
                }).join('');
            } catch (e) {
                div.innerHTML = '<div class="p-4 bg-red-50 text-red-700 rounded-lg">Error loading visits</div>';
            }
        });

        // --- Image Upload ---
        const handleImageSelect = (e) => {
            if (!e.target.files || e.target.files.length === 0) return;

            // Process all selected files
            Array.from(e.target.files).forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = (ev) => {
                    analysisImages.push({
                        image_data: ev.target.result.split(',')[1],
                        mime_type: file.type,
                        url: ev.target.result
                    });
                    renderAnalysisPreviews();
                };
                reader.readAsDataURL(file);
            });
            
            // Clear input so same files can be selected again if needed
            e.target.value = '';
        };

        function renderAnalysisPreviews() {
            const container = document.getElementById('image-preview-container');
            const grid = document.getElementById('image-previews-grid');
            
            if (analysisImages.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            grid.innerHTML = analysisImages.map((img, idx) => `
                <div class="relative group">
                    <img src="${img.url}" class="w-full h-24 object-cover rounded-lg shadow-sm border border-gray-200">
                    <button onclick="removeAnalysisImage(${idx})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 focus:outline-none">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeAnalysisImage(index) {
            analysisImages.splice(index, 1);
            renderAnalysisPreviews();
        }

        document.getElementById('image-upload').addEventListener('change', handleImageSelect);
        document.getElementById('camera-input').addEventListener('change', handleImageSelect);

        document.getElementById('analyze-button').addEventListener('click', async () => {
            if (analysisImages.length === 0) { showError('Please upload at least one image.'); return; }

            setLoading(true);
            try {
                const response = await fetch('/api/analyze-visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ images: analysisImages })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Analysis failed');
                }

                currentParsedData = await response.json();
                displayResults(currentParsedData);
                await checkAndSave(currentParsedData);
            } catch (e) {
                showError(e.message);
            } finally {
                setLoading(false);
            }
        });

        async function reanalyzeNotes() {
            if (analysisImages.length === 0) {
                showError('No images to analyze.');
                return;
            }

            setLoading(true);
            document.getElementById('results-container').classList.add('hidden');

            try {
                const response = await fetch('/api/analyze-visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ images: analysisImages })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Re-analysis failed');
                }

                currentParsedData = await response.json();
                displayResults(currentParsedData);
                // Don't auto-save on re-analyze - let user review first
            } catch (e) {
                showError(e.message);
            } finally {
                setLoading(false);
            }
        }

        async function manualSaveVisit() {
            if (!currentParsedData) {
                showError('No data to save. Please analyze an image first.');
                return;
            }
            await checkAndSave(currentParsedData);
        }

        async function checkAndSave(data) {
            try {
                const checkUrl = `/api/check-duplicate?storeNbr=${encodeURIComponent(data.storeNbr)}&calendar_date=${encodeURIComponent(data.calendar_date)}`;
                const checkResponse = await fetch(checkUrl);
                if (!checkResponse.ok) { await saveToBackend(data); return; }

                const result = await checkResponse.json();
                if (result.is_duplicate && result.existing_records.length > 0) {
                    showDuplicateModal(result.existing_records);
                } else {
                    await saveToBackend(data);
                }
            } catch (e) {
                if (confirm('Could not check for duplicates. Save anyway?')) await saveToBackend(data);
            }
        }

        let currentSavedVisitId = null;
        let pendingPhotos = []; // Photos to upload after visit is saved

        async function saveToBackend(data) {
            const saveBtn = document.getElementById('save-visit-button');
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            saveBtn.disabled = true;

            try {
                const response = await fetch('/api/save-visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error || `Save failed (${response.status})`);
                }
                const result = await response.json();
                currentSavedVisitId = result.visit_id;
                console.log('Saved successfully, visit_id:', currentSavedVisitId);

                // Upload any pending photos
                if (pendingPhotos.length > 0) {
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading Photos...';
                    await uploadPendingPhotos(currentSavedVisitId);
                }

                // Update button to show saved state
                saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved!';
                saveBtn.classList.add('bg-green-600');
                saveBtn.classList.remove('bg-walmart-blue', 'hover:bg-walmart-dark-blue');

                const photoCount = document.getElementById('visit-photos-grid').querySelectorAll('div.relative').length;
                alert(`Visit saved successfully!${photoCount > 0 ? ` ${photoCount} photo(s) uploaded.` : ''}`);
            } catch (e) {
                console.error('Save error:', e);
                showError('Failed to save: ' + e.message);
                // Reset button on error
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Visit';
                saveBtn.disabled = false;
            }
        }

        function resetLogVisitForm() {
            // Clear image data
            analysisImages = [];
            currentParsedData = null;
            currentSavedVisitId = null;
            pendingPhotos = [];
            // Hide preview and results
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('image-previews-grid').innerHTML = '';
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('error-message').classList.add('hidden');
            // Reset file inputs
            document.getElementById('image-upload').value = '';
            document.getElementById('camera-input').value = '';
            // Reset photo section
            document.getElementById('visit-photos-section').classList.add('hidden');
            document.getElementById('visit-photos-grid').innerHTML = '<p class="col-span-3 text-center text-gray-400 text-sm py-4">No photos yet</p>';
            // Reset save button
            const saveBtn = document.getElementById('save-visit-button');
            saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Visit';
            saveBtn.disabled = false;
            saveBtn.classList.remove('bg-green-600');
            saveBtn.classList.add('bg-walmart-blue', 'hover:bg-walmart-dark-blue');
            // Reset metrics to default values
            const metricIds = [
                'metric-sales-comp-yest', 'metric-sales-comp-wtd', 'metric-sales-comp-mtd',
                'metric-sales-index-yest', 'metric-sales-index-wtd', 'metric-sales-index-mtd',
                'metric-ftpr', 'metric-presub', 'metric-vizpick', 'metric-vizpick-health',
                'metric-overstock', 'metric-picks', 'metric-fashion', 'metric-topstock-grocery', 'metric-cases',
                'metric-modflex', 'metric-tag-errors', 'metric-mods', 'metric-pcs', 'metric-pinpoint', 'metric-locations'
            ];
            metricIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '--';
            });
        }

        // --- Visit Photo Functions ---
        // Add photo from camera (single)
        function addVisitPhoto(input) {
            if (!input.files || !input.files[0]) return;
            addPendingPhoto(input.files[0]);
            input.value = '';
        }

        // Add photos from gallery (multiple)
        function addVisitPhotos(input) {
            if (!input.files || input.files.length === 0) return;
            for (const file of input.files) {
                addPendingPhoto(file);
            }
            input.value = '';
        }

        // Add a photo to pending list and show preview
        function addPendingPhoto(file) {
            const photoId = 'pending-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            pendingPhotos.push({ id: photoId, file: file });

            const grid = document.getElementById('visit-photos-grid');
            // Remove "No photos yet" message if present
            const noPhotosMsg = grid.querySelector('p');
            if (noPhotosMsg) noPhotosMsg.remove();

            // Create preview using FileReader
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'relative group';
                photoDiv.id = photoId;
                photoDiv.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}" class="w-full h-24 object-cover rounded-lg cursor-pointer" onclick="openPhotoViewer('${e.target.result}')">
                    <button onclick="removePendingPhoto('${photoId}')" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="absolute bottom-1 left-1 bg-yellow-500 text-white text-xs px-1 rounded">Pending</div>
                `;
                grid.appendChild(photoDiv);
            };
            reader.readAsDataURL(file);
        }

        // Remove a pending photo before save
        function removePendingPhoto(photoId) {
            pendingPhotos = pendingPhotos.filter(p => p.id !== photoId);
            const photoEl = document.getElementById(photoId);
            if (photoEl) photoEl.remove();

            // Show "No photos yet" if grid is empty
            const grid = document.getElementById('visit-photos-grid');
            if (grid.children.length === 0) {
                grid.innerHTML = '<p class="col-span-3 text-center text-gray-400 text-sm py-4">No photos yet</p>';
            }
        }

        // Upload all pending photos after visit is saved
        async function uploadPendingPhotos(visitId) {
            if (pendingPhotos.length === 0) return;

            const progressEl = document.getElementById('photo-upload-progress');
            progressEl.classList.remove('hidden');
            progressEl.innerHTML = '<i class="fas fa-spinner fa-spin text-walmart-blue"></i><span class="text-sm text-gray-600 ml-2">Uploading photos (0/' + pendingPhotos.length + ')...</span>';

            let uploaded = 0;
            for (const photo of pendingPhotos) {
                try {
                    const formData = new FormData();
                    formData.append('photo', photo.file);

                    const response = await fetch(`/api/visits/${visitId}/photos`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        console.error('Failed to upload photo:', photo.file.name);
                    } else {
                        const savedPhoto = await response.json();
                        // Update the preview with the actual photo data
                        const photoEl = document.getElementById(photo.id);
                        if (photoEl) {
                            const img = photoEl.querySelector('img');
                            img.src = savedPhoto.gcs_url;
                            img.onclick = () => openPhotoViewer(savedPhoto.gcs_url);
                            // Remove pending badge
                            const badge = photoEl.querySelector('.bg-yellow-500');
                            if (badge) badge.remove();
                            // Update delete button
                            const deleteBtn = photoEl.querySelector('button');
                            deleteBtn.onclick = () => deleteVisitPhoto(savedPhoto.id, visitId);
                            photoEl.id = `photo-${savedPhoto.id}`;
                        }
                    }
                    uploaded++;
                    progressEl.innerHTML = '<i class="fas fa-spinner fa-spin text-walmart-blue"></i><span class="text-sm text-gray-600 ml-2">Uploading photos (' + uploaded + '/' + pendingPhotos.length + ')...</span>';
                } catch (e) {
                    console.error('Photo upload error:', e);
                }
            }

            pendingPhotos = [];
            progressEl.classList.add('hidden');
        }

        // Delete a saved photo
        async function deleteVisitPhoto(photoId, visitId) {
            if (!confirm('Delete this photo?')) return;

            try {
                const response = await fetch(`/api/visits/${visitId || currentSavedVisitId}/photos/${photoId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Delete failed');
                }

                document.getElementById(`photo-${photoId}`).remove();

                // Show "No photos yet" if grid is empty
                const grid = document.getElementById('visit-photos-grid');
                if (grid.children.length === 0) {
                    grid.innerHTML = '<p class="col-span-3 text-center text-gray-400 text-sm py-4">No photos yet</p>';
                }

            } catch (e) {
                console.error('Delete error:', e);
                alert('Failed to delete photo');
            }
        }

        function openPhotoViewer(url) {
            // Simple fullscreen photo viewer
            const viewer = document.createElement('div');
            viewer.className = 'fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4';
            viewer.onclick = () => viewer.remove();
            viewer.innerHTML = `
                <img src="${url}" class="max-w-full max-h-full object-contain">
                <button class="absolute top-4 right-4 text-white text-2xl" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.body.appendChild(viewer);
        }

        // --- Manual Visit Functions ---
        let manualVisitPhotos = [];

        function showManualVisitModal() {
            // Reset form
            document.getElementById('manual-visit-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('manual-visit-store').value = '';
            document.getElementById('manual-visit-rating').value = '';
            document.getElementById('manual-visit-notes').value = '';
            manualVisitPhotos = [];
            document.getElementById('manual-photos-grid').innerHTML = '<p class="col-span-3 text-center text-gray-400 text-sm py-2">No photos added</p>';

            // Populate store dropdown
            const storeSelect = document.getElementById('manual-visit-store');
            const stores = getMarketStores().sort((a, b) => a - b);
            storeSelect.innerHTML = '<option value="">Select Store...</option>' +
                stores.map(s => `<option value="${s}">${s}</option>`).join('');

            document.getElementById('manual-visit-modal').classList.remove('hidden');
        }

        function hideManualVisitModal() {
            document.getElementById('manual-visit-modal').classList.add('hidden');
            manualVisitPhotos = [];
        }

        function addManualPhoto(input) {
            if (!input.files || !input.files[0]) return;
            addManualPhotoFile(input.files[0]);
            input.value = '';
        }

        function addManualPhotos(input) {
            if (!input.files || input.files.length === 0) return;
            for (const file of input.files) {
                addManualPhotoFile(file);
            }
            input.value = '';
        }

        function addManualPhotoFile(file) {
            const photoId = 'manual-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            manualVisitPhotos.push({ id: photoId, file: file });

            const grid = document.getElementById('manual-photos-grid');
            const noPhotosMsg = grid.querySelector('p');
            if (noPhotosMsg) noPhotosMsg.remove();

            const reader = new FileReader();
            reader.onload = function(e) {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'relative group';
                photoDiv.id = photoId;
                photoDiv.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}" class="w-full h-20 object-cover rounded-lg cursor-pointer" onclick="openPhotoViewer('${e.target.result}')">
                    <button onclick="removeManualPhoto('${photoId}')" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                grid.appendChild(photoDiv);
            };
            reader.readAsDataURL(file);
        }

        function removeManualPhoto(photoId) {
            manualVisitPhotos = manualVisitPhotos.filter(p => p.id !== photoId);
            const photoEl = document.getElementById(photoId);
            if (photoEl) photoEl.remove();

            const grid = document.getElementById('manual-photos-grid');
            if (grid.children.length === 0) {
                grid.innerHTML = '<p class="col-span-3 text-center text-gray-400 text-sm py-2">No photos added</p>';
            }
        }

        async function saveManualVisit() {
            const date = document.getElementById('manual-visit-date').value;
            const store = document.getElementById('manual-visit-store').value;
            const rating = document.getElementById('manual-visit-rating').value;
            const notes = document.getElementById('manual-visit-notes').value.trim();

            if (!date) {
                alert('Please select a visit date.');
                return;
            }
            if (!store) {
                alert('Please select a store.');
                return;
            }
            if (!rating) {
                alert('Please select a rating.');
                return;
            }

            const saveBtn = document.getElementById('manual-visit-save-btn');
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            saveBtn.disabled = true;

            try {
                // Build visit data
                const visitData = {
                    storeNbr: store,
                    calendar_date: date,
                    rating: rating,
                    store_notes: notes ? [notes] : [],
                    market_notes: [],
                    positive_notes: [],
                    wins: [],
                    opportunities: [],
                    metrics: {}
                };

                // Save visit
                const response = await fetch('/api/save-visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(visitData)
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error || 'Save failed');
                }

                const result = await response.json();
                const visitId = result.visit_id;

                // Upload photos
                if (manualVisitPhotos.length > 0) {
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading Photos...';

                    for (const photo of manualVisitPhotos) {
                        try {
                            const formData = new FormData();
                            formData.append('photo', photo.file);
                            await fetch(`/api/visits/${visitId}/photos`, {
                                method: 'POST',
                                body: formData
                            });
                        } catch (e) {
                            console.error('Failed to upload photo:', e);
                        }
                    }
                }

                hideManualVisitModal();
                alert(`Visit saved successfully!${manualVisitPhotos.length > 0 ? ` ${manualVisitPhotos.length} photo(s) uploaded.` : ''}`);

                // Refresh visits if on visits tab
                if (!document.getElementById('view-visits').classList.contains('hidden-view')) {
                    loadVisits();
                }

            } catch (e) {
                console.error('Save error:', e);
                alert('Failed to save visit: ' + e.message);
            } finally {
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Visit';
                saveBtn.disabled = false;
            }
        }

        function showDuplicateModal(records) {
            const r = records[0];
            document.getElementById('duplicate-details').innerHTML = `<p><strong>Store:</strong> ${r.storeNbr}</p><p><strong>Date:</strong> ${r.calendar_date}</p>`;
            document.getElementById('duplicate-modal').classList.remove('hidden');
        }

        document.getElementById('duplicate-cancel-btn').addEventListener('click', () => {
            document.getElementById('duplicate-modal').classList.add('hidden');
        });
        document.getElementById('duplicate-submit-btn').addEventListener('click', async () => {
            document.getElementById('duplicate-modal').classList.add('hidden');
            await saveToBackend(currentParsedData);
        });

        function setLoading(loading) {
            document.getElementById('loading-spinner').classList.toggle('hidden', !loading);
            document.getElementById('analyze-button').disabled = loading;
            if (loading) document.getElementById('results-container').classList.add('hidden');
        }

        function displayResults(data) {
            const formatArray = (arr) => {
                if (!arr || arr.length === 0) return 'N/A';
                if (arr[0] && typeof arr[0] === 'object' && arr[0].text) return arr.map(i => `â€¢ ${i.text}`).join('\n');
                return arr.map(i => `â€¢ ${i}`).join('\n');
            };

            const rating = data.rating || 'Unknown';
            let ratingClass = 'bg-gray-100 text-gray-800 border-gray-300';
            if (rating === 'Red') ratingClass = 'bg-red-100 text-red-800 border-red-300';
            else if (rating === 'Yellow') ratingClass = 'bg-yellow-100 text-yellow-800 border-yellow-300';
            else if (rating === 'Green') ratingClass = 'bg-green-100 text-green-800 border-green-300';
            else if (rating === 'Unknown') ratingClass = 'bg-gray-100 text-gray-800 border-gray-300';

            document.getElementById('result-rating').className = `inline-flex items-center justify-center px-6 py-2 text-xl font-bold rounded-full border-2 ${ratingClass}`;
            document.getElementById('result-rating').textContent = rating;
            document.getElementById('result-calendar-date').textContent = data.calendar_date || 'N/A';
            document.getElementById('result-store-nbr').textContent = data.storeNbr || 'N/A';
            document.getElementById('result-store-notes').textContent = Array.isArray(data.store_notes) ? formatArray(data.store_notes) : (data.store_notes || 'N/A');
            document.getElementById('result-mkt-notes').textContent = Array.isArray(data.mkt_notes) ? formatArray(data.mkt_notes) : (data.mkt_notes || 'N/A');
            document.getElementById('result-good').textContent = formatArray(data.good);
            document.getElementById('result-top-3').textContent = formatArray(data.top_3);

            // Populate metrics
            const metrics = data.metrics || {};
            const formatMetric = (value) => {
                if (value === null || value === undefined || value === '') return '--';
                return value;
            };

            // Sales metrics
            document.getElementById('metric-sales-comp-yest').textContent = formatMetric(metrics.sales_comp_yest);
            document.getElementById('metric-sales-comp-wtd').textContent = formatMetric(metrics.sales_comp_wtd);
            document.getElementById('metric-sales-comp-mtd').textContent = formatMetric(metrics.sales_comp_mtd);
            document.getElementById('metric-sales-index-yest').textContent = formatMetric(metrics.sales_index_yest);
            document.getElementById('metric-sales-index-wtd').textContent = formatMetric(metrics.sales_index_wtd);
            document.getElementById('metric-sales-index-mtd').textContent = formatMetric(metrics.sales_index_mtd);

            // Inventory Health metrics
            document.getElementById('metric-ftpr').textContent = formatMetric(metrics.ftpr);
            document.getElementById('metric-presub').textContent = formatMetric(metrics.presub);
            document.getElementById('metric-vizpick').textContent = formatMetric(metrics.vizpick);
            document.getElementById('metric-overstock').textContent = formatMetric(metrics.overstock);
            document.getElementById('metric-picks').textContent = formatMetric(metrics.picks);
            document.getElementById('metric-fashion').textContent = formatMetric(metrics.vizfashion);

            // Basic Work metrics
            document.getElementById('metric-modflex').textContent = formatMetric(metrics.modflex);
            document.getElementById('metric-tag-errors').textContent = formatMetric(metrics.tag_errors);
            document.getElementById('metric-mods').textContent = formatMetric(metrics.mods);
            document.getElementById('metric-pcs').textContent = formatMetric(metrics.pcs);
            document.getElementById('metric-pinpoint').textContent = formatMetric(metrics.pinpoint);
            document.getElementById('metric-locations').textContent = formatMetric(metrics.locations);

            // Additional Inventory Health metrics
            document.getElementById('metric-vizpick-health').textContent = formatMetric(metrics.vizpick_health);
            document.getElementById('metric-topstock-grocery').textContent = formatMetric(metrics.topstock_grocery);
            document.getElementById('metric-cases').textContent = formatMetric(metrics.cases);

            document.getElementById('results-container').classList.remove('hidden');

            // Show photo upload section after analysis
            document.getElementById('visit-photos-section').classList.remove('hidden');
        }

        function showError(msg) {
            document.getElementById('error-text').textContent = msg;
            document.getElementById('error-message').classList.remove('hidden');
        }

        // --- Visit Detail Modal ---
        async function openVisitDetail(id) {
            const modal = document.getElementById('visit-detail-modal');
            modal.classList.remove('hidden');
            document.getElementById('modal-store-notes').innerHTML = '<div class="text-center"><svg class="animate-spin h-6 w-6 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch(`/api/visit/${id}`);
                if (!response.ok) throw new Error('Failed');
                const v = await response.json();
                displayVisitDetail(v);
            } catch (e) {
                document.getElementById('modal-store-notes').innerHTML = `<div class="text-red-600">Error: ${e.message}</div>`;
            }
        }

        // Store current visit for note deletion
        let currentVisitDetail = null;

        function displayVisitDetail(v) {
            currentVisitDetail = v;

            // Format notes with edit and delete buttons
            const formatNotes = (notes, noteType) => {
                if (!notes) return '(None)';
                let items = [];
                if (Array.isArray(notes)) {
                    if (notes.length === 0) return '(None)';
                    items = notes.map(n => {
                        if (typeof n === 'object' && n.id) {
                            return { id: n.id, text: n.text };
                        } else {
                            return { id: null, text: typeof n === 'object' ? n.text : n };
                        }
                    });
                } else if (typeof notes === 'string') {
                    items = notes.split('\n').filter(n => n.trim()).map(n => ({ id: null, text: n }));
                }
                if (items.length === 0) return '(None)';
                return items.map(n => {
                    const editBtn = n.id ? `<button onclick="startEditNote('${noteType}', ${n.id}, this)" class="ml-2 text-walmart-blue hover:text-walmart-dark-blue opacity-0 group-hover:opacity-100 transition-opacity" title="Edit note"><i class="fas fa-edit text-xs"></i></button>` : '';
                    const deleteBtn = n.id ? `<button onclick="deleteNote('${noteType}', ${n.id})" class="ml-1 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Delete note"><i class="fas fa-trash-alt text-xs"></i></button>` : '';
                    return `<li class="flex items-start group note-item" data-note-id="${n.id}" data-note-type="${noteType}">
                        <i class="fas fa-check-circle text-walmart-blue mt-1 mr-2 text-sm flex-shrink-0"></i>
                        <span class="flex-1 note-text">${escapeHtml(n.text)}</span>
                        <div class="flex items-center flex-shrink-0">${editBtn}${deleteBtn}</div>
                    </li>`;
                }).join('');
            };

            let ratingClass = 'bg-gray-100 text-gray-800';
            if (v.rating === 'Green') ratingClass = 'bg-green-100 text-green-800';
            else if (v.rating === 'Yellow') ratingClass = 'bg-yellow-100 text-yellow-800';
            else if (v.rating === 'Red') ratingClass = 'bg-red-100 text-red-800';
            else if (v.rating === 'Unknown') ratingClass = 'bg-gray-100 text-gray-800';

            document.getElementById('modal-store-nbr').textContent = `#${v.storeNbr || '?'}`;
            document.getElementById('modal-date').textContent = v.calendar_date ? new Date(v.calendar_date).toLocaleDateString() : 'N/A';
            const ratingEl = document.getElementById('modal-rating');
            ratingEl.className = `inline-block px-3 py-1 rounded-full text-xs font-bold ${ratingClass}`;
            ratingEl.textContent = v.rating || 'Unknown';

            const storeNotes = formatNotes(v.store_notes, 'store');
            document.getElementById('modal-store-notes').innerHTML = storeNotes === '(None)' ? '<p class="text-gray-400 italic">(None)</p>' : `<ul class="space-y-2">${storeNotes}</ul>`;

            const mktNotes = formatNotes(v.mkt_notes, 'market');
            document.getElementById('modal-mkt-notes').innerHTML = mktNotes === '(None)' ? '<p class="text-gray-400 italic">(None)</p>' : `<ul class="space-y-2">${mktNotes}</ul>`;

            const good = formatNotes(v.good, 'good');
            document.getElementById('modal-good').innerHTML = good === '(None)' ? '<p class="text-gray-400 italic">(None)</p>' : `<ul class="space-y-2">${good}</ul>`;

            const top3 = formatNotes(v.top_3, 'improvement');
            document.getElementById('modal-top3').innerHTML = top3 === '(None)' ? '<p class="text-gray-400 italic">(None)</p>' : `<ul class="space-y-2">${top3}</ul>`;

            const metrics = [
                { label: 'Sales Comp (Yest)', value: v.sales_comp_yest, fmt: '%' },
                { label: 'Sales Index (Yest)', value: v.sales_index_yest },
                { label: 'Sales Comp (WTD)', value: v.sales_comp_wtd, fmt: '%' },
                { label: 'Sales Index (WTD)', value: v.sales_index_wtd },
                { label: 'Vizpick', value: v.vizpick, fmt: '%' },
                { label: 'Overstock', value: v.overstock },
                { label: 'Picks', value: v.picks },
                { label: 'FTPR', value: v.ftpr, fmt: '%' },
            ];
            const metricsContainer = document.getElementById('modal-metrics');
            const validMetrics = metrics.filter(m => m.value !== null && m.value !== undefined);
            metricsContainer.innerHTML = validMetrics.length > 0
                ? validMetrics.map(m => `<div class="bg-blue-50 rounded-lg p-3"><p class="text-xs font-semibold text-gray-600">${m.label}</p><p class="text-lg font-bold text-walmart-blue">${m.value}${m.fmt || ''}</p></div>`).join('')
                : '<p class="col-span-full text-gray-400 italic text-sm">No metrics recorded</p>';

            if (v.created_at) document.getElementById('modal-created-at').textContent = new Date(v.created_at).toLocaleString();

            // Load photos for this visit
            loadVisitPhotos(v.id);
        }

        async function loadVisitPhotos(visitId) {
            const photosSection = document.getElementById('modal-photos-section');
            const photosGrid = document.getElementById('modal-photos-grid');

            try {
                const response = await fetch(`/api/visits/${visitId}/photos`);
                if (!response.ok) throw new Error('Failed to load photos');

                const photos = await response.json();

                if (photos.length === 0) {
                    photosSection.classList.add('hidden');
                    return;
                }

                photosSection.classList.remove('hidden');
                photosGrid.innerHTML = photos.map(p => `
                    <img src="${p.gcs_url}" alt="${p.filename}"
                         class="w-full h-24 object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity"
                         onclick="openPhotoViewer('${p.gcs_url}')">
                `).join('');

            } catch (e) {
                console.error('Error loading visit photos:', e);
                photosSection.classList.add('hidden');
            }
        }

        function closeVisitDetailModal() {
            document.getElementById('visit-detail-modal').classList.add('hidden');
            document.getElementById('modal-photos-section').classList.add('hidden');
        }

        async function deleteNote(noteType, noteId) {
            if (!confirm('Are you sure you want to delete this note?')) return;

            try {
                const response = await fetch(`/api/notes/${noteType}/${noteId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to delete note');
                }

                // Refresh the visit detail to show updated notes
                if (currentVisitDetail && currentVisitDetail.id) {
                    const visitResponse = await fetch(`/api/visit/${currentVisitDetail.id}`);
                    if (visitResponse.ok) {
                        const updatedVisit = await visitResponse.json();
                        displayVisitDetail(updatedVisit);
                    }
                }

                // Also refresh the visits list
                loadVisits();

            } catch (e) {
                console.error('Error deleting note:', e);
                alert('Error deleting note: ' + e.message);
            }
        }

        function startEditNote(noteType, noteId, btnElement) {
            // Find the note item container
            const noteItem = btnElement.closest('.note-item');
            if (!noteItem) return;

            const noteTextSpan = noteItem.querySelector('.note-text');
            if (!noteTextSpan) return;

            const currentText = noteTextSpan.textContent;
            const btnContainer = btnElement.closest('div');

            // Replace text with input
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'flex-1 border border-walmart-blue rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-walmart-blue';
            input.dataset.originalText = currentText;

            noteTextSpan.replaceWith(input);
            input.focus();
            input.select();

            // Replace buttons with save/cancel
            btnContainer.innerHTML = `
                <button onclick="saveEditNote('${noteType}', ${noteId}, this)" class="ml-2 text-green-600 hover:text-green-800" title="Save">
                    <i class="fas fa-check text-xs"></i>
                </button>
                <button onclick="cancelEditNote(this)" class="ml-1 text-gray-500 hover:text-gray-700" title="Cancel">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;

            // Handle enter key to save
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEditNote(noteType, noteId, btnContainer.querySelector('button'));
                } else if (e.key === 'Escape') {
                    cancelEditNote(btnContainer.querySelector('button:last-child'));
                }
            });
        }

        async function saveEditNote(noteType, noteId, btnElement) {
            const noteItem = btnElement.closest('.note-item');
            if (!noteItem) return;

            const input = noteItem.querySelector('input');
            if (!input) return;

            const newText = input.value.trim();
            if (!newText) {
                alert('Note text cannot be empty');
                return;
            }

            try {
                const response = await fetch(`/api/notes/${noteType}/${noteId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: newText })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to update note');
                }

                // Refresh the visit detail to show updated notes
                if (currentVisitDetail && currentVisitDetail.id) {
                    const visitResponse = await fetch(`/api/visit/${currentVisitDetail.id}`);
                    if (visitResponse.ok) {
                        const updatedVisit = await visitResponse.json();
                        displayVisitDetail(updatedVisit);
                    }
                }

                // Also refresh the visits list
                loadVisits();

            } catch (e) {
                console.error('Error updating note:', e);
                alert('Error updating note: ' + e.message);
            }
        }

        function cancelEditNote(btnElement) {
            const noteItem = btnElement.closest('.note-item');
            if (!noteItem) return;

            const input = noteItem.querySelector('input');
            if (!input) return;

            const originalText = input.dataset.originalText || '';
            const noteType = noteItem.dataset.noteType;
            const noteId = noteItem.dataset.noteId;

            // Restore the original text span
            const span = document.createElement('span');
            span.className = 'flex-1 note-text';
            span.textContent = originalText;
            input.replaceWith(span);

            // Restore original buttons
            const btnContainer = btnElement.closest('div');
            btnContainer.innerHTML = `
                <button onclick="startEditNote('${noteType}', ${noteId}, this)" class="ml-2 text-walmart-blue hover:text-walmart-dark-blue opacity-0 group-hover:opacity-100 transition-opacity" title="Edit note">
                    <i class="fas fa-edit text-xs"></i>
                </button>
                <button onclick="deleteNote('${noteType}', ${noteId})" class="ml-1 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Delete note">
                    <i class="fas fa-trash-alt text-xs"></i>
                </button>
            `;
        }

        async function deleteVisit() {
            if (!currentVisitDetail || !currentVisitDetail.id) {
                alert('No visit selected');
                return;
            }

            const storeNbr = currentVisitDetail.storeNbr || '?';
            const date = currentVisitDetail.calendar_date ? new Date(currentVisitDetail.calendar_date).toLocaleDateString() : 'unknown date';

            if (!confirm(`Are you sure you want to delete this entire visit?\n\nStore #${storeNbr} - ${date}\n\nThis will remove all notes and data for this visit.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/visits/${currentVisitDetail.id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to delete visit');
                }

                // Close modal and refresh lists
                closeVisitDetailModal();
                loadVisits();
                loadDashboard();

            } catch (e) {
                console.error('Error deleting visit:', e);
                alert('Error deleting visit: ' + e.message);
            }
        }

        document.getElementById('visit-detail-modal').addEventListener('click', function(e) {
            if (e.target === this) closeVisitDetailModal();
        });

        // --- Champions ---
        let allChampions = [];
        let editingChampionId = null;

        async function loadChampions() {
            const listEl = document.getElementById('champions-list');
            const emptyEl = document.getElementById('champions-empty');
            listEl.innerHTML = '<div class="p-8 text-center"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch('/api/champions');
                if (!response.ok) throw new Error('Failed to load champions');
                allChampions = await response.json();

                renderChampions();
            } catch (e) {
                console.error('Error loading champions:', e);
                listEl.innerHTML = '<div class="p-8 text-center text-red-500">Error loading champions</div>';
            }
        }

        function renderChampions() {
            const listEl = document.getElementById('champions-list');
            const emptyEl = document.getElementById('champions-empty');
            const tableContainer = listEl.parentElement;

            if (allChampions.length === 0) {
                tableContainer.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                return;
            }

            tableContainer.classList.remove('hidden');
            emptyEl.classList.add('hidden');

            listEl.innerHTML = allChampions.map(c => `
                <div class="grid grid-cols-12 gap-2 px-4 py-3 hover:bg-gray-50 items-center">
                    <div class="col-span-4 font-medium text-gray-900">${escapeHtml(c.name)}</div>
                    <div class="col-span-6 text-gray-600">${escapeHtml(c.responsibility)}</div>
                    <div class="col-span-2 flex justify-center gap-2">
                        <button onclick="editChampion(${c.id})" class="text-walmart-blue hover:text-walmart-dark-blue p-1">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteChampion(${c.id})" class="text-red-500 hover:text-red-700 p-1">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showAddChampionForm() {
            editingChampionId = null;
            document.getElementById('champion-form-title').textContent = 'Add Champion';
            document.getElementById('champion-name').value = '';
            document.getElementById('champion-responsibility').value = '';
            document.getElementById('champion-edit-id').value = '';
            document.getElementById('champion-form').classList.remove('hidden');
            document.getElementById('champion-name').focus();
        }

        function hideChampionForm() {
            document.getElementById('champion-form').classList.add('hidden');
            editingChampionId = null;
        }

        function editChampion(id) {
            const champion = allChampions.find(c => c.id === id);
            if (!champion) return;

            editingChampionId = id;
            document.getElementById('champion-form-title').textContent = 'Edit Champion';
            document.getElementById('champion-name').value = champion.name;
            document.getElementById('champion-responsibility').value = champion.responsibility;
            document.getElementById('champion-edit-id').value = id;
            document.getElementById('champion-form').classList.remove('hidden');
            document.getElementById('champion-name').focus();
        }

        async function saveChampion() {
            const name = document.getElementById('champion-name').value.trim();
            const responsibility = document.getElementById('champion-responsibility').value.trim();

            if (!name || !responsibility) {
                alert('Please fill in both Name and Champion Of fields');
                return;
            }

            try {
                let response;
                if (editingChampionId) {
                    // Update existing
                    response = await fetch(`/api/champions/${editingChampionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, responsibility })
                    });
                } else {
                    // Create new
                    response = await fetch('/api/champions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, responsibility })
                    });
                }

                if (!response.ok) throw new Error('Failed to save');

                hideChampionForm();
                await loadChampions();
            } catch (e) {
                console.error('Error saving champion:', e);
                alert('Failed to save champion');
            }
        }

        async function deleteChampion(id) {
            if (!confirm('Are you sure you want to delete this champion?')) return;

            try {
                const response = await fetch(`/api/champions/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete');

                await loadChampions();
            } catch (e) {
                console.error('Error deleting champion:', e);
                alert('Failed to delete champion');
            }
        }

        // --- Mentee Circle ---
        let allMentees = [];
        let editingMenteeId = null;

        async function loadMentees() {
            const listEl = document.getElementById('mentees-list');
            const emptyEl = document.getElementById('mentees-empty');
            listEl.innerHTML = '<div class="p-8 text-center"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch('/api/mentees');
                if (!response.ok) throw new Error('Failed to load mentees');
                allMentees = await response.json();

                renderMentees();
            } catch (e) {
                console.error('Error loading mentees:', e);
                listEl.innerHTML = '<div class="p-8 text-center text-red-500">Error loading mentees</div>';
            }
        }

        function renderMentees() {
            const listEl = document.getElementById('mentees-list');
            const emptyEl = document.getElementById('mentees-empty');
            const tableContainer = listEl.parentElement;

            if (allMentees.length === 0) {
                tableContainer.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                return;
            }

            tableContainer.classList.remove('hidden');
            emptyEl.classList.add('hidden');

            listEl.innerHTML = allMentees.map(m => `
                <div class="grid grid-cols-12 gap-2 px-4 py-3 hover:bg-gray-50 items-start">
                    <div class="col-span-4">
                        <div class="font-medium text-gray-900">${escapeHtml(m.name)}</div>
                        <div class="text-xs text-gray-500">${escapeHtml(m.cell_number || '')}</div>
                    </div>
                    <div class="col-span-2 text-gray-600 font-medium">#${escapeHtml(m.store_nbr || '')}</div>
                    <div class="col-span-4">
                        <div class="text-gray-600 text-sm">${escapeHtml(m.position || '')}</div>
                        ${m.notes ? `<div class="text-xs text-gray-400 mt-1 italic line-clamp-2">${escapeHtml(m.notes)}</div>` : ''}
                    </div>
                    <div class="col-span-2 flex justify-center gap-2">
                        <button onclick="editMentee(${m.id})" class="text-walmart-blue hover:text-walmart-dark-blue p-1">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteMentee(${m.id})" class="text-red-500 hover:text-red-700 p-1">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showAddMenteeForm() {
            editingMenteeId = null;
            document.getElementById('mentee-form-title').textContent = 'Add Mentee';
            document.getElementById('mentee-name').value = '';
            document.getElementById('mentee-store').value = '';
            document.getElementById('mentee-position').value = '';
            document.getElementById('mentee-cell').value = '';
            document.getElementById('mentee-notes').value = '';
            document.getElementById('mentee-edit-id').value = '';
            document.getElementById('mentee-form').classList.remove('hidden');
            document.getElementById('mentee-name').focus();
        }

        function hideMenteeForm() {
            document.getElementById('mentee-form').classList.add('hidden');
            editingMenteeId = null;
        }

        function editMentee(id) {
            const mentee = allMentees.find(m => m.id === id);
            if (!mentee) return;

            editingMenteeId = id;
            document.getElementById('mentee-form-title').textContent = 'Edit Mentee';
            document.getElementById('mentee-name').value = mentee.name;
            document.getElementById('mentee-store').value = mentee.store_nbr || '';
            document.getElementById('mentee-position').value = mentee.position || '';
            document.getElementById('mentee-cell').value = mentee.cell_number || '';
            document.getElementById('mentee-notes').value = mentee.notes || '';
            document.getElementById('mentee-edit-id').value = id;
            document.getElementById('mentee-form').classList.remove('hidden');
            document.getElementById('mentee-name').focus();
        }

        async function saveMentee() {
            const name = document.getElementById('mentee-name').value.trim();
            const store = document.getElementById('mentee-store').value.trim();
            const position = document.getElementById('mentee-position').value.trim();
            const cell = document.getElementById('mentee-cell').value.trim();
            const notes = document.getElementById('mentee-notes').value.trim();

            if (!name) {
                alert('Name is required');
                return;
            }

            const payload = { 
                name: name,
                store_nbr: store,
                position: position,
                cell_number: cell,
                notes: notes
            };

            try {
                let response;
                if (editingMenteeId) {
                    // Update existing
                    response = await fetch(`/api/mentees/${editingMenteeId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    // Create new
                    response = await fetch('/api/mentees', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                if (!response.ok) throw new Error('Failed to save');

                hideMenteeForm();
                await loadMentees();
            } catch (e) {
                console.error('Error saving mentee:', e);
                alert('Failed to save mentee');
            }
        }

        async function deleteMentee(id) {
            if (!confirm('Are you sure you want to delete this mentee?')) return;

            try {
                const response = await fetch(`/api/mentees/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete');

                await loadMentees();
            } catch (e) {
                console.error('Error deleting mentee:', e);
                alert('Failed to delete mentee');
            }
        }

        // --- Enablers ---
        let allEnablers = [];
        let editingEnablerId = null;
        let enablerViewFilter = 'all';
        let enablerStatusFilter = 'all';
        let currentEnablerWeekInfo = null;

        async function loadEnablers() {
            const containerEl = document.getElementById('enablers-container');
            const emptyEl = document.getElementById('enablers-empty');
            containerEl.innerHTML = '<div class="p-8 text-center"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                // Fetch current week info and enablers in parallel
                const [weekResponse, enablersResponse] = await Promise.all([
                    fetch('/api/enablers/current-week'),
                    fetch('/api/enablers')
                ]);

                if (weekResponse.ok) {
                    currentEnablerWeekInfo = await weekResponse.json();
                    // Update the hint in the form
                    const hintEl = document.getElementById('enabler-current-week-hint');
                    if (hintEl && currentEnablerWeekInfo) {
                        hintEl.textContent = `(Current: Week ${currentEnablerWeekInfo.week_number})`;
                    }
                }

                if (!enablersResponse.ok) throw new Error('Failed to load enablers');
                allEnablers = await enablersResponse.json();

                renderEnablers();
            } catch (e) {
                console.error('Error loading enablers:', e);
                containerEl.innerHTML = '<div class="p-8 text-center text-red-500">Error loading enablers</div>';
            }
        }

        function getEnablerStores() {
            // Use same market stores as Gold Stars
            return getMarketStores();
        }

        function getMondayOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getWeekDateRange(mondayStr) {
            const monday = new Date(mondayStr + 'T00:00:00');
            const sunday = new Date(monday);
            sunday.setDate(sunday.getDate() + 6);
            const options = { month: 'short', day: 'numeric' };
            return `${monday.toLocaleDateString('en-US', options)} - ${sunday.toLocaleDateString('en-US', options)}`;
        }

        function filterEnablersByView(view) {
            enablerViewFilter = view;

            // Update button styles
            document.querySelectorAll('.enabler-view-btn').forEach(btn => {
                btn.classList.remove('bg-walmart-blue', 'text-white');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            const activeBtn = document.getElementById(`enabler-view-${view}`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                activeBtn.classList.add('bg-walmart-blue', 'text-white');
            }

            renderEnablers();
        }

        function filterEnablersByStatus(status) {
            enablerStatusFilter = status;

            // Update button styles
            document.querySelectorAll('.enabler-status-btn').forEach(btn => {
                btn.classList.remove('bg-gray-200', 'text-gray-800');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            const activeBtn = document.getElementById(`enabler-status-${status}`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                activeBtn.classList.add('bg-gray-200', 'text-gray-800');
            }

            renderEnablers();
        }

        function getStatusBadgeHTML(status) {
            const statusConfig = {
                'idea': { color: 'bg-gray-100 text-gray-700', icon: 'fa-lightbulb', label: 'Idea' },
                'slide_made': { color: 'bg-blue-100 text-blue-700', icon: 'fa-file-powerpoint', label: 'Slide Made' },
                'presented': { color: 'bg-green-100 text-green-700', icon: 'fa-check-circle', label: 'Presented' }
            };
            const config = statusConfig[status] || statusConfig['idea'];
            return `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${config.color}"><i class="fas ${config.icon} mr-1"></i>${config.label}</span>`;
        }

        function renderEnablers() {
            const containerEl = document.getElementById('enablers-container');
            const emptyEl = document.getElementById('enablers-empty');
            const stores = getEnablerStores();

            // Get current week number
            const currentWeekNum = currentEnablerWeekInfo ? currentEnablerWeekInfo.week_number : null;

            // Apply filters
            let filtered = allEnablers;

            // View filter
            if (enablerViewFilter === 'week') {
                filtered = filtered.filter(e => e.week_number === currentWeekNum);
            } else if (enablerViewFilter === 'planned') {
                filtered = filtered.filter(e => e.week_number && e.week_number > currentWeekNum);
            }

            // Status filter
            if (enablerStatusFilter !== 'all') {
                filtered = filtered.filter(e => e.status === enablerStatusFilter);
            }

            if (filtered.length === 0) {
                containerEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                return;
            }

            containerEl.classList.remove('hidden');
            emptyEl.classList.add('hidden');

            // Group by week number
            const grouped = {};
            const noWeek = [];

            filtered.forEach(e => {
                if (e.week_number) {
                    if (!grouped[e.week_number]) grouped[e.week_number] = { enablers: [], week_date: e.week_date };
                    grouped[e.week_number].enablers.push(e);
                } else {
                    noWeek.push(e);
                }
            });

            // Sort weeks descending by week number
            const sortedWeeks = Object.keys(grouped).sort((a, b) => parseInt(b) - parseInt(a));

            let html = '';

            // Render grouped by week
            sortedWeeks.forEach(weekNum => {
                const weekData = grouped[weekNum];
                const isCurrentWeek = parseInt(weekNum) === currentWeekNum;

                html += `
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <h3 class="font-semibold text-gray-700">Week ${weekNum}</h3>
                            <span class="text-sm text-gray-400">${getWeekDateRange(weekData.week_date)}</span>
                            ${isCurrentWeek ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-walmart-blue text-white">Current</span>' : ''}
                        </div>
                        ${weekData.enablers.map(e => renderEnablerCard(e, stores)).join('')}
                    </div>
                `;
            });

            // Render unassigned enablers
            if (noWeek.length > 0) {
                html += `
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-500 mb-3">Unassigned</h3>
                        ${noWeek.map(e => renderEnablerCard(e, stores)).join('')}
                    </div>
                `;
            }

            containerEl.innerHTML = html;
        }

        function renderEnablerCard(enabler, stores) {
            const completedCount = enabler.completed_count || 0;
            const totalStores = stores.length;
            const progressPercent = totalStores > 0 ? Math.round((completedCount / totalStores) * 100) : 0;

            return `
                <div class="bg-white rounded-xl shadow-sm mb-3 overflow-hidden">
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-semibold text-gray-900">${escapeHtml(enabler.title)}</h4>
                                    ${getStatusBadgeHTML(enabler.status)}
                                </div>
                                ${enabler.description ? `<p class="text-sm text-gray-600 line-clamp-2">${escapeHtml(enabler.description)}</p>` : ''}
                                ${enabler.source ? `<p class="text-xs text-gray-400 mt-1">Source: ${escapeHtml(enabler.source)}</p>` : ''}
                            </div>
                            <div class="flex gap-1 ml-3">
                                <button onclick="editEnabler(${enabler.id})" class="text-walmart-blue hover:text-walmart-dark-blue p-1.5" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteEnabler(${enabler.id})" class="text-red-500 hover:text-red-700 p-1.5" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Progress bar and completion count -->
                        <div class="mt-3">
                            <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                <span>Store Completion</span>
                                <span>${completedCount}/${totalStores} stores</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>

                        <!-- Toggle to expand store checkboxes -->
                        <button onclick="toggleEnablerStores(${enabler.id})" class="mt-3 text-sm text-walmart-blue hover:text-walmart-dark-blue flex items-center gap-1">
                            <i class="fas fa-chevron-down transition-transform" id="enabler-chevron-${enabler.id}"></i>
                            <span>Store Details</span>
                        </button>
                    </div>

                    <!-- Store checkboxes (hidden by default) -->
                    <div id="enabler-stores-${enabler.id}" class="hidden border-t border-gray-100 bg-gray-50 p-4">
                        <div class="grid grid-cols-3 gap-2">
                            ${stores.map(store => {
                                const isCompleted = enabler.completions && enabler.completions[store] && enabler.completions[store].completed;
                                return `
                                    <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-100 ${isCompleted ? 'bg-green-50' : ''}">
                                        <input type="checkbox"
                                            ${isCompleted ? 'checked' : ''}
                                            onchange="toggleEnablerCompletion(${enabler.id}, '${store}', this.checked)"
                                            class="rounded border-gray-300 text-walmart-blue focus:ring-walmart-blue">
                                        <span class="text-sm font-medium ${isCompleted ? 'text-green-700' : 'text-gray-700'}">#${store}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Quick status change -->
                    <div class="border-t border-gray-100 px-4 py-2 bg-gray-50 flex items-center justify-between">
                        <span class="text-xs text-gray-500">Status:</span>
                        <select onchange="updateEnablerStatus(${enabler.id}, this.value)" class="text-sm border-0 bg-transparent focus:ring-0 cursor-pointer text-gray-700 font-medium">
                            <option value="idea" ${enabler.status === 'idea' ? 'selected' : ''}>Idea</option>
                            <option value="slide_made" ${enabler.status === 'slide_made' ? 'selected' : ''}>Slide Made</option>
                            <option value="presented" ${enabler.status === 'presented' ? 'selected' : ''}>Presented</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function toggleEnablerStores(id) {
            const storesEl = document.getElementById(`enabler-stores-${id}`);
            const chevronEl = document.getElementById(`enabler-chevron-${id}`);

            if (storesEl.classList.contains('hidden')) {
                storesEl.classList.remove('hidden');
                chevronEl.classList.add('rotate-180');
            } else {
                storesEl.classList.add('hidden');
                chevronEl.classList.remove('rotate-180');
            }
        }

        async function toggleEnablerCompletion(enablerId, storeNbr, completed) {
            try {
                const response = await fetch(`/api/enablers/${enablerId}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ store_nbr: storeNbr, completed: completed })
                });

                if (!response.ok) throw new Error('Failed to toggle');

                // Update local data
                const enabler = allEnablers.find(e => e.id === enablerId);
                if (enabler) {
                    if (!enabler.completions) enabler.completions = {};
                    enabler.completions[storeNbr] = { completed: completed, completed_at: completed ? new Date().toISOString() : null };
                    enabler.completed_count = Object.values(enabler.completions).filter(c => c.completed).length;
                    renderEnablers();
                }
            } catch (e) {
                console.error('Error toggling enabler completion:', e);
                alert('Failed to update completion status');
                await loadEnablers(); // Reload to reset state
            }
        }

        async function updateEnablerStatus(id, status) {
            try {
                const response = await fetch(`/api/enablers/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });

                if (!response.ok) throw new Error('Failed to update status');

                // Update local data
                const enabler = allEnablers.find(e => e.id === id);
                if (enabler) {
                    enabler.status = status;
                    renderEnablers();
                }
            } catch (e) {
                console.error('Error updating enabler status:', e);
                alert('Failed to update status');
                await loadEnablers();
            }
        }

        function showAddEnablerForm() {
            editingEnablerId = null;
            document.getElementById('enabler-form-title').textContent = 'Add Enabler';
            document.getElementById('enabler-title').value = '';
            document.getElementById('enabler-description').value = '';
            document.getElementById('enabler-source').value = '';
            document.getElementById('enabler-status').value = 'idea';
            document.getElementById('enabler-week').value = '';
            document.getElementById('enabler-edit-id').value = '';
            document.getElementById('enabler-form').classList.remove('hidden');
            document.getElementById('enabler-title').focus();
        }

        function hideEnablerForm() {
            document.getElementById('enabler-form').classList.add('hidden');
            editingEnablerId = null;
        }

        function editEnabler(id) {
            const enabler = allEnablers.find(e => e.id === id);
            if (!enabler) return;

            editingEnablerId = id;
            document.getElementById('enabler-form-title').textContent = 'Edit Enabler';
            document.getElementById('enabler-title').value = enabler.title;
            document.getElementById('enabler-description').value = enabler.description || '';
            document.getElementById('enabler-source').value = enabler.source || '';
            document.getElementById('enabler-status').value = enabler.status || 'idea';
            document.getElementById('enabler-week').value = enabler.week_number || '';
            document.getElementById('enabler-edit-id').value = id;
            document.getElementById('enabler-form').classList.remove('hidden');
            document.getElementById('enabler-title').focus();
        }

        async function saveEnabler() {
            const title = document.getElementById('enabler-title').value.trim();
            const description = document.getElementById('enabler-description').value.trim();
            const source = document.getElementById('enabler-source').value.trim();
            const status = document.getElementById('enabler-status').value;
            const weekNumber = document.getElementById('enabler-week').value;

            if (!title) {
                alert('Title is required');
                return;
            }

            const payload = {
                title: title,
                description: description,
                source: source,
                status: status,
                week_number: weekNumber ? parseInt(weekNumber) : null
            };

            try {
                let response;
                if (editingEnablerId) {
                    // Update existing
                    response = await fetch(`/api/enablers/${editingEnablerId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    // Create new
                    response = await fetch('/api/enablers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                if (!response.ok) throw new Error('Failed to save');

                hideEnablerForm();
                await loadEnablers();
            } catch (e) {
                console.error('Error saving enabler:', e);
                alert('Failed to save enabler');
            }
        }

        async function deleteEnabler(id) {
            if (!confirm('Are you sure you want to delete this enabler? This will also remove all store completion records.')) return;

            try {
                const response = await fetch(`/api/enablers/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete');

                await loadEnablers();
            } catch (e) {
                console.error('Error deleting enabler:', e);
                alert('Failed to delete enabler');
            }
        }

        // --- Status ---
        async function loadStatus() {
            // Reset all status indicators
            const statusElements = [
                'status-server-status', 'status-db-status', 'status-ai-status', 'status-connection'
            ];
            statusElements.forEach(id => {
                const el = document.getElementById(id);
                el.textContent = 'Checking...';
                el.className = 'px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-600';
            });

            const startTime = performance.now();

            try {
                const response = await fetch('/api/status');
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);

                if (!response.ok) throw new Error('Failed to fetch status');

                const data = await response.json();

                // Server Status
                setStatusBadge('status-server-status', data.server.status, data.server.status === 'online');
                document.getElementById('status-server-env').textContent = data.server.environment || '--';
                document.getElementById('status-server-version').textContent = data.server.version || '--';
                document.getElementById('status-server-timestamp').textContent =
                    data.server.timestamp ? new Date(data.server.timestamp).toLocaleString() : '--';

                // Database Status
                setStatusBadge('status-db-status', data.database.status, data.database.status === 'connected');
                document.getElementById('status-db-host').textContent =
                    `${data.database.host}:${data.database.port}`;
                document.getElementById('status-db-name').textContent = data.database.name || '--';
                document.getElementById('status-db-latency').textContent =
                    data.database.latency_ms ? `${data.database.latency_ms} ms` : '--';

                // Vertex AI Status
                setStatusBadge('status-ai-status', data.vertex_ai.status,
                    data.vertex_ai.status === 'configured');
                document.getElementById('status-ai-project').textContent = data.vertex_ai.project || '--';
                document.getElementById('status-ai-location').textContent = data.vertex_ai.location || '--';

                // Connection Test
                document.getElementById('status-api-latency').textContent = `${latency} ms`;
                setStatusBadge('status-connection', 'connected', true);

                // Endpoints
                const endpointsEl = document.getElementById('status-endpoints');
                if (data.endpoints && data.endpoints.length > 0) {
                    endpointsEl.innerHTML = data.endpoints.map(ep => `
                        <div class="flex justify-between items-center py-1 px-2 bg-gray-50 rounded">
                            <span class="font-mono text-gray-700">${ep.path}</span>
                            <span class="text-xs text-gray-500">${ep.methods.join(', ')}</span>
                        </div>
                    `).join('');
                } else {
                    endpointsEl.innerHTML = '<div class="text-gray-500">No endpoints available</div>';
                }

            } catch (e) {
                console.error('Error loading status:', e);
                setStatusBadge('status-server-status', 'offline', false);
                setStatusBadge('status-connection', 'disconnected', false);
                document.getElementById('status-api-latency').textContent = 'Failed';
                document.getElementById('status-endpoints').innerHTML =
                    '<div class="text-red-500">Unable to connect to server</div>';
            }
        }

        function setStatusBadge(elementId, text, isGood) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            if (isGood) {
                el.className = 'px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800';
            } else {
                el.className = 'px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800';
            }
        }

        // --- Issues Pull-to-Refresh ---
        let touchStartY = 0;
        let pullDistance = 0;
        let isRefreshing = false;
        const PULL_THRESHOLD = 100;

        function handlePullToRefreshStart(e) {
            const view = document.getElementById('view-issues');
            if (view.scrollTop > 0) return; // Only trigger if at top
            touchStartY = e.touches[0].clientY;
            isRefreshing = false;
        }

        function handlePullToRefreshMove(e) {
            const view = document.getElementById('view-issues');
            if (view.scrollTop > 0) return;

            const touchY = e.touches[0].clientY;
            const diff = touchY - touchStartY;

            if (diff > 0) {
                pullDistance = diff;
                // Add resistance
                const resistance = Math.min(pullDistance * 0.5, 150);
                
                const indicator = document.getElementById('pull-refresh-indicator');
                const icon = document.getElementById('pull-refresh-icon');
                
                indicator.style.opacity = Math.min(resistance / 50, 1);
                indicator.style.transform = `translateY(${resistance}px)`;
                icon.style.transform = `rotate(${Math.min(resistance * 2, 180)}deg)`;
                
                if (resistance > 60) { // Visual threshold
                    icon.classList.remove('fa-arrow-down');
                    icon.classList.add('fa-rotate-right');
                } else {
                    icon.classList.remove('fa-rotate-right');
                    icon.classList.add('fa-arrow-down');
                }
            }
        }

        async function handlePullToRefreshEnd(e) {
            const view = document.getElementById('view-issues');
            if (view.scrollTop > 0) return;

            const indicator = document.getElementById('pull-refresh-indicator');
            const icon = document.getElementById('pull-refresh-icon');

            if (pullDistance > PULL_THRESHOLD && !isRefreshing) {
                isRefreshing = true;
                icon.classList.add('fa-spin');
                
                // Keep indicator visible during load
                indicator.style.transform = `translateY(60px)`;
                
                await loadIssues();
                
                // Reset
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                    indicator.style.opacity = '0';
                    indicator.style.transform = 'translateY(-10px)';
                    isRefreshing = false;
                    pullDistance = 0;
                }, 500);
            } else {
                // Cancel pull
                indicator.style.opacity = '0';
                indicator.style.transform = 'translateY(-10px)';
                pullDistance = 0;
            }
        }

        // --- Issues/Feedback ---
        let allIssues = [];
        let currentIssueFilter = 'all';
        let issuesCompletedExpanded = false;
        let selectedFeedbackType = null;

        async function loadIssues() {
            const listEl = document.getElementById('issues-list');
            listEl.innerHTML = '<div class="text-center py-8"><svg class="animate-spin h-8 w-8 text-walmart-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch('/api/issues');
                if (!response.ok) throw new Error('Failed to load issues');
                allIssues = await response.json();
                renderIssues();
            } catch (e) {
                console.error('Error loading issues:', e);
                listEl.innerHTML = '<div class="text-center py-8 text-red-500">Error loading issues</div>';
            }
        }

        function renderIssues() {
            const listEl = document.getElementById('issues-list');
            const emptyEl = document.getElementById('issues-empty');
            const completedSection = document.getElementById('issues-completed-section');
            const completedContainer = document.getElementById('issues-completed-container');
            const completedCount = document.getElementById('issues-completed-count');

            // Filter issues
            let filteredIssues = allIssues;
            if (currentIssueFilter !== 'all') {
                filteredIssues = allIssues.filter(i => i.type === currentIssueFilter);
            }

            // Separate active and completed
            const completedIssues = filteredIssues.filter(i => i.status === 'completed');
            
            // Group active issues
            const newIssues = filteredIssues.filter(i => i.status === 'new');
            const inProgressIssues = filteredIssues.filter(i => i.status === 'in_progress');
            const stalledIssues = filteredIssues.filter(i => i.status === 'stalled');
            
            const totalActive = newIssues.length + inProgressIssues.length + stalledIssues.length;

            // Handle Empty State (Active & Completed)
            if (totalActive === 0 && completedIssues.length === 0) {
                listEl.innerHTML = '';
                emptyEl.classList.remove('hidden');
                completedSection.classList.add('hidden');
                return;
            }
            
            emptyEl.classList.add('hidden');
            
            // Render active groups
            if (totalActive === 0) {
                listEl.innerHTML = '<div class="text-center py-8 text-gray-500">No active issues</div>';
            } else {
                let contentHtml = '';
                
                const renderGroup = (title, issues, dotColor) => {
                    if (issues.length === 0) return '';
                    return `
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3 px-1">
                                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center">
                                    <span class="w-2 h-2 rounded-full ${dotColor} mr-2"></span>
                                    ${title}
                                </h3>
                                <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-0.5 rounded-full">${issues.length}</span>
                            </div>
                            <div class="space-y-3">
                                ${issues.map(i => renderIssueCard(i)).join('')}
                            </div>
                        </div>
                    `;
                };

                contentHtml += renderGroup('New', newIssues, 'bg-blue-500');
                contentHtml += renderGroup('In Progress', inProgressIssues, 'bg-yellow-500');
                contentHtml += renderGroup('Stalled', stalledIssues, 'bg-red-500');
                
                listEl.innerHTML = contentHtml;
            }

            // Render completed section
            if (completedIssues.length > 0) {
                completedSection.classList.remove('hidden');
                completedCount.textContent = completedIssues.length;
                completedContainer.innerHTML = completedIssues.map(issue => renderIssueCard(issue, true)).join('');
            } else {
                completedSection.classList.add('hidden');
            }
        }

        function renderIssueCard(issue, isCompleted = false) {
            const typeIcons = {
                feature: '<i class="fas fa-lightbulb text-yellow-500"></i>',
                bug: '<i class="fas fa-bug text-red-500"></i>',
                feedback: '<i class="fas fa-comment text-walmart-blue"></i>'
            };

            const statusColors = {
                new: 'bg-blue-100 text-blue-800',
                in_progress: 'bg-yellow-100 text-yellow-800',
                stalled: 'bg-red-100 text-red-800',
                completed: 'bg-green-100 text-green-800'
            };

            const statusLabels = {
                new: 'New',
                in_progress: 'In Progress',
                stalled: 'Stalled',
                completed: 'Completed'
            };

            const date = issue.created_at ? new Date(issue.created_at).toLocaleDateString() : '';

            return `
                <div class="bg-white rounded-xl shadow-sm p-4 ${isCompleted ? 'opacity-60' : ''} cursor-pointer hover:bg-gray-50 transition-colors" onclick="openEditIssueModal(${issue.id})">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-2">
                            ${typeIcons[issue.type] || ''}
                            <span class="font-medium text-gray-900 ${isCompleted ? 'line-through' : ''}">${escapeHtml(issue.title)}</span>
                        </div>
                        <div class="flex items-center gap-2" onclick="event.stopPropagation()">
                            <select onchange="updateIssueStatus(${issue.id}, this.value)" class="text-xs border rounded px-2 py-1 ${statusColors[issue.status]}">
                                <option value="new" ${issue.status === 'new' ? 'selected' : ''}>New</option>
                                <option value="in_progress" ${issue.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                <option value="stalled" ${issue.status === 'stalled' ? 'selected' : ''}>Stalled</option>
                                <option value="completed" ${issue.status === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                            <button onclick="openEditIssueModal(${issue.id})" class="text-gray-400 hover:text-walmart-blue p-1" title="Edit">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button onclick="deleteIssue(${issue.id})" class="text-gray-400 hover:text-red-500 p-1" title="Delete">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                    ${issue.description ? `<p class="text-sm text-gray-600 mb-2">${escapeHtml(issue.description)}</p>` : ''}
                    <div class="text-xs text-gray-400">${date}</div>
                </div>
            `;
        }

        function filterIssues(type) {
            currentIssueFilter = type;

            // Update filter button styles
            document.querySelectorAll('.issue-filter-btn').forEach(btn => {
                btn.classList.remove('bg-walmart-blue', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            const activeBtn = document.getElementById(`filter-${type}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                activeBtn.classList.add('bg-walmart-blue', 'text-white');
            }

            renderIssues();
        }

        function toggleCompletedIssues() {
            issuesCompletedExpanded = !issuesCompletedExpanded;
            const container = document.getElementById('issues-completed-container');
            const chevron = document.getElementById('issues-completed-chevron');

            if (issuesCompletedExpanded) {
                container.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                container.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        async function updateIssueStatus(id, status) {
            try {
                const response = await fetch(`/api/issues/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                if (!response.ok) throw new Error('Failed to update');

                // Update local state
                const issue = allIssues.find(i => i.id === id);
                if (issue) {
                    issue.status = status;
                    renderIssues();
                }
            } catch (e) {
                console.error('Error updating issue:', e);
                alert('Failed to update issue status');
                loadIssues(); // Reload to reset
            }
        }

        async function deleteIssue(id) {
            if (!confirm('Delete this issue?')) return;

            try {
                const response = await fetch(`/api/issues/${id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to delete');

                allIssues = allIssues.filter(i => i.id !== id);
                renderIssues();
            } catch (e) {
                console.error('Error deleting issue:', e);
                alert('Failed to delete issue');
            }
        }

        // --- Edit Issue Modal ---
        let selectedEditIssueType = null;

        function openEditIssueModal(id) {
            const issue = allIssues.find(i => i.id === id);
            if (!issue) return;

            document.getElementById('edit-issue-id').value = id;
            document.getElementById('edit-issue-title').value = issue.title || '';
            document.getElementById('edit-issue-description').value = issue.description || '';

            // Reset and select the current type
            selectedEditIssueType = issue.type;
            document.querySelectorAll('.edit-issue-type-btn').forEach(btn => {
                btn.classList.remove('border-walmart-blue', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            const selectedBtn = document.getElementById(`edit-type-${issue.type}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-gray-200');
                selectedBtn.classList.add('border-walmart-blue', 'bg-blue-50');
            }

            document.getElementById('edit-issue-modal').classList.remove('hidden');
        }

        function closeEditIssueModal() {
            document.getElementById('edit-issue-modal').classList.add('hidden');
        }

        function selectEditIssueType(type) {
            selectedEditIssueType = type;
            document.querySelectorAll('.edit-issue-type-btn').forEach(btn => {
                btn.classList.remove('border-walmart-blue', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            const selectedBtn = document.getElementById(`edit-type-${type}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-gray-200');
                selectedBtn.classList.add('border-walmart-blue', 'bg-blue-50');
            }
        }

        async function saveEditIssue() {
            const id = parseInt(document.getElementById('edit-issue-id').value);
            const title = document.getElementById('edit-issue-title').value.trim();
            const description = document.getElementById('edit-issue-description').value.trim();

            if (!title) {
                alert('Please enter a title');
                return;
            }

            if (!selectedEditIssueType) {
                alert('Please select a type');
                return;
            }

            try {
                const response = await fetch(`/api/issues/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        description,
                        type: selectedEditIssueType
                    })
                });

                if (!response.ok) throw new Error('Failed to update issue');

                // Update local state
                const issue = allIssues.find(i => i.id === id);
                if (issue) {
                    issue.title = title;
                    issue.description = description;
                    issue.type = selectedEditIssueType;
                }

                closeEditIssueModal();
                renderIssues();
            } catch (e) {
                console.error('Error updating issue:', e);
                alert('Failed to update issue');
            }
        }

        // Close edit issue modal on backdrop click
        document.getElementById('edit-issue-modal').addEventListener('click', function(e) {
            if (e.target === this) closeEditIssueModal();
        });

        // --- Feedback Modal ---
        function openFeedbackModal() {
            selectedFeedbackType = null;
            document.getElementById('feedback-title').value = '';
            document.getElementById('feedback-description').value = '';
            document.querySelectorAll('.feedback-type-btn').forEach(btn => {
                btn.classList.remove('border-walmart-blue', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            document.getElementById('feedback-modal').classList.remove('hidden');
        }

        function closeFeedbackModal() {
            document.getElementById('feedback-modal').classList.add('hidden');
        }

        function selectFeedbackType(type) {
            selectedFeedbackType = type;
            document.querySelectorAll('.feedback-type-btn').forEach(btn => {
                btn.classList.remove('border-walmart-blue', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            const selectedBtn = document.getElementById(`type-${type}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-gray-200');
                selectedBtn.classList.add('border-walmart-blue', 'bg-blue-50');
            }
        }

        async function submitFeedback() {
            if (!selectedFeedbackType) {
                alert('Please select a type (Feature, Bug, or Feedback)');
                return;
            }

            const title = document.getElementById('feedback-title').value.trim();
            if (!title) {
                alert('Please enter a title');
                return;
            }

            const description = document.getElementById('feedback-description').value.trim();

            try {
                const response = await fetch('/api/issues', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: selectedFeedbackType,
                        title: title,
                        description: description
                    })
                });

                if (!response.ok) throw new Error('Failed to submit');

                closeFeedbackModal();

                // If on issues page, reload the list
                if (!document.getElementById('view-issues').classList.contains('hidden-view')) {
                    await loadIssues();
                }

                // Show success message
                alert('Feedback submitted successfully!');
            } catch (e) {
                console.error('Error submitting feedback:', e);
                alert('Failed to submit feedback');
            }
        }

        // Close feedback modal on outside click
        document.getElementById('feedback-modal').addEventListener('click', function(e) {
            if (e.target === this) closeFeedbackModal();
        });

        // --- Jax Chat Functions ---
        let jaxOpen = false;

        const jaxLoadingMessages = [
            "ðŸ• Jax is fetching your results...",
            "ðŸ¦´ Sniffing through the data...",
            "ðŸ¾ Jax is on the trail...",
            "ðŸ¶ Running to get your info...",
            "ðŸŽ¾ Chasing down those numbers...",
            "ðŸ•â€ðŸ¦º Digging through the database...",
            "ðŸ¦® Jax is tracking it down...",
            "ðŸ© Pawing through the records...",
            "ðŸ• Good boy is working hard...",
            "ðŸ¦´ Almost got it... stay!",
            "ðŸ¾ Jax found something interesting...",
            "ðŸ¶ Tail wagging, data loading...",
            "ðŸŽ¾ Fetching... almost there!",
            "ðŸ• Jax says 'one moment, woof!'",
            "ðŸ¦® Retrieving your answer..."
        ];

        function getRandomLoadingMessage() {
            return jaxLoadingMessages[Math.floor(Math.random() * jaxLoadingMessages.length)];
        }

        function toggleJax() {
            jaxOpen = !jaxOpen;
            const panel = document.getElementById('jax-panel');
            const btn = document.getElementById('jax-toggle-btn');

            if (jaxOpen) {
                panel.classList.remove('hidden');
                panel.classList.add('flex');
                btn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>`;
                document.getElementById('jax-input').focus();
            } else {
                panel.classList.add('hidden');
                panel.classList.remove('flex');
                btn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>`;
            }
        }

        async function sendJaxMessage() {
            const input = document.getElementById('jax-input');
            const message = input.value.trim();
            if (!message) return;

            const messagesDiv = document.getElementById('jax-messages');

            // Add user message
            messagesDiv.innerHTML += `
                <div class="flex justify-end mb-3">
                    <div class="bg-blue-600 text-white rounded-lg px-4 py-2 max-w-xs">
                        ${escapeHtml(message)}
                    </div>
                </div>
            `;

            input.value = '';
            input.disabled = true;
            document.getElementById('jax-send-btn').disabled = true;

            // Add typing indicator with fun message
            const typingId = 'typing-' + Date.now();
            const loadingMsg = getRandomLoadingMessage();
            messagesDiv.innerHTML += `
                <div id="${typingId}" class="flex justify-start mb-3">
                    <div class="bg-gray-200 rounded-lg px-4 py-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">${loadingMsg}</span>
                            <div class="flex space-x-1">
                                <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"></div>
                                <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                // Remove typing indicator
                document.getElementById(typingId)?.remove();

                if (data.error) {
                    messagesDiv.innerHTML += `
                        <div class="flex justify-start mb-3">
                            <div class="bg-red-100 text-red-700 rounded-lg px-4 py-2 max-w-xs">
                                Error: ${escapeHtml(data.error)}
                            </div>
                        </div>
                    `;
                } else {
                    // Format the response with markdown-like formatting
                    let formattedResponse = escapeHtml(data.response || 'No response')
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded">$1</code>');

                    messagesDiv.innerHTML += `
                        <div class="flex justify-start mb-3">
                            <div class="bg-gray-200 rounded-lg px-4 py-2 max-w-sm text-sm">
                                ${formattedResponse}
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                document.getElementById(typingId)?.remove();
                messagesDiv.innerHTML += `
                    <div class="flex justify-start mb-3">
                        <div class="bg-red-100 text-red-700 rounded-lg px-4 py-2 max-w-xs">
                            Connection error. Please try again.
                        </div>
                    </div>
                `;
            }

            input.disabled = false;
            document.getElementById('jax-send-btn').disabled = false;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            input.focus();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle Enter key in Jax input
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('jax-input')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendJaxMessage();
                }
            });
        });

        // ==================== NOTES MODULE ====================
        // --- Notes State ---
        let notesCurrentNoteId = null;
        let notesCurrentFolder = '/';
        let notesCurrentDailyDate = new Date();
        let notesIsPreviewMode = false;
        let notesAllNotes = [];
        let notesAllTasks = [];
        let notesAllMarketNotes = [];
        let notesCurrentMarketFilter = 'all';
        let notesCurrentTask = null;
        let notesCurrentMarketNote = null;
        let notesCurrentTaskFilter = 'all';
        let graphNodes = [];
        let graphEdges = [];
        let graphCanvas = null;
        let graphCtx = null;
        let graphAnimationId = null;
        let isDragging = false;
        let dragNode = null;
        let hoveredNode = null;

        // --- Notes View Loading ---
        function loadNotesView() {
            loadNotesTasks();
        }

        // --- Notes Sub-View Switching ---
        function switchNotesSubView(view) {
            document.querySelectorAll('.notes-tab').forEach(tab => {
                tab.classList.remove('border-walmart-yellow');
                tab.classList.add('border-transparent');
            });
            document.querySelector(`.notes-tab[data-view="${view}"]`).classList.remove('border-transparent');
            document.querySelector(`.notes-tab[data-view="${view}"]`).classList.add('border-walmart-yellow');

            document.getElementById('notes-view-all-notes').classList.add('hidden');
            document.getElementById('notes-view-market').classList.add('hidden');
            document.getElementById('notes-view-tasks').classList.add('hidden');
            document.getElementById('notes-view-daily').classList.add('hidden');
            document.getElementById('notes-view-graph').classList.add('hidden');

            if (view === 'all') {
                document.getElementById('notes-view-all-notes').classList.remove('hidden');
                loadNotesNotes();
            } else if (view === 'market') {
                document.getElementById('notes-view-market').classList.remove('hidden');
                loadNotesMarketNotes();
            } else if (view === 'tasks') {
                document.getElementById('notes-view-tasks').classList.remove('hidden');
                loadNotesTasks();
            } else if (view === 'daily') {
                document.getElementById('notes-view-daily').classList.remove('hidden');
                loadDailyNote();
            } else if (view === 'graph') {
                document.getElementById('notes-view-graph').classList.remove('hidden');
                loadGraph();
            }
        }

        // --- Notes CRUD ---
        async function loadNotesNotes(folderPath = null) {
            try {
                const params = new URLSearchParams();
                if (folderPath) params.append('folder_path', folderPath);
                const response = await fetch(`/api/notes?${params}`);
                if (!response.ok) throw new Error('Failed to load notes');
                const data = await response.json();
                notesAllNotes = Array.isArray(data) ? data : (data.notes || []);
                renderNotesList(notesAllNotes);
            } catch (error) {
                console.error('Error loading notes:', error);
                document.getElementById('notes-list').innerHTML = '<div class="text-center text-gray-500 py-8"><p>Failed to load notes</p></div>';
            }
        }

        function renderNotesList(notes) {
            const container = document.getElementById('notes-list');
            if (!notes || notes.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-sticky-note text-4xl mb-3 text-gray-300"></i><p>No notes yet</p><p class="text-sm mt-2">Tap + to create your first note</p></div>';
                return;
            }
            container.innerHTML = notes.map(note => `
                <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="openNote('${note.id}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-gray-900 truncate">${notesEscapeHtml(note.title)}</h3>
                            <p class="text-sm text-gray-500 mt-1 line-clamp-2">${notesEscapeHtml(note.content?.substring(0, 100) || '')}</p>
                        </div>
                        ${note.is_pinned ? '<i class="fas fa-thumbtack text-walmart-yellow ml-2"></i>' : ''}
                    </div>
                    <div class="text-xs text-gray-400 mt-2">${new Date(note.updated_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        async function openNote(noteId) {
            try {
                const response = await fetch(`/api/notes/${noteId}`);
                if (!response.ok) throw new Error('Failed to load note');
                const note = await response.json();
                notesCurrentNoteId = note.id;
                document.getElementById('note-title').value = note.title || '';
                document.getElementById('note-content').value = note.content || '';
                document.getElementById('note-store-number').value = note.store_number || '';
                if (note.backlinks?.length) {
                    document.getElementById('backlinks-section').classList.remove('hidden');
                    document.getElementById('backlinks-list').innerHTML = note.backlinks.map(bl => `<div class="text-sm text-walmart-blue cursor-pointer hover:underline" onclick="openNote('${bl.id}')">${notesEscapeHtml(bl.title)}</div>`).join('');
                } else {
                    document.getElementById('backlinks-section').classList.add('hidden');
                }
                showNoteEditor();
            } catch (error) {
                console.error('Error opening note:', error);
                alert('Failed to open note');
            }
        }

        function createNote() {
            notesCurrentNoteId = null;
            document.getElementById('note-title').value = '';
            document.getElementById('note-content').value = '';
            document.getElementById('note-store-number').value = '';
            document.getElementById('backlinks-section').classList.add('hidden');
            showNoteEditor();
        }

        async function saveCurrentNote() {
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value;
            const storeNumber = document.getElementById('note-store-number').value || null;
            if (!title) { alert('Please enter a title'); return; }
            try {
                const payload = { title, content, folder_path: notesCurrentFolder, store_number: storeNumber };
                let response;
                if (notesCurrentNoteId) {
                    response = await fetch(`/api/notes/${notesCurrentNoteId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                } else {
                    response = await fetch('/api/notes', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                }
                if (!response.ok) throw new Error('Failed to save note');
                const savedNote = await response.json();
                notesCurrentNoteId = savedNote.id;
                closeNoteEditor();
                loadNotesNotes(notesCurrentFolder);
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Failed to save note');
            }
        }

        // --- Note Editor ---
        function populateStoreDropdown(selectId) {
            const select = document.getElementById(selectId);
            const stores = getMarketStores();
            select.innerHTML = '<option value="">None (General)</option>' + stores.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function showNoteEditor() {
            populateStoreDropdown('note-store-number');
            document.getElementById('note-editor-modal').classList.remove('hidden');
            document.getElementById('note-content').classList.remove('hidden');
            document.getElementById('note-preview').classList.add('hidden');
            notesIsPreviewMode = false;
            document.getElementById('preview-btn').textContent = 'Preview';
        }

        function closeNoteEditor() {
            document.getElementById('note-editor-modal').classList.add('hidden');
        }

        function toggleNotePreview() {
            notesIsPreviewMode = !notesIsPreviewMode;
            if (notesIsPreviewMode) {
                const content = document.getElementById('note-content').value;
                document.getElementById('note-preview').innerHTML = renderNotesMarkdown(content);
                document.getElementById('note-content').classList.add('hidden');
                document.getElementById('note-preview').classList.remove('hidden');
                document.getElementById('preview-btn').textContent = 'Edit';
            } else {
                document.getElementById('note-content').classList.remove('hidden');
                document.getElementById('note-preview').classList.add('hidden');
                document.getElementById('preview-btn').textContent = 'Preview';
            }
        }

        function renderNotesMarkdown(content) {
            if (!content) return '';
            let processed = content.replace(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g, (match, title, display) => {
                return `<span class="wikilink" onclick="navigateToNote('${notesEscapeHtml(title)}')">${notesEscapeHtml(display || title)}</span>`;
            });
            processed = processed.replace(/#([\w-]+)/g, '<span class="tag">#$1</span>');
            processed = processed.replace(/^(\s*)- \[ \] (.+)$/gm, '$1<input type="checkbox" class="task-checkbox mr-2"><span>$2</span>');
            processed = processed.replace(/^(\s*)- \[x\] (.+)$/gim, '$1<input type="checkbox" class="task-checkbox mr-2" checked><span class="line-through text-gray-400">$2</span>');
            return marked.parse(processed);
        }

        function navigateToNote(title) {
            const note = notesAllNotes.find(n => n.title.toLowerCase() === title.toLowerCase());
            if (note) {
                openNote(note.id);
            } else {
                if (confirm(`Note "${title}" doesn't exist. Create it?`)) {
                    notesCurrentNoteId = null;
                    document.getElementById('note-title').value = title;
                    document.getElementById('note-content').value = '';
                    showNoteEditor();
                }
            }
        }

        function navigateFolder(path) {
            notesCurrentFolder = path;
            loadNotesNotes(path);
        }

        // --- Notes Tasks ---
        async function loadNotesTasks(filter = 'all') {
            notesCurrentTaskFilter = filter;
            try {
                const params = new URLSearchParams();
                if (filter === 'today') params.append('date', 'today');
                else if (filter === 'completed') params.append('status', 'completed');
                else if (filter === 'upcoming') params.append('date', 'upcoming');
                
                // Use standalone tasks API
                const response = await fetch(`/api/tasks?${params}`);
                if (!response.ok) throw new Error('Failed to load tasks');
                const data = await response.json();
                notesAllTasks = Array.isArray(data) ? data : [];
                renderNotesTasksList(notesAllTasks);
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('notes-tasks-list').innerHTML = '<p class="text-center text-gray-500 py-8">Failed to load tasks</p>';
            }
        }

        function renderNotesTasksList(tasks) {
            const container = document.getElementById('notes-tasks-list');
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No tasks found</p>';
                return;
            }
            container.innerHTML = tasks.map(task => `
                <div class="bg-white rounded-lg shadow p-3 flex items-start space-x-3 cursor-pointer hover:shadow-md transition-shadow" onclick="openNotesTaskModal(${JSON.stringify(task).replace(/"/g, '&quot;')})">
                    <input type="checkbox" ${task.status === 'completed' ? 'checked' : ''} class="mt-1 cursor-pointer" onclick="event.stopPropagation(); toggleNotesTask(${task.id})">
                    <div class="flex-1 min-w-0">
                        <p class="${task.status === 'completed' ? 'line-through text-gray-400' : ''}">${notesEscapeHtml(task.content)}</p>
                        <div class="text-xs text-gray-400 mt-1 flex flex-wrap items-center gap-2">
                            <span class="px-2 py-0.5 rounded text-xs ${(task.status || 'new') === 'new' ? 'bg-blue-100 text-blue-700' : (task.status || 'new') === 'in_progress' ? 'bg-yellow-100 text-yellow-700' : (task.status || 'new') === 'stalled' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${(task.status || 'new') === 'in_progress' ? 'In Progress' : ((task.status || 'new').charAt(0).toUpperCase() + (task.status || 'new').slice(1))}</span>
                            ${task.priority > 0 ? `<span class="px-2 py-0.5 rounded text-xs ${task.priority === 3 ? 'bg-red-100 text-red-700' : task.priority === 2 ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-700'}">${task.priority === 3 ? 'High' : task.priority === 2 ? 'Medium' : 'Low'}</span>` : ''}
                            ${task.assigned_to ? `<span class="text-walmart-blue"><i class="fas fa-user mr-1"></i>${notesEscapeHtml(task.assigned_to)}</span>` : ''}
                            ${task.due_date ? `<span class="text-gray-600"><i class="fas fa-calendar mr-1"></i>${task.due_date}</span>` : ''}
                            ${task.store_number ? `<span class="text-purple-600"><i class="fas fa-store mr-1"></i>${task.store_number}</span>` : ''}
                            ${task.list_name && task.list_name !== 'Inbox' ? `<span class="text-gray-500"><i class="fas fa-list mr-1"></i>${notesEscapeHtml(task.list_name)}</span>` : ''}
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 mt-1"></i>
                </div>
            `).join('');
        }

        function filterNotesTasks(filter) {
            document.querySelectorAll('.notes-task-filter').forEach(btn => {
                btn.classList.remove('bg-walmart-blue', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.querySelector(`.notes-task-filter[data-filter="${filter}"]`).classList.remove('bg-gray-200', 'text-gray-700');
            document.querySelector(`.notes-task-filter[data-filter="${filter}"]`).classList.add('bg-walmart-blue', 'text-white');
            loadNotesTasks(filter);
        }

        async function toggleNotesTask(taskId) {
            try {
                // Get current task to toggle status
                const task = notesAllTasks.find(t => t.id === taskId);
                if (!task) return;
                
                const newStatus = task.status === 'completed' ? 'new' : 'completed';
                
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) throw new Error('Failed to toggle task');
                loadNotesTasks(notesCurrentTaskFilter);
            } catch (error) {
                console.error('Error toggling task:', error);
            }
        }

        // --- Notes Task Modal ---
        function openNotesTaskModal(task) {
            notesCurrentTask = task;
            // Hide note title section since these are standalone tasks
            const noteTitleSection = document.getElementById('ntm-note-title');
            if (noteTitleSection) {
                noteTitleSection.parentElement.style.display = 'none';
            }
            document.getElementById('ntm-task-text').textContent = task.content;
            document.getElementById('ntm-assigned-to').value = task.assigned_to || '';
            document.getElementById('ntm-due-date').value = task.due_date || '';
            populateStoreDropdown('ntm-store-number');
            document.getElementById('ntm-store-number').value = task.store_number || '';
            updateNotesTaskStatusButtons(task.status || 'new');
            updateNotesTaskPriorityButtons(task.priority || 0);
            document.getElementById('notes-task-modal').classList.remove('hidden');
        }

        function closeNotesTaskModal() {
            document.getElementById('notes-task-modal').classList.add('hidden');
            notesCurrentTask = null;
        }

        function updateNotesTaskStatusButtons(activeStatus) {
            document.querySelectorAll('.ntm-status-btn').forEach(btn => {
                const status = btn.dataset.status;
                btn.classList.remove('border-walmart-blue', 'bg-walmart-blue', 'text-white', 'border-gray-300');
                if (status === activeStatus) btn.classList.add('border-walmart-blue', 'bg-walmart-blue', 'text-white');
                else btn.classList.add('border-gray-300');
            });
        }

        function updateNotesTaskPriorityButtons(activePriority) {
            document.querySelectorAll('.ntm-priority-btn').forEach(btn => {
                const priority = parseInt(btn.dataset.priority);
                btn.classList.remove('border-walmart-blue', 'bg-walmart-blue', 'text-white', 'border-gray-300');
                if (priority === activePriority) btn.classList.add('border-walmart-blue', 'bg-walmart-blue', 'text-white');
                else btn.classList.add('border-gray-300');
            });
        }

        function setNotesTaskStatus(status) {
            if (notesCurrentTask) {
                notesCurrentTask.status = status;
                notesCurrentTask.is_completed = status === 'completed';
                updateNotesTaskStatusButtons(status);
            }
        }

        function setNotesTaskPriority(priority) {
            if (notesCurrentTask) {
                notesCurrentTask.priority = priority;
                updateNotesTaskPriorityButtons(priority);
            }
        }

        function openNoteFromTask() {
            if (notesCurrentTask && notesCurrentTask.note_id) {
                closeNotesTaskModal();
                openNote(notesCurrentTask.note_id);
            }
        }

        async function saveNotesTaskDetails() {
            if (!notesCurrentTask) return;
            const assignedTo = document.getElementById('ntm-assigned-to').value.trim();
            const dueDate = document.getElementById('ntm-due-date').value || null;
            const storeNumber = document.getElementById('ntm-store-number').value || null;
            try {
                const response = await fetch(`/api/tasks/${notesCurrentTask.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        status: notesCurrentTask.status, 
                        assigned_to: assignedTo || null, 
                        due_date: dueDate, 
                        priority: notesCurrentTask.priority, 
                        store_number: storeNumber 
                    })
                });
                if (!response.ok) throw new Error('Failed to save task');
                closeNotesTaskModal();
                loadNotesTasks(notesCurrentTaskFilter);
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Failed to save changes');
            }
        }

        // --- Notes Market Notes ---
        async function loadNotesMarketNotes(filter = 'all') {
            notesCurrentMarketFilter = filter;
            try {
                const response = await fetch('/api/market-notes');
                if (!response.ok) throw new Error('Failed to load market notes');
                const data = await response.json();
                notesAllMarketNotes = Array.isArray(data) ? data : [];
                let filtered = notesAllMarketNotes;
                if (filter === 'pending') filtered = notesAllMarketNotes.filter(n => !n.completed);
                else if (filter === 'completed') filtered = notesAllMarketNotes.filter(n => n.completed);
                renderNotesMarketNotesList(filtered);
            } catch (error) {
                console.error('Error loading market notes:', error);
                document.getElementById('notes-market-notes-list').innerHTML = '<p class="text-center text-gray-500 py-8">Failed to load market notes</p>';
            }
        }

        function renderNotesMarketNotesList(notes) {
            const container = document.getElementById('notes-market-notes-list');
            if (!notes || notes.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No market notes found</p>';
                return;
            }
            const byStore = {};
            notes.forEach(note => {
                if (!byStore[note.store_nbr]) byStore[note.store_nbr] = [];
                byStore[note.store_nbr].push(note);
            });
            container.innerHTML = Object.entries(byStore).map(([store, storeNotes]) => `
                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-2 flex items-center"><i class="fas fa-store text-walmart-blue mr-2"></i>Store ${store}</h3>
                    <div class="space-y-2">
                        ${storeNotes.map(note => `
                            <div class="bg-white rounded-lg shadow p-3 flex items-start space-x-3 cursor-pointer hover:shadow-md transition-shadow" onclick="openNotesMarketNoteModal(${JSON.stringify(note).replace(/"/g, '&quot;')})">
                                <input type="checkbox" ${note.completed ? 'checked' : ''} class="mt-1 cursor-pointer" onclick="event.stopPropagation(); toggleNotesMarketNote(${note.visit_id}, '${notesEscapeHtml(note.note_text).replace(/'/g, "\\'")}')">
                                <div class="flex-1 min-w-0">
                                    <p class="${note.completed ? 'line-through text-gray-400' : ''}">${notesEscapeHtml(note.note_text)}</p>
                                    <div class="text-xs text-gray-400 mt-1 flex flex-wrap items-center gap-2">
                                        <span>${note.calendar_date || ''}</span>
                                        <span class="px-2 py-0.5 rounded text-xs ${note.status === 'new' ? 'bg-blue-100 text-blue-700' : note.status === 'in_progress' ? 'bg-yellow-100 text-yellow-700' : note.status === 'stalled' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${note.status === 'in_progress' ? 'In Progress' : (note.status || 'new').charAt(0).toUpperCase() + (note.status || 'new').slice(1)}</span>
                                        ${note.assigned_to ? `<span class="text-walmart-blue"><i class="fas fa-user mr-1"></i>${notesEscapeHtml(note.assigned_to)}</span>` : ''}
                                        ${note.due_date ? `<span class="text-gray-600"><i class="fas fa-calendar mr-1"></i>${note.due_date}</span>` : ''}
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right text-gray-300 mt-1"></i>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function filterNotesMarketNotes(filter) {
            document.querySelectorAll('.notes-market-filter').forEach(btn => {
                btn.classList.remove('bg-walmart-blue', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.querySelector(`.notes-market-filter[data-filter="${filter}"]`).classList.remove('bg-gray-200', 'text-gray-700');
            document.querySelector(`.notes-market-filter[data-filter="${filter}"]`).classList.add('bg-walmart-blue', 'text-white');
            loadNotesMarketNotes(filter);
        }

        async function toggleNotesMarketNote(visitId, noteText) {
            try {
                const response = await fetch(`/api/market-notes/${visitId}/toggle`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ note_text: noteText }) });
                if (!response.ok) throw new Error('Failed to toggle market note');
                loadNotesMarketNotes(notesCurrentMarketFilter);
            } catch (error) {
                console.error('Error toggling market note:', error);
            }
        }

        // --- Notes Market Note Modal ---
        function openNotesMarketNoteModal(note) {
            notesCurrentMarketNote = note;
            document.getElementById('nmnm-store').textContent = `Store ${note.store_nbr}`;
            document.getElementById('nmnm-date').textContent = note.calendar_date || '';
            document.getElementById('nmnm-note-text').textContent = note.note_text;
            document.getElementById('nmnm-assigned-to').value = note.assigned_to || '';
            document.getElementById('nmnm-due-date').value = note.due_date || '';
            updateNotesMarketNoteStatusButtons(note.status || 'new');
            document.getElementById('notes-market-note-modal').classList.remove('hidden');
        }

        function closeNotesMarketNoteModal() {
            document.getElementById('notes-market-note-modal').classList.add('hidden');
            notesCurrentMarketNote = null;
        }

        function updateNotesMarketNoteStatusButtons(activeStatus) {
            document.querySelectorAll('.nmnm-status-btn').forEach(btn => {
                const status = btn.dataset.status;
                btn.classList.remove('border-walmart-blue', 'bg-walmart-blue', 'text-white', 'border-gray-300');
                if (status === activeStatus) btn.classList.add('border-walmart-blue', 'bg-walmart-blue', 'text-white');
                else btn.classList.add('border-gray-300');
            });
        }

        function setNotesMarketNoteStatus(status) {
            if (notesCurrentMarketNote) {
                notesCurrentMarketNote.status = status;
                updateNotesMarketNoteStatusButtons(status);
            }
        }

        async function saveNotesMarketNoteDetails() {
            if (!notesCurrentMarketNote) return;
            const assignedTo = document.getElementById('nmnm-assigned-to').value.trim();
            const dueDate = document.getElementById('nmnm-due-date').value || null;
            try {
                const response = await fetch('/api/market-notes/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ visit_id: notesCurrentMarketNote.visit_id, note_text: notesCurrentMarketNote.note_text, status: notesCurrentMarketNote.status, assigned_to: assignedTo || null, due_date: dueDate, completed: notesCurrentMarketNote.status === 'completed' })
                });
                if (!response.ok) throw new Error('Failed to save market note');
                closeNotesMarketNoteModal();
                loadNotesMarketNotes(notesCurrentMarketFilter);
            } catch (error) {
                console.error('Error saving market note:', error);
                alert('Failed to save changes');
            }
        }

        // --- Daily Notes ---
        async function loadDailyNote() {
            const dateStr = notesCurrentDailyDate.toISOString().split('T')[0];
            document.getElementById('daily-date').textContent = notesCurrentDailyDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            try {
                const response = await fetch(`/api/notes/daily/${dateStr}`);
                if (!response.ok) throw new Error('Failed to load daily note');
                const data = await response.json();
                if (data.note) {
                    document.getElementById('daily-note-content').innerHTML = `<div class="cursor-pointer" onclick="openNote('${data.note.id}')">${renderNotesMarkdown(data.note.content)}</div>`;
                } else {
                    document.getElementById('daily-note-content').innerHTML = `<p class="text-center text-gray-500 py-8 cursor-pointer" onclick="createDailyNote()">Tap to create today's note</p>`;
                }
            } catch (error) {
                console.error('Error loading daily note:', error);
            }
        }

        async function createDailyNote() {
            const dateStr = notesCurrentDailyDate.toISOString().split('T')[0];
            try {
                const response = await fetch(`/api/notes/daily/${dateStr}`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to create daily note');
                const data = await response.json();
                openNote(data.note.id);
            } catch (error) {
                console.error('Error creating daily note:', error);
            }
        }

        function previousDay() {
            notesCurrentDailyDate.setDate(notesCurrentDailyDate.getDate() - 1);
            loadDailyNote();
        }

        function nextDay() {
            notesCurrentDailyDate.setDate(notesCurrentDailyDate.getDate() + 1);
            loadDailyNote();
        }

        // --- Notes Search ---
        function showNotesSearch() {
            document.getElementById('notes-search-modal').classList.remove('hidden');
            document.getElementById('notes-search-input').focus();
        }

        function hideNotesSearch() {
            document.getElementById('notes-search-modal').classList.add('hidden');
        }

        document.getElementById('notes-search-input')?.addEventListener('input', notesDebounce(async (e) => {
            const query = e.target.value.trim();
            if (query.length < 2) {
                document.getElementById('notes-search-results').innerHTML = '<p class="text-center text-gray-500">Type to search...</p>';
                return;
            }
            try {
                const response = await fetch(`/api/notes/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('Search failed');
                const data = await response.json();
                const results = Array.isArray(data) ? data : (data.notes || []);
                if (results.length === 0) {
                    document.getElementById('notes-search-results').innerHTML = '<p class="text-center text-gray-500">No results found</p>';
                } else {
                    document.getElementById('notes-search-results').innerHTML = results.map(note => `
                        <div class="bg-white rounded-lg shadow p-3 mb-2 cursor-pointer" onclick="hideNotesSearch(); openNote('${note.id}')">
                            <h4 class="font-medium">${notesEscapeHtml(note.title)}</h4>
                            <p class="text-sm text-gray-500 truncate">${notesEscapeHtml(note.content?.substring(0, 80) || '')}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }, 300));

        // --- AI Insights ---
        async function loadAIInsights() {
            const loadingEl = document.getElementById('insights-loading');
            const contentEl = document.getElementById('insights-content');
            const refreshBtn = document.getElementById('refresh-insights-btn');

            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');
            refreshBtn.disabled = true;

            try {
                const response = await fetch('/api/notes/ai-insights');
                if (!response.ok) throw new Error('Failed to load insights');
                const data = await response.json();

                if (data.error) {
                    contentEl.innerHTML = `<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-circle text-2xl mb-2"></i><p>${notesEscapeHtml(data.error)}</p></div>`;
                } else {
                    renderAIInsights(data);
                }
            } catch (error) {
                console.error('Error loading AI insights:', error);
                contentEl.innerHTML = `<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-circle text-2xl mb-2"></i><p>Failed to load insights</p></div>`;
            } finally {
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                refreshBtn.disabled = false;
            }
        }

        function renderAIInsights(data) {
            const contentEl = document.getElementById('insights-content');
            let html = '';

            // Summary
            if (data.summary) {
                html += `
                    <div class="bg-walmart-blue text-white rounded-lg p-4">
                        <h3 class="font-semibold mb-2"><i class="fas fa-lightbulb mr-2"></i>Summary</h3>
                        <p class="text-sm">${notesEscapeHtml(data.summary)}</p>
                    </div>
                `;
            }

            // Themes
            if (data.themes && data.themes.length > 0) {
                html += `
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-3"><i class="fas fa-tags text-walmart-blue mr-2"></i>Key Themes</h3>
                        <div class="space-y-2">
                            ${data.themes.map(t => `
                                <div class="flex items-start space-x-3 p-2 rounded ${t.priority === 'high' ? 'bg-red-50' : t.priority === 'medium' ? 'bg-yellow-50' : 'bg-gray-50'}">
                                    <span class="px-2 py-0.5 rounded text-xs font-medium ${t.priority === 'high' ? 'bg-red-100 text-red-700' : t.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}">${t.priority || 'low'}</span>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-800">${notesEscapeHtml(t.name)}</p>
                                        <p class="text-sm text-gray-600">${notesEscapeHtml(t.description)}</p>
                                        ${t.count ? `<span class="text-xs text-gray-400">${t.count} related items</span>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Store Patterns
            if (data.store_patterns && data.store_patterns.length > 0) {
                html += `
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-3"><i class="fas fa-store text-purple-600 mr-2"></i>Store Patterns</h3>
                        <div class="space-y-2">
                            ${data.store_patterns.map(s => `
                                <div class="flex items-start space-x-3 p-2 rounded bg-purple-50">
                                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-700">Store ${s.store}</span>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-800">${notesEscapeHtml(s.pattern)}</p>
                                        <span class="text-xs text-gray-400">${s.frequency || ''}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Time Trends
            if (data.time_trends && data.time_trends.length > 0) {
                html += `
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-3"><i class="fas fa-chart-line text-green-600 mr-2"></i>Time Trends</h3>
                        <div class="space-y-2">
                            ${data.time_trends.map(t => `
                                <div class="flex items-start space-x-3 p-2 rounded bg-green-50">
                                    <i class="fas fa-arrow-${t.direction === 'increasing' ? 'up text-red-500' : t.direction === 'decreasing' ? 'down text-green-500' : 'right text-gray-500'} mt-1"></i>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-800">${notesEscapeHtml(t.trend)}</p>
                                        <span class="text-xs text-gray-400">${t.timeframe || ''}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Recommendations
            if (data.recommendations && data.recommendations.length > 0) {
                html += `
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-3"><i class="fas fa-check-circle text-walmart-blue mr-2"></i>Recommendations</h3>
                        <div class="space-y-2">
                            ${data.recommendations.map(r => `
                                <div class="flex items-start space-x-3 p-2 rounded ${r.priority === 'high' ? 'bg-blue-50 border-l-4 border-walmart-blue' : 'bg-gray-50'}">
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-800">${notesEscapeHtml(r.action)}</p>
                                        <p class="text-sm text-gray-600">${notesEscapeHtml(r.reason)}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (!html) {
                html = `<div class="text-center py-8 text-gray-500"><i class="fas fa-info-circle text-2xl mb-2"></i><p>No insights available yet. Add more notes and try again.</p></div>`;
            }

            contentEl.innerHTML = html;
        }

        // Keep loadGraph as alias for backwards compatibility
        function loadGraph() {
            // No-op - graph replaced with AI insights
        }

        // --- Notes Utilities ---
        function notesEscapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function notesDebounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- Init ---
        updateHeaderMarketBadge();
        loadDashboard();
    </script>

    <!-- Jax Chat Button and Panel -->
    <div id="jax-toggle-btn" onclick="toggleJax()" class="fixed bottom-20 right-4 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center cursor-pointer z-50 transition-all">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
    </div>

    <div id="jax-panel" class="hidden fixed bottom-36 right-4 w-80 sm:w-96 h-[450px] bg-white rounded-lg shadow-2xl flex-col z-50 border border-gray-200">
        <!-- Jax Header -->
        <div class="bg-blue-600 text-white px-4 py-3 rounded-t-lg flex items-center justify-between">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <span class="font-semibold">Jax</span>
            </div>
            <button onclick="toggleJax()" class="text-white hover:text-gray-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Jax Messages -->
        <div id="jax-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50">
            <div class="flex justify-start mb-3">
                <div class="bg-gray-200 rounded-lg px-4 py-2 max-w-sm text-sm">
                    Hey! I'm Jax. I can help you analyze store visits. Try asking:
                    <ul class="mt-2 ml-4 list-disc text-xs text-gray-600">
                        <li>"Give me a summary"</li>
                        <li>"Show visits for store 1234"</li>
                        <li>"What's the trend for store 5678?"</li>
                        <li>"Compare stores 1234 and 5678"</li>
                        <li>"Find stores with overstock issues"</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Jax Input -->
        <div class="p-3 border-t border-gray-200 bg-white rounded-b-lg">
            <div class="flex space-x-2">
                <input type="text" id="jax-input" placeholder="Ask Jax anything..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="jax-send-btn" onclick="sendJaxMessage()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Send
                </button>
            </div>
        </div>
        // --- Smart Add & Note Photos ---
        function openSmartAddModal(context) {
            document.getElementById('smart-add-content').value = '';
            document.getElementById('smart-add-tasks-list').innerHTML = '';
            document.getElementById('smart-add-preview').classList.add('hidden');
            populateStoreDropdown('smart-add-store');
            document.getElementById('smart-add-modal').classList.remove('hidden');
            document.getElementById('smart-add-content').focus();
        }

        function closeSmartAddModal() {
            document.getElementById('smart-add-modal').classList.add('hidden');
        }

        async function processSmartAdd() {
            const content = document.getElementById('smart-add-content').value.trim();
            const store = document.getElementById('smart-add-store').value;
            const btn = document.getElementById('btn-process-ai');

            if (!content) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

            try {
                // Use new smart add tasks endpoint
                const response = await fetch('/api/tasks/smart-add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        content: content, 
                        store_number: store,
                        list_name: 'Inbox'
                    })
                });

                if (!response.ok) throw new Error('AI processing failed');
                const result = await response.json();

                closeSmartAddModal();
                loadNotesTasks('all'); 
                switchTab('notes');
                switchNotesSubView('tasks'); 

                // Show success message
                if (result.count > 0) {
                    alert(`âœ… Created ${result.count} task${result.count > 1 ? 's' : ''} successfully!`);
                } else {
                    alert('No tasks were extracted from the input.');
                }

            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-1"></i> Process & Save';
            }
        }

        async function handleNotePhotoUpload(input) {
            if (!input.files || !input.files[0]) return;
            // currentNoteId must be defined in the broader scope or accessible
            if (typeof currentNoteId === 'undefined' || !currentNoteId) {
                alert('Please save the note first before adding photos.');
                input.value = '';
                return;
            }

            const file = input.files[0];
            const formData = new FormData();
            formData.append('photo', file);

            try {
                const response = await fetch(`/api/notes/${currentNoteId}/photos`, {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) throw new Error('Upload failed');
                
                const photo = await response.json();
                const photoMarkdown = `\n![Photo](${photo.gcs_url})\n`;
                
                const textArea = document.getElementById('note-content');
                textArea.value += photoMarkdown;
                
                // Auto-save to persist the markdown change
                await saveCurrentNote(); 
                
            } catch (e) {
                console.error(e);
                alert('Failed to upload photo');
            }
            input.value = '';
        }
    </script>
</body>
</html>
