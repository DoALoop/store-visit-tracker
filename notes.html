<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notes - Store Visit Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'walmart-blue': '#0071ce',
                        'walmart-dark-blue': '#004c91',
                        'walmart-yellow': '#ffc220'
                    }
                }
            }
        }
    </script>
    <style>
        @supports(padding: max(0px)) {
            .pb-safe { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
            .pt-safe { padding-top: max(0.5rem, env(safe-area-inset-top)); }
        }
        .note-content { min-height: 200px; }
        .markdown-preview a { color: #0071ce; text-decoration: underline; }
        .markdown-preview h1 { font-size: 1.5rem; font-weight: bold; margin-top: 1rem; }
        .markdown-preview h2 { font-size: 1.25rem; font-weight: bold; margin-top: 0.75rem; }
        .markdown-preview h3 { font-size: 1.1rem; font-weight: bold; margin-top: 0.5rem; }
        .markdown-preview ul, .markdown-preview ol { margin-left: 1.5rem; margin-top: 0.5rem; }
        .markdown-preview ul { list-style-type: disc; }
        .markdown-preview ol { list-style-type: decimal; }
        .markdown-preview code { background: #f3f4f6; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-family: monospace; }
        .markdown-preview pre { background: #f3f4f6; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; }
        .markdown-preview blockquote { border-left: 4px solid #0071ce; padding-left: 1rem; margin: 0.5rem 0; color: #6b7280; }
        .wikilink { color: #0071ce; cursor: pointer; text-decoration: underline; }
        .wikilink.unresolved { color: #9ca3af; }
        .tag { color: #0071ce; cursor: pointer; }
        .task-checkbox { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-walmart-blue text-white sticky top-0 z-50 pt-safe">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center space-x-3">
                <a href="index.html" class="text-white hover:text-walmart-yellow">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                <h1 class="text-lg font-semibold">Notes</h1>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="showSearch()" class="p-2 rounded-full hover:bg-walmart-dark-blue">
                    <i class="fas fa-search"></i>
                </button>
                <button onclick="createNote()" class="p-2 rounded-full hover:bg-walmart-dark-blue">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <!-- Sub-navigation tabs -->
        <div class="flex border-t border-walmart-dark-blue">
            <button onclick="switchNotesView('all')" class="notes-tab flex-1 py-2 text-sm font-medium text-center border-b-2 border-walmart-yellow" data-view="all">
                Notes
            </button>
            <button onclick="switchNotesView('market')" class="notes-tab flex-1 py-2 text-sm font-medium text-center border-b-2 border-transparent hover:border-walmart-yellow/50" data-view="market">
                Market
            </button>
            <button onclick="switchNotesView('tasks')" class="notes-tab flex-1 py-2 text-sm font-medium text-center border-b-2 border-transparent hover:border-walmart-yellow/50" data-view="tasks">
                Tasks
            </button>
            <button onclick="switchNotesView('daily')" class="notes-tab flex-1 py-2 text-sm font-medium text-center border-b-2 border-transparent hover:border-walmart-yellow/50" data-view="daily">
                Daily
            </button>
            <button onclick="switchNotesView('graph')" class="notes-tab flex-1 py-2 text-sm font-medium text-center border-b-2 border-transparent hover:border-walmart-yellow/50" data-view="graph">
                Graph
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pb-20">
        <!-- All Notes View -->
        <div id="view-all-notes" class="p-4">
            <!-- Folder breadcrumb -->
            <div id="folder-breadcrumb" class="mb-4 text-sm text-gray-600">
                <span class="cursor-pointer hover:text-walmart-blue" onclick="navigateFolder('/')">/</span>
            </div>

            <!-- Notes list -->
            <div id="notes-list" class="space-y-3">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-sticky-note text-4xl mb-3 text-gray-300"></i>
                    <p>No notes yet</p>
                    <p class="text-sm mt-2">Tap + to create your first note</p>
                    <p class="text-xs mt-4 text-gray-400">Database migration required - see console for details</p>
                </div>
            </div>
        </div>

        <!-- Market Notes View -->
        <div id="view-market" class="p-4 hidden">
            <div class="mb-4 flex space-x-2 overflow-x-auto">
                <button onclick="filterMarketNotes('all')" class="market-filter px-3 py-1 rounded-full text-sm bg-walmart-blue text-white whitespace-nowrap" data-filter="all">All</button>
                <button onclick="filterMarketNotes('pending')" class="market-filter px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 whitespace-nowrap" data-filter="pending">Pending</button>
                <button onclick="filterMarketNotes('completed')" class="market-filter px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 whitespace-nowrap" data-filter="completed">Completed</button>
            </div>
            <div id="market-notes-list" class="space-y-2">
                <p class="text-center text-gray-500 py-8">Loading market notes...</p>
            </div>
        </div>

        <!-- Tasks View -->
        <div id="view-tasks" class="p-4 hidden">
            <div class="mb-4 flex space-x-2">
                <button onclick="filterTasks('all')" class="task-filter px-3 py-1 rounded-full text-sm bg-walmart-blue text-white" data-filter="all">All</button>
                <button onclick="filterTasks('today')" class="task-filter px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter="today">Today</button>
                <button onclick="filterTasks('upcoming')" class="task-filter px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter="upcoming">Upcoming</button>
                <button onclick="filterTasks('completed')" class="task-filter px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter="completed">Completed</button>
            </div>
            <div id="tasks-list" class="space-y-2">
                <p class="text-center text-gray-500 py-8">No tasks found</p>
            </div>
        </div>

        <!-- Daily Notes View -->
        <div id="view-daily" class="p-4 hidden">
            <div class="flex items-center justify-between mb-4">
                <button onclick="previousDay()" class="p-2 text-walmart-blue">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="daily-date" class="font-medium"></span>
                <button onclick="nextDay()" class="p-2 text-walmart-blue">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div id="daily-note-content" class="bg-white rounded-lg shadow p-4">
                <p class="text-center text-gray-500 py-8">Tap to create today's note</p>
            </div>
        </div>

        <!-- Graph View -->
        <div id="view-graph" class="hidden" style="height: calc(100vh - 180px);">
            <canvas id="graph-canvas" class="w-full h-full"></canvas>
            <div id="graph-tooltip" class="fixed bg-gray-800 text-white text-sm px-3 py-2 rounded shadow-lg pointer-events-none hidden"></div>
        </div>
    </main>

    <!-- Note Editor Modal -->
    <div id="note-editor-modal" class="fixed inset-0 bg-white z-50 hidden">
        <div class="flex flex-col h-full">
            <!-- Editor Header -->
            <header class="bg-walmart-blue text-white px-4 py-3 flex items-center justify-between pt-safe">
                <button onclick="closeEditor()" class="p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <div class="flex space-x-2">
                    <button onclick="togglePreview()" id="preview-btn" class="px-3 py-1 rounded text-sm border border-white/50">
                        Preview
                    </button>
                    <button onclick="saveCurrentNote()" class="px-3 py-1 rounded text-sm bg-walmart-yellow text-walmart-dark-blue font-medium">
                        Save
                    </button>
                </div>
            </header>

            <!-- Title Input -->
            <input type="text" id="note-title" placeholder="Note title"
                class="px-4 py-3 text-xl font-semibold border-b focus:outline-none focus:border-walmart-blue">

            <!-- Editor/Preview Area -->
            <div class="flex-1 overflow-hidden">
                <textarea id="note-content" placeholder="Start writing...

Use [[Note Title]] for wikilinks
Use #tag for tags
Use - [ ] for tasks"
                    class="w-full h-full p-4 resize-none focus:outline-none note-content"></textarea>
                <div id="note-preview" class="w-full h-full p-4 overflow-auto hidden markdown-preview"></div>
            </div>

            <!-- Backlinks Section -->
            <div id="backlinks-section" class="border-t p-4 hidden">
                <h3 class="text-sm font-medium text-gray-500 mb-2">Linked mentions</h3>
                <div id="backlinks-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="fixed inset-0 bg-white z-50 hidden">
        <header class="bg-walmart-blue text-white px-4 py-3 flex items-center space-x-3 pt-safe">
            <button onclick="hideSearch()" class="p-2">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            <input type="text" id="search-input" placeholder="Search notes..."
                class="flex-1 bg-walmart-dark-blue text-white placeholder-white/70 rounded-lg px-4 py-2 focus:outline-none">
        </header>
        <div id="search-results" class="p-4">
            <p class="text-center text-gray-500">Type to search...</p>
        </div>
    </div>

    <!-- Market Note Detail Modal -->
    <div id="market-note-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <header class="bg-walmart-blue text-white px-4 py-3 flex items-center justify-between rounded-t-lg">
                <h2 class="font-semibold">Market Note Details</h2>
                <button onclick="closeMarketNoteModal()" class="p-1">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </header>
            <div class="p-4 space-y-4">
                <!-- Store & Date Info -->
                <div class="text-sm text-gray-500">
                    <span id="mnm-store" class="font-medium"></span>
                    <span id="mnm-date" class="ml-2"></span>
                </div>

                <!-- Note Text -->
                <div class="bg-gray-50 rounded-lg p-3">
                    <p id="mnm-note-text" class="text-gray-800"></p>
                </div>

                <!-- Status -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setMarketNoteStatus('new')" class="mnm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="new">
                            New
                        </button>
                        <button onclick="setMarketNoteStatus('in_progress')" class="mnm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="in_progress">
                            In Progress
                        </button>
                        <button onclick="setMarketNoteStatus('stalled')" class="mnm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="stalled">
                            Stalled
                        </button>
                        <button onclick="setMarketNoteStatus('completed')" class="mnm-status-btn px-3 py-2 rounded-lg text-sm border-2" data-status="completed">
                            Completed
                        </button>
                    </div>
                </div>

                <!-- Assigned To -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Assigned To</label>
                    <input type="text" id="mnm-assigned-to" placeholder="Enter name..."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-walmart-blue">
                </div>

                <!-- Due Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                    <input type="date" id="mnm-due-date"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-walmart-blue">
                </div>

                <!-- Save Button -->
                <button onclick="saveMarketNoteDetails()" class="w-full bg-walmart-blue text-white py-3 rounded-lg font-medium hover:bg-walmart-dark-blue">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 pb-safe z-40">
        <div class="grid grid-cols-5 h-16">
            <a href="index.html" class="w-full h-full flex flex-col items-center justify-center space-y-1 text-gray-500 hover:text-walmart-blue focus:outline-none">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs font-medium">Home</span>
            </a>
            <a href="index.html#log-visit" class="w-full h-full flex flex-col items-center justify-center space-y-1 text-gray-500 hover:text-walmart-blue focus:outline-none">
                <i class="fas fa-camera text-xl"></i>
                <span class="text-xs font-medium">Log Visit</span>
            </a>
            <a href="index.html#visits" class="w-full h-full flex flex-col items-center justify-center space-y-1 text-gray-500 hover:text-walmart-blue focus:outline-none">
                <i class="fas fa-clipboard-list text-xl"></i>
                <span class="text-xs font-medium">Tracker</span>
            </a>
            <a href="index.html#market-notes" class="w-full h-full flex flex-col items-center justify-center space-y-1 text-gray-500 hover:text-walmart-blue focus:outline-none">
                <i class="fas fa-tasks text-xl"></i>
                <span class="text-xs font-medium">Tasks</span>
            </a>
            <a href="notes.html" class="w-full h-full flex flex-col items-center justify-center space-y-1 text-walmart-blue focus:outline-none">
                <i class="fas fa-sticky-note text-xl"></i>
                <span class="text-xs font-medium">Notes</span>
            </a>
        </div>
    </nav>

    <script>
        // --- State ---
        let currentNoteId = null;
        let currentFolder = '/';
        let currentDailyDate = new Date();
        let isPreviewMode = false;
        let allNotes = [];
        let allTasks = [];

        // --- API Base URL ---
        const API_BASE = '';

        // --- View Switching ---
        function switchNotesView(view) {
            document.querySelectorAll('.notes-tab').forEach(tab => {
                tab.classList.remove('border-walmart-yellow');
                tab.classList.add('border-transparent');
            });
            document.querySelector(`.notes-tab[data-view="${view}"]`).classList.remove('border-transparent');
            document.querySelector(`.notes-tab[data-view="${view}"]`).classList.add('border-walmart-yellow');

            document.getElementById('view-all-notes').classList.add('hidden');
            document.getElementById('view-market').classList.add('hidden');
            document.getElementById('view-tasks').classList.add('hidden');
            document.getElementById('view-daily').classList.add('hidden');
            document.getElementById('view-graph').classList.add('hidden');

            if (view === 'all') {
                document.getElementById('view-all-notes').classList.remove('hidden');
                loadNotes();
            } else if (view === 'market') {
                document.getElementById('view-market').classList.remove('hidden');
                loadMarketNotes();
            } else if (view === 'tasks') {
                document.getElementById('view-tasks').classList.remove('hidden');
                loadTasks();
            } else if (view === 'daily') {
                document.getElementById('view-daily').classList.remove('hidden');
                loadDailyNote();
            } else if (view === 'graph') {
                document.getElementById('view-graph').classList.remove('hidden');
                loadGraph();
            }
        }

        // --- Notes CRUD ---
        async function loadNotes(folderPath = null) {
            try {
                const params = new URLSearchParams();
                if (folderPath) params.append('folder_path', folderPath);

                const response = await fetch(`${API_BASE}/api/notes?${params}`);
                if (!response.ok) throw new Error('Failed to load notes');

                const data = await response.json();
                allNotes = Array.isArray(data) ? data : (data.notes || []);
                renderNotesList(allNotes);
            } catch (error) {
                console.error('Error loading notes:', error);
                document.getElementById('notes-list').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-exclamation-circle text-4xl mb-3 text-red-300"></i>
                        <p>Failed to load notes</p>
                        <p class="text-sm mt-2">Make sure the database migration has been run</p>
                    </div>
                `;
            }
        }

        function renderNotesList(notes) {
            const container = document.getElementById('notes-list');

            if (!notes || notes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-sticky-note text-4xl mb-3 text-gray-300"></i>
                        <p>No notes yet</p>
                        <p class="text-sm mt-2">Tap + to create your first note</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notes.map(note => `
                <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-md transition-shadow"
                     onclick="openNote('${note.id}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-gray-900 truncate">${escapeHtml(note.title)}</h3>
                            <p class="text-sm text-gray-500 mt-1 line-clamp-2">${escapeHtml(note.content?.substring(0, 100) || '')}</p>
                            ${note.tags?.length ? `
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${note.tags.map(tag => `<span class="text-xs text-walmart-blue">#${escapeHtml(tag)}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        ${note.is_pinned ? '<i class="fas fa-thumbtack text-walmart-yellow ml-2"></i>' : ''}
                    </div>
                    <div class="text-xs text-gray-400 mt-2">
                        ${new Date(note.updated_at).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        async function openNote(noteId) {
            try {
                const response = await fetch(`${API_BASE}/api/notes/${noteId}`);
                if (!response.ok) throw new Error('Failed to load note');

                const note = await response.json();
                currentNoteId = note.id;

                document.getElementById('note-title').value = note.title || '';
                document.getElementById('note-content').value = note.content || '';

                // Load backlinks
                if (note.backlinks?.length) {
                    document.getElementById('backlinks-section').classList.remove('hidden');
                    document.getElementById('backlinks-list').innerHTML = note.backlinks.map(bl => `
                        <div class="text-sm text-walmart-blue cursor-pointer hover:underline"
                             onclick="openNote('${bl.id}')">${escapeHtml(bl.title)}</div>
                    `).join('');
                } else {
                    document.getElementById('backlinks-section').classList.add('hidden');
                }

                showEditor();
            } catch (error) {
                console.error('Error opening note:', error);
                alert('Failed to open note');
            }
        }

        function createNote() {
            currentNoteId = null;
            document.getElementById('note-title').value = '';
            document.getElementById('note-content').value = '';
            document.getElementById('backlinks-section').classList.add('hidden');
            showEditor();
        }

        async function saveCurrentNote() {
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value;

            if (!title) {
                alert('Please enter a title');
                return;
            }

            try {
                const payload = {
                    title,
                    content,
                    folder_path: currentFolder
                };

                let response;
                if (currentNoteId) {
                    response = await fetch(`${API_BASE}/api/notes/${currentNoteId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    response = await fetch(`${API_BASE}/api/notes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                if (!response.ok) throw new Error('Failed to save note');

                const savedNote = await response.json();
                currentNoteId = savedNote.id;

                closeEditor();
                loadNotes(currentFolder);
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Failed to save note');
            }
        }

        // --- Editor ---
        function showEditor() {
            document.getElementById('note-editor-modal').classList.remove('hidden');
            document.getElementById('note-content').classList.remove('hidden');
            document.getElementById('note-preview').classList.add('hidden');
            isPreviewMode = false;
            document.getElementById('preview-btn').textContent = 'Preview';
        }

        function closeEditor() {
            document.getElementById('note-editor-modal').classList.add('hidden');
        }

        function togglePreview() {
            isPreviewMode = !isPreviewMode;
            if (isPreviewMode) {
                const content = document.getElementById('note-content').value;
                document.getElementById('note-preview').innerHTML = renderMarkdown(content);
                document.getElementById('note-content').classList.add('hidden');
                document.getElementById('note-preview').classList.remove('hidden');
                document.getElementById('preview-btn').textContent = 'Edit';
            } else {
                document.getElementById('note-content').classList.remove('hidden');
                document.getElementById('note-preview').classList.add('hidden');
                document.getElementById('preview-btn').textContent = 'Preview';
            }
        }

        // --- Markdown Rendering ---
        function renderMarkdown(content) {
            if (!content) return '';

            // Process wikilinks: [[Title]] or [[Title|Display]]
            let processed = content.replace(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g, (match, title, display) => {
                return `<span class="wikilink" onclick="navigateToNote('${escapeHtml(title)}')">${escapeHtml(display || title)}</span>`;
            });

            // Process tags: #tagname
            processed = processed.replace(/#([\w-]+)/g, '<span class="tag" onclick="filterByTag(\'$1\')">#$1</span>');

            // Process tasks: - [ ] or - [x]
            processed = processed.replace(/^(\s*)- \[ \] (.+)$/gm, '$1<input type="checkbox" class="task-checkbox mr-2" onclick="toggleTaskInContent(this)"><span>$2</span>');
            processed = processed.replace(/^(\s*)- \[x\] (.+)$/gim, '$1<input type="checkbox" class="task-checkbox mr-2" checked onclick="toggleTaskInContent(this)"><span class="line-through text-gray-400">$2</span>');

            // Use marked for the rest
            return marked.parse(processed);
        }

        function navigateToNote(title) {
            // Search for note by title and open it
            const note = allNotes.find(n => n.title.toLowerCase() === title.toLowerCase());
            if (note) {
                openNote(note.id);
            } else {
                // Create new note with this title
                if (confirm(`Note "${title}" doesn't exist. Create it?`)) {
                    currentNoteId = null;
                    document.getElementById('note-title').value = title;
                    document.getElementById('note-content').value = '';
                    showEditor();
                }
            }
        }

        // --- Tasks ---
        async function loadTasks(filter = 'all') {
            try {
                const params = new URLSearchParams();
                if (filter === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    params.append('due_date', today);
                } else if (filter === 'completed') {
                    params.append('is_completed', 'true');
                } else if (filter === 'upcoming') {
                    params.append('upcoming', 'true');
                }

                const response = await fetch(`${API_BASE}/api/notes/tasks?${params}`);
                if (!response.ok) throw new Error('Failed to load tasks');

                const data = await response.json();
                allTasks = Array.isArray(data) ? data : (data.tasks || []);
                renderTasksList(allTasks);
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('tasks-list').innerHTML = '<p class="text-center text-gray-500 py-8">Failed to load tasks</p>';
            }
        }

        function renderTasksList(tasks) {
            const container = document.getElementById('tasks-list');

            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No tasks found</p>';
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="bg-white rounded-lg shadow p-3 flex items-start space-x-3">
                    <input type="checkbox" ${task.is_completed ? 'checked' : ''}
                           class="mt-1 cursor-pointer" onclick="toggleTask('${task.id}')">
                    <div class="flex-1 min-w-0">
                        <p class="${task.is_completed ? 'line-through text-gray-400' : ''}">${escapeHtml(task.content)}</p>
                        <div class="text-xs text-gray-400 mt-1">
                            ${task.due_date ? `Due: ${task.due_date}` : ''}
                            <span class="text-walmart-blue cursor-pointer hover:underline"
                                  onclick="openNote('${task.note_id}')">Open note</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterTasks(filter) {
            document.querySelectorAll('.task-filter').forEach(btn => {
                btn.classList.remove('bg-walmart-blue', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.querySelector(`.task-filter[data-filter="${filter}"]`).classList.remove('bg-gray-200', 'text-gray-700');
            document.querySelector(`.task-filter[data-filter="${filter}"]`).classList.add('bg-walmart-blue', 'text-white');
            loadTasks(filter);
        }

        async function toggleTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/notes/tasks/${taskId}/toggle`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to toggle task');
                loadTasks();
            } catch (error) {
                console.error('Error toggling task:', error);
            }
        }

        // --- Market Notes ---
        let allMarketNotes = [];
        let currentMarketFilter = 'all';

        async function loadMarketNotes(filter = 'all') {
            currentMarketFilter = filter;
            try {
                const response = await fetch(`${API_BASE}/api/market-notes`);
                if (!response.ok) throw new Error('Failed to load market notes');

                const data = await response.json();
                allMarketNotes = Array.isArray(data) ? data : [];

                // Apply filter
                let filtered = allMarketNotes;
                if (filter === 'pending') {
                    filtered = allMarketNotes.filter(n => !n.completed);
                } else if (filter === 'completed') {
                    filtered = allMarketNotes.filter(n => n.completed);
                }

                renderMarketNotesList(filtered);
            } catch (error) {
                console.error('Error loading market notes:', error);
                document.getElementById('market-notes-list').innerHTML = '<p class="text-center text-gray-500 py-8">Failed to load market notes</p>';
            }
        }

        function renderMarketNotesList(notes) {
            const container = document.getElementById('market-notes-list');

            if (!notes || notes.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No market notes found</p>';
                return;
            }

            // Group by store
            const byStore = {};
            notes.forEach(note => {
                if (!byStore[note.store_nbr]) {
                    byStore[note.store_nbr] = [];
                }
                byStore[note.store_nbr].push(note);
            });

            container.innerHTML = Object.entries(byStore).map(([store, storeNotes]) => `
                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-store text-walmart-blue mr-2"></i>
                        Store ${store}
                    </h3>
                    <div class="space-y-2">
                        ${storeNotes.map(note => `
                            <div class="bg-white rounded-lg shadow p-3 flex items-start space-x-3 cursor-pointer hover:shadow-md transition-shadow"
                                 onclick="openMarketNoteModal(${JSON.stringify(note).replace(/"/g, '&quot;')})">
                                <input type="checkbox" ${note.completed ? 'checked' : ''}
                                       class="mt-1 cursor-pointer" onclick="event.stopPropagation(); toggleMarketNote(${note.visit_id}, '${escapeHtml(note.note_text).replace(/'/g, "\\'")}')">
                                <div class="flex-1 min-w-0">
                                    <p class="${note.completed ? 'line-through text-gray-400' : ''}">${escapeHtml(note.note_text)}</p>
                                    <div class="text-xs text-gray-400 mt-1 flex flex-wrap items-center gap-2">
                                        <span>${note.calendar_date || ''}</span>
                                        <span class="px-2 py-0.5 rounded text-xs ${
                                            note.status === 'new' ? 'bg-blue-100 text-blue-700' :
                                            note.status === 'in_progress' ? 'bg-yellow-100 text-yellow-700' :
                                            note.status === 'stalled' ? 'bg-red-100 text-red-700' :
                                            'bg-green-100 text-green-700'
                                        }">${note.status === 'in_progress' ? 'In Progress' : note.status.charAt(0).toUpperCase() + note.status.slice(1)}</span>
                                        ${note.assigned_to ? `<span class="text-walmart-blue"><i class="fas fa-user mr-1"></i>${escapeHtml(note.assigned_to)}</span>` : ''}
                                        ${note.due_date ? `<span class="text-gray-600"><i class="fas fa-calendar mr-1"></i>${note.due_date}</span>` : ''}
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right text-gray-300 mt-1"></i>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function filterMarketNotes(filter) {
            document.querySelectorAll('.market-filter').forEach(btn => {
                btn.classList.remove('bg-walmart-blue', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.querySelector(`.market-filter[data-filter="${filter}"]`).classList.remove('bg-gray-200', 'text-gray-700');
            document.querySelector(`.market-filter[data-filter="${filter}"]`).classList.add('bg-walmart-blue', 'text-white');
            loadMarketNotes(filter);
        }

        async function toggleMarketNote(visitId, noteText) {
            try {
                const response = await fetch(`${API_BASE}/api/market-notes/${visitId}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ note_text: noteText })
                });
                if (!response.ok) throw new Error('Failed to toggle market note');
                loadMarketNotes(currentMarketFilter);
            } catch (error) {
                console.error('Error toggling market note:', error);
            }
        }

        // Market Note Modal
        let currentMarketNote = null;

        function openMarketNoteModal(note) {
            currentMarketNote = note;

            // Populate modal
            document.getElementById('mnm-store').textContent = `Store ${note.store_nbr}`;
            document.getElementById('mnm-date').textContent = note.calendar_date || '';
            document.getElementById('mnm-note-text').textContent = note.note_text;
            document.getElementById('mnm-assigned-to').value = note.assigned_to || '';
            document.getElementById('mnm-due-date').value = note.due_date || '';

            // Update status buttons
            updateStatusButtons(note.status || 'new');

            // Show modal
            document.getElementById('market-note-modal').classList.remove('hidden');
        }

        function closeMarketNoteModal() {
            document.getElementById('market-note-modal').classList.add('hidden');
            currentMarketNote = null;
        }

        function updateStatusButtons(activeStatus) {
            document.querySelectorAll('.mnm-status-btn').forEach(btn => {
                const status = btn.dataset.status;
                btn.classList.remove('border-walmart-blue', 'bg-walmart-blue', 'text-white', 'border-gray-300');
                if (status === activeStatus) {
                    btn.classList.add('border-walmart-blue', 'bg-walmart-blue', 'text-white');
                } else {
                    btn.classList.add('border-gray-300');
                }
            });
        }

        function setMarketNoteStatus(status) {
            if (currentMarketNote) {
                currentMarketNote.status = status;
                updateStatusButtons(status);
            }
        }

        async function saveMarketNoteDetails() {
            if (!currentMarketNote) return;

            const assignedTo = document.getElementById('mnm-assigned-to').value.trim();
            const dueDate = document.getElementById('mnm-due-date').value || null;

            try {
                const response = await fetch(`${API_BASE}/api/market-notes/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        visit_id: currentMarketNote.visit_id,
                        note_text: currentMarketNote.note_text,
                        status: currentMarketNote.status,
                        assigned_to: assignedTo || null,
                        due_date: dueDate,
                        completed: currentMarketNote.status === 'completed'
                    })
                });

                if (!response.ok) throw new Error('Failed to save market note');

                closeMarketNoteModal();
                loadMarketNotes(currentMarketFilter);
            } catch (error) {
                console.error('Error saving market note:', error);
                alert('Failed to save changes');
            }
        }

        // --- Daily Notes ---
        async function loadDailyNote() {
            const dateStr = currentDailyDate.toISOString().split('T')[0];
            document.getElementById('daily-date').textContent = currentDailyDate.toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            try {
                const response = await fetch(`${API_BASE}/api/notes/daily/${dateStr}`);
                if (!response.ok) throw new Error('Failed to load daily note');

                const data = await response.json();
                if (data.note) {
                    document.getElementById('daily-note-content').innerHTML = `
                        <div class="cursor-pointer" onclick="openNote('${data.note.id}')">
                            ${renderMarkdown(data.note.content)}
                        </div>
                    `;
                } else {
                    document.getElementById('daily-note-content').innerHTML = `
                        <p class="text-center text-gray-500 py-8 cursor-pointer" onclick="createDailyNote()">
                            Tap to create today's note
                        </p>
                    `;
                }
            } catch (error) {
                console.error('Error loading daily note:', error);
            }
        }

        async function createDailyNote() {
            const dateStr = currentDailyDate.toISOString().split('T')[0];
            try {
                const response = await fetch(`${API_BASE}/api/notes/daily/${dateStr}`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to create daily note');

                const data = await response.json();
                openNote(data.note.id);
            } catch (error) {
                console.error('Error creating daily note:', error);
            }
        }

        function previousDay() {
            currentDailyDate.setDate(currentDailyDate.getDate() - 1);
            loadDailyNote();
        }

        function nextDay() {
            currentDailyDate.setDate(currentDailyDate.getDate() + 1);
            loadDailyNote();
        }

        // --- Search ---
        function showSearch() {
            document.getElementById('search-modal').classList.remove('hidden');
            document.getElementById('search-input').focus();
        }

        function hideSearch() {
            document.getElementById('search-modal').classList.add('hidden');
        }

        document.getElementById('search-input')?.addEventListener('input', debounce(async (e) => {
            const query = e.target.value.trim();
            if (query.length < 2) {
                document.getElementById('search-results').innerHTML = '<p class="text-center text-gray-500">Type to search...</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/notes/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('Search failed');

                const data = await response.json();
                const results = Array.isArray(data) ? data : (data.notes || []);

                if (results.length === 0) {
                    document.getElementById('search-results').innerHTML = '<p class="text-center text-gray-500">No results found</p>';
                } else {
                    document.getElementById('search-results').innerHTML = results.map(note => `
                        <div class="bg-white rounded-lg shadow p-3 mb-2 cursor-pointer" onclick="hideSearch(); openNote('${note.id}')">
                            <h4 class="font-medium">${escapeHtml(note.title)}</h4>
                            <p class="text-sm text-gray-500 truncate">${escapeHtml(note.content?.substring(0, 80) || '')}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }, 300));

        // --- Utilities ---
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function navigateFolder(path) {
            currentFolder = path;
            loadNotes(path);
        }

        function filterByTag(tag) {
            // TODO: Implement tag filtering
            console.log('Filter by tag:', tag);
        }

        function toggleTaskInContent(checkbox) {
            // TODO: Implement in-content task toggling
            console.log('Toggle task in content');
        }

        // --- Graph Visualization ---
        let graphNodes = [];
        let graphEdges = [];
        let graphCanvas = null;
        let graphCtx = null;
        let graphAnimationId = null;
        let isDragging = false;
        let dragNode = null;
        let hoveredNode = null;

        async function loadGraph() {
            try {
                const response = await fetch(`${API_BASE}/api/notes/graph`);
                if (!response.ok) throw new Error('Failed to load graph');

                const data = await response.json();
                graphNodes = data.nodes || [];
                graphEdges = data.edges || [];

                if (graphNodes.length === 0) {
                    const container = document.getElementById('view-graph');
                    container.innerHTML = `
                        <div class="flex items-center justify-center h-full text-gray-500">
                            <div class="text-center">
                                <i class="fas fa-project-diagram text-4xl mb-3 text-gray-300"></i>
                                <p>No notes to visualize</p>
                                <p class="text-sm mt-2">Create some notes with [[wikilinks]] to see connections</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                initGraph();
            } catch (error) {
                console.error('Error loading graph:', error);
            }
        }

        function initGraph() {
            graphCanvas = document.getElementById('graph-canvas');
            graphCtx = graphCanvas.getContext('2d');

            // Set canvas size
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Initialize node positions randomly
            const centerX = graphCanvas.width / 2;
            const centerY = graphCanvas.height / 2;
            const radius = Math.min(graphCanvas.width, graphCanvas.height) * 0.35;

            graphNodes.forEach((node, i) => {
                const angle = (2 * Math.PI * i) / graphNodes.length;
                node.x = centerX + radius * Math.cos(angle) + (Math.random() - 0.5) * 50;
                node.y = centerY + radius * Math.sin(angle) + (Math.random() - 0.5) * 50;
                node.vx = 0;
                node.vy = 0;
                node.radius = 20 + Math.min(node.link_count + node.backlink_count, 10) * 3;
            });

            // Add event listeners
            graphCanvas.addEventListener('mousedown', onGraphMouseDown);
            graphCanvas.addEventListener('mousemove', onGraphMouseMove);
            graphCanvas.addEventListener('mouseup', onGraphMouseUp);
            graphCanvas.addEventListener('click', onGraphClick);
            graphCanvas.addEventListener('touchstart', onGraphTouchStart, { passive: false });
            graphCanvas.addEventListener('touchmove', onGraphTouchMove, { passive: false });
            graphCanvas.addEventListener('touchend', onGraphTouchEnd);

            // Start animation
            animateGraph();
        }

        function resizeCanvas() {
            if (!graphCanvas) return;
            const container = document.getElementById('view-graph');
            graphCanvas.width = container.clientWidth;
            graphCanvas.height = container.clientHeight;
        }

        function animateGraph() {
            if (!graphCtx) return;

            // Apply forces
            applyForces();

            // Clear canvas
            graphCtx.fillStyle = '#f3f4f6';
            graphCtx.fillRect(0, 0, graphCanvas.width, graphCanvas.height);

            // Draw edges
            graphCtx.strokeStyle = '#cbd5e1';
            graphCtx.lineWidth = 2;
            graphEdges.forEach(edge => {
                const source = graphNodes.find(n => n.id === edge.source);
                const target = graphNodes.find(n => n.id === edge.target);
                if (source && target) {
                    graphCtx.beginPath();
                    graphCtx.moveTo(source.x, source.y);
                    graphCtx.lineTo(target.x, target.y);
                    graphCtx.stroke();

                    // Draw arrow
                    const angle = Math.atan2(target.y - source.y, target.x - source.x);
                    const arrowX = target.x - target.radius * Math.cos(angle);
                    const arrowY = target.y - target.radius * Math.sin(angle);
                    drawArrow(arrowX, arrowY, angle);
                }
            });

            // Draw nodes
            graphNodes.forEach(node => {
                const isHovered = hoveredNode === node;
                const isDailyNote = node.title.match(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)/);

                // Node circle
                graphCtx.beginPath();
                graphCtx.arc(node.x, node.y, node.radius, 0, 2 * Math.PI);
                graphCtx.fillStyle = isHovered ? '#ffc220' : (isDailyNote ? '#10b981' : '#0071ce');
                graphCtx.fill();
                graphCtx.strokeStyle = '#fff';
                graphCtx.lineWidth = 2;
                graphCtx.stroke();

                // Node label
                graphCtx.fillStyle = '#1f2937';
                graphCtx.font = '12px sans-serif';
                graphCtx.textAlign = 'center';
                graphCtx.textBaseline = 'top';
                const label = node.title.length > 15 ? node.title.substring(0, 15) + '...' : node.title;
                graphCtx.fillText(label, node.x, node.y + node.radius + 5);
            });

            graphAnimationId = requestAnimationFrame(animateGraph);
        }

        function drawArrow(x, y, angle) {
            const size = 8;
            graphCtx.fillStyle = '#cbd5e1';
            graphCtx.beginPath();
            graphCtx.moveTo(x, y);
            graphCtx.lineTo(x - size * Math.cos(angle - Math.PI / 6), y - size * Math.sin(angle - Math.PI / 6));
            graphCtx.lineTo(x - size * Math.cos(angle + Math.PI / 6), y - size * Math.sin(angle + Math.PI / 6));
            graphCtx.closePath();
            graphCtx.fill();
        }

        function applyForces() {
            const centerX = graphCanvas.width / 2;
            const centerY = graphCanvas.height / 2;

            graphNodes.forEach(node => {
                // Center gravity
                node.vx += (centerX - node.x) * 0.0005;
                node.vy += (centerY - node.y) * 0.0005;

                // Repulsion from other nodes
                graphNodes.forEach(other => {
                    if (node === other) return;
                    const dx = node.x - other.x;
                    const dy = node.y - other.y;
                    const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                    const force = 2000 / (dist * dist);
                    node.vx += (dx / dist) * force;
                    node.vy += (dy / dist) * force;
                });
            });

            // Edge attraction
            graphEdges.forEach(edge => {
                const source = graphNodes.find(n => n.id === edge.source);
                const target = graphNodes.find(n => n.id === edge.target);
                if (source && target) {
                    const dx = target.x - source.x;
                    const dy = target.y - source.y;
                    const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                    const force = (dist - 150) * 0.01;
                    source.vx += (dx / dist) * force;
                    source.vy += (dy / dist) * force;
                    target.vx -= (dx / dist) * force;
                    target.vy -= (dy / dist) * force;
                }
            });

            // Apply velocity and damping
            graphNodes.forEach(node => {
                if (node === dragNode) return;
                node.vx *= 0.9;
                node.vy *= 0.9;
                node.x += node.vx;
                node.y += node.vy;

                // Keep in bounds
                const margin = node.radius + 10;
                node.x = Math.max(margin, Math.min(graphCanvas.width - margin, node.x));
                node.y = Math.max(margin, Math.min(graphCanvas.height - margin, node.y));
            });
        }

        function getNodeAtPosition(x, y) {
            for (let i = graphNodes.length - 1; i >= 0; i--) {
                const node = graphNodes[i];
                const dx = x - node.x;
                const dy = y - node.y;
                if (dx * dx + dy * dy < node.radius * node.radius) {
                    return node;
                }
            }
            return null;
        }

        function onGraphMouseDown(e) {
            const rect = graphCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            dragNode = getNodeAtPosition(x, y);
            if (dragNode) {
                isDragging = true;
                graphCanvas.style.cursor = 'grabbing';
            }
        }

        function onGraphMouseMove(e) {
            const rect = graphCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (isDragging && dragNode) {
                dragNode.x = x;
                dragNode.y = y;
                dragNode.vx = 0;
                dragNode.vy = 0;
            } else {
                const node = getNodeAtPosition(x, y);
                hoveredNode = node;
                graphCanvas.style.cursor = node ? 'pointer' : 'default';

                // Update tooltip
                const tooltip = document.getElementById('graph-tooltip');
                if (node) {
                    tooltip.textContent = `${node.title} (${node.link_count} links, ${node.backlink_count} backlinks)`;
                    tooltip.style.left = (e.clientX + 10) + 'px';
                    tooltip.style.top = (e.clientY + 10) + 'px';
                    tooltip.classList.remove('hidden');
                } else {
                    tooltip.classList.add('hidden');
                }
            }
        }

        function onGraphMouseUp() {
            isDragging = false;
            dragNode = null;
            graphCanvas.style.cursor = 'default';
        }

        function onGraphClick(e) {
            if (isDragging) return;
            const rect = graphCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const node = getNodeAtPosition(x, y);
            if (node) {
                openNote(node.id);
            }
        }

        function onGraphTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = graphCanvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            dragNode = getNodeAtPosition(x, y);
            if (dragNode) isDragging = true;
        }

        function onGraphTouchMove(e) {
            e.preventDefault();
            if (!isDragging || !dragNode) return;
            const touch = e.touches[0];
            const rect = graphCanvas.getBoundingClientRect();
            dragNode.x = touch.clientX - rect.left;
            dragNode.y = touch.clientY - rect.top;
            dragNode.vx = 0;
            dragNode.vy = 0;
        }

        function onGraphTouchEnd(e) {
            if (!isDragging && dragNode) {
                openNote(dragNode.id);
            }
            isDragging = false;
            dragNode = null;
        }

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            loadNotes();
        });
    </script>
</body>
</html>
